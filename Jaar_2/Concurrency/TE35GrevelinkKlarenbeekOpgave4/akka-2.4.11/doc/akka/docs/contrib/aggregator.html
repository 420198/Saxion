


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Aggregator Pattern &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.4.11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <script type="text/javascript" src="../_static/warnOldDocs.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="External Contributions" href="index.html" />
    <link rel="next" title="Receive Pipeline Pattern" href="receive-pipeline.html" />
    <link rel="prev" title="Mailbox with Explicit Acknowledgement" href="peek-mailbox.html" />


  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img class="svg-logo" src="../_static/akka_full_color.svg" /></a>
        </div>
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
          <li><a href="http://akka.io/downloads">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>
          <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Aggregator Pattern</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">
              <li>
                 <span class="divider">|</span> <a href="receive-pipeline.html">Receive Pipeline Pattern</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../java.html">Java Contents</a> <span class="divider">|</span> <a href="../scala.html">Scala Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="peek-mailbox.html">Mailbox with Explicit Acknowledgement</a> <span class="divider">|</span>
              </li>
              <li style="float: left">
                Version 2.4.11
              </li>
              <li style="float: left">
                <input type="search" id="search" class="form-control" />
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="aggregator-pattern">
<span id="aggregator"></span><h1>Aggregator Pattern</h1>
<p>The aggregator pattern supports writing actors that aggregate data from multiple
other actors and updates its state based on those responses. It is even harder to
optionally aggregate more data based on the runtime state of the actor or take
certain actions (sending another message and get another response) based on two or
more previous responses.</p>
<p>A common thought is to use the ask pattern to request information from other
actors. However, ask creates another actor specifically for the ask. We cannot
use a callback from the future to update the state as the thread executing the
callback is not defined. This will likely close-over the current actor.</p>
<p>The aggregator pattern solves such scenarios. It makes sure we're
acting from the same actor in the scope of the actor receive.</p>
<div class="section" id="introduction">
<h2>Introduction</h2>
<p>The aggregator pattern allows match patterns to be dynamically added to and removed
from an actor from inside the message handling logic. All match patterns are called
from the receive loop and run in the thread handling the incoming message. These
dynamically added patterns and logic can safely read and/or modify this actor's
mutable state without risking integrity or concurrency issues.</p>
</div>
<div class="section" id="usage">
<h2>Usage</h2>
<p>To use the aggregator pattern, you need to extend the <tt class="xref py py-class docutils literal"><span class="pre">Aggregator</span></tt> trait.
The trait takes care of <tt class="xref py py-class docutils literal"><span class="pre">receive</span></tt> and actors extending this trait should
not override <tt class="xref py py-class docutils literal"><span class="pre">receive</span></tt>. The trait provides the <tt class="xref py py-class docutils literal"><span class="pre">expect</span></tt>,
<tt class="xref py py-class docutils literal"><span class="pre">expectOnce</span></tt>, and <tt class="xref py py-class docutils literal"><span class="pre">unexpect</span></tt> calls. The <tt class="xref py py-class docutils literal"><span class="pre">expect</span></tt> and
<tt class="xref py py-class docutils literal"><span class="pre">expectOnce</span></tt> calls return a handle that can be used for later de-registration
by passing the handle to <tt class="xref py py-class docutils literal"><span class="pre">unexpect</span></tt>.</p>
<p><tt class="xref py py-class docutils literal"><span class="pre">expect</span></tt> is often used for standing matches such as catching error messages or timeouts.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">expect</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">TimedOut</span> <span class="k">⇒</span> <span class="n">collectBalances</span><span class="o">(</span><span class="n">force</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p><tt class="xref py py-class docutils literal"><span class="pre">expectOnce</span></tt> is used for matching the initial message as well as other requested messages</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">expectOnce</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">GetCustomerAccountBalances</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">types</span><span class="o">)</span> <span class="k">⇒</span>
    <span class="k">new</span> <span class="nc">AccountAggregator</span><span class="o">(</span><span class="n">sender</span><span class="o">(),</span> <span class="n">id</span><span class="o">,</span> <span class="n">types</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">⇒</span>
    <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">CantUnderstand</span>
    <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">fetchCheckingAccountsBalance</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">CheckingAccountProxy</span><span class="o">])</span> <span class="o">!</span> <span class="nc">GetAccountBalances</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
  <span class="n">expectOnce</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">CheckingAccountBalances</span><span class="o">(</span><span class="n">balances</span><span class="o">)</span> <span class="k">⇒</span>
      <span class="n">results</span> <span class="o">+=</span> <span class="o">(</span><span class="nc">Checking</span> <span class="o">→</span> <span class="n">balances</span><span class="o">)</span>
      <span class="n">collectBalances</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><tt class="xref py py-class docutils literal"><span class="pre">unexpect</span></tt> can be used for expecting multiple responses until a timeout or when the logic
dictates such an <tt class="xref py py-class docutils literal"><span class="pre">expect</span></tt> no longer applies.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">handle</span> <span class="k">=</span> <span class="n">expect</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Response</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="k">⇒</span>
    <span class="n">values</span> <span class="o">+=</span> <span class="n">value</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span> <span class="n">processList</span><span class="o">()</span>
  <span class="k">case</span> <span class="nc">TimedOut</span> <span class="k">⇒</span> <span class="n">processList</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">processList</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">unexpect</span><span class="o">(</span><span class="n">handle</span><span class="o">)</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="n">actorSelection</span><span class="o">(</span><span class="s">&quot;/user/evaluator&quot;</span><span class="o">)</span> <span class="o">!</span> <span class="n">values</span><span class="o">.</span><span class="n">toList</span>
    <span class="n">expectOnce</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">EvaluationResults</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">eval</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">processFinal</span><span class="o">(</span><span class="n">eval</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">else</span> <span class="n">processFinal</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span>
<span class="o">}</span>
</pre></div>
</div>
<p>As the name eludes, <tt class="xref py py-class docutils literal"><span class="pre">expect</span></tt> keeps the partial function matching any
received messages until <tt class="xref py py-class docutils literal"><span class="pre">unexpect</span></tt> is called or the actor terminates,
whichever comes first. On the other hand, <tt class="xref py py-class docutils literal"><span class="pre">expectOnce</span></tt> removes the partial
function once a match has been established.</p>
<p>It is a common pattern to register the initial expectOnce from the construction
of the actor to accept the initial message. Once that message is received, the
actor starts doing all aggregations and sends the response back to the original
requester. The aggregator should terminate after the response is sent (or timed
out). A different original request should use a different actor instance.</p>
<p>As you can see, aggregator actors are generally stateful, short lived actors.</p>
</div>
<div class="section" id="sample-use-case-accountbalanceretriever">
<h2>Sample Use Case - AccountBalanceRetriever</h2>
<p>This example below shows a typical and intended use of the aggregator pattern.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">InitialRequest</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Request</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Response</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">EvaluationResults</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">eval</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">FinalResponse</span><span class="o">(</span><span class="n">qualifiedValues</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="cm">/**</span>
<span class="cm"> * An actor sample demonstrating use of unexpect and chaining.</span>
<span class="cm"> * This is just an example and not a complete test case.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">ChainingSample</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="k">with</span> <span class="nc">Aggregator</span> <span class="o">{</span>

  <span class="n">expectOnce</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">InitialRequest</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">⇒</span> <span class="k">new</span> <span class="nc">MultipleResponseHandler</span><span class="o">(</span><span class="n">sender</span><span class="o">(),</span> <span class="n">name</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">class</span> <span class="nc">MultipleResponseHandler</span><span class="o">(</span><span class="n">originalSender</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">propName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">import</span> <span class="nn">context.dispatcher</span>
    <span class="k">import</span> <span class="nn">collection.mutable.ArrayBuffer</span>

    <span class="k">val</span> <span class="n">values</span> <span class="k">=</span> <span class="nc">ArrayBuffer</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>

    <span class="n">context</span><span class="o">.</span><span class="n">actorSelection</span><span class="o">(</span><span class="s">&quot;/user/request_proxies&quot;</span><span class="o">)</span> <span class="o">!</span> <span class="nc">Request</span><span class="o">(</span><span class="n">propName</span><span class="o">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">scheduleOnce</span><span class="o">(</span><span class="mf">50.</span><span class="n">milliseconds</span><span class="o">,</span> <span class="n">self</span><span class="o">,</span> <span class="nc">TimedOut</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">handle</span> <span class="k">=</span> <span class="n">expect</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Response</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="k">⇒</span>
        <span class="n">values</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span> <span class="n">processList</span><span class="o">()</span>
      <span class="k">case</span> <span class="nc">TimedOut</span> <span class="k">⇒</span> <span class="n">processList</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">processList</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">unexpect</span><span class="o">(</span><span class="n">handle</span><span class="o">)</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">actorSelection</span><span class="o">(</span><span class="s">&quot;/user/evaluator&quot;</span><span class="o">)</span> <span class="o">!</span> <span class="n">values</span><span class="o">.</span><span class="n">toList</span>
        <span class="n">expectOnce</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">EvaluationResults</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">eval</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">processFinal</span><span class="o">(</span><span class="n">eval</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">else</span> <span class="n">processFinal</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">processFinal</span><span class="o">(</span><span class="n">eval</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="o">{</span>
      <span class="c1">// Select only the entries coming back from eval</span>
      <span class="n">originalSender</span> <span class="o">!</span> <span class="nc">FinalResponse</span><span class="o">(</span><span class="n">eval</span> <span class="n">map</span> <span class="n">values</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">AggregatorSpec</span> <span class="k">extends</span> <span class="nc">TestKit</span><span class="o">(</span><span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;AggregatorSpec&quot;</span><span class="o">))</span> <span class="k">with</span> <span class="nc">ImplicitSender</span> <span class="k">with</span> <span class="nc">FunSuiteLike</span> <span class="k">with</span> <span class="nc">Matchers</span> <span class="k">with</span> <span class="nc">BeforeAndAfterAll</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">afterAll</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">shutdown</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Test request 1 account type&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">AccountBalanceRetriever</span><span class="o">])</span> <span class="o">!</span> <span class="nc">GetCustomerAccountBalances</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">Savings</span><span class="o">))</span>
    <span class="n">receiveOne</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">result</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">⇒</span>
        <span class="n">result</span> <span class="n">should</span> <span class="n">have</span> <span class="n">size</span> <span class="mi">1</span>
      <span class="k">case</span> <span class="n">result</span> <span class="k">⇒</span>
        <span class="n">assert</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">s</span><span class="s">&quot;Expect List, got ${result.getClass}&quot;</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Test request 3 account types&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">AccountBalanceRetriever</span><span class="o">])</span> <span class="o">!</span>
      <span class="nc">GetCustomerAccountBalances</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">Checking</span><span class="o">,</span> <span class="nc">Savings</span><span class="o">,</span> <span class="nc">MoneyMarket</span><span class="o">))</span>
    <span class="n">receiveOne</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">result</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">⇒</span>
        <span class="n">result</span> <span class="n">should</span> <span class="n">have</span> <span class="n">size</span> <span class="mi">3</span>
      <span class="k">case</span> <span class="n">result</span> <span class="k">⇒</span>
        <span class="n">assert</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">s</span><span class="s">&quot;Expect List, got ${result.getClass}&quot;</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">WorkListSpec</span> <span class="k">extends</span> <span class="nc">FunSuiteLike</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">workList</span> <span class="k">=</span> <span class="nc">WorkList</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">TestEntry</span><span class="o">]</span>
  <span class="k">var</span> <span class="n">entry2</span><span class="k">:</span> <span class="kt">TestEntry</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="k">var</span> <span class="n">entry4</span><span class="k">:</span> <span class="kt">TestEntry</span> <span class="o">=</span> <span class="kc">null</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Processing empty WorkList&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ProcessAndRemove something in the middle</span>
    <span class="k">val</span> <span class="n">processed</span> <span class="k">=</span> <span class="n">workList</span> <span class="n">process</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">9</span><span class="o">)</span> <span class="k">⇒</span> <span class="kc">true</span>
      <span class="k">case</span> <span class="k">_</span>            <span class="k">⇒</span> <span class="kc">false</span>
    <span class="o">}</span>
    <span class="n">assert</span><span class="o">(!</span><span class="n">processed</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Insert temp entries&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">head</span> <span class="o">===</span> <span class="n">workList</span><span class="o">.</span><span class="n">tail</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">entry0</span> <span class="k">=</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="n">workList</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">entry0</span><span class="o">,</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span>

    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">tail</span> <span class="o">===</span> <span class="n">workList</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span><span class="o">)</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span> <span class="o">===</span> <span class="n">entry0</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">entry1</span> <span class="k">=</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="n">workList</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">entry1</span><span class="o">,</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span>

    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span> <span class="o">!=</span> <span class="n">workList</span><span class="o">.</span><span class="n">tail</span><span class="o">)</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span> <span class="o">===</span> <span class="n">entry0</span><span class="o">)</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span> <span class="o">===</span> <span class="n">entry1</span><span class="o">)</span>

    <span class="n">entry2</span> <span class="k">=</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
    <span class="n">workList</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">entry2</span><span class="o">,</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span>

    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span> <span class="o">===</span> <span class="n">entry2</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">entry3</span> <span class="k">=</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
    <span class="n">workList</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">entry3</span><span class="o">,</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span>

    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span> <span class="o">===</span> <span class="n">entry3</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Process temp entries&quot;</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// ProcessAndRemove something in the middle</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span> <span class="n">process</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="k">⇒</span> <span class="kc">true</span>
      <span class="k">case</span> <span class="k">_</span>            <span class="k">⇒</span> <span class="kc">false</span>
    <span class="o">})</span>

    <span class="c1">// ProcessAndRemove the head</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span> <span class="n">process</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="k">⇒</span> <span class="kc">true</span>
      <span class="k">case</span> <span class="k">_</span>            <span class="k">⇒</span> <span class="kc">false</span>
    <span class="o">})</span>

    <span class="c1">// ProcessAndRemove the tail</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span> <span class="n">process</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="k">⇒</span> <span class="kc">true</span>
      <span class="k">case</span> <span class="k">_</span>            <span class="k">⇒</span> <span class="kc">false</span>
    <span class="o">})</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Re-insert permanent entry&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">entry4</span> <span class="k">=</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
    <span class="n">workList</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">entry4</span><span class="o">,</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>

    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span> <span class="o">===</span> <span class="n">entry4</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Process permanent entry&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span> <span class="n">process</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="k">⇒</span> <span class="kc">true</span>
      <span class="k">case</span> <span class="k">_</span>            <span class="k">⇒</span> <span class="kc">false</span>
    <span class="o">})</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Remove permanent entry&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">removed</span> <span class="k">=</span> <span class="n">workList</span> <span class="n">remove</span> <span class="n">entry4</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">removed</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Remove temp entry already processed&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">removed</span> <span class="k">=</span> <span class="n">workList</span> <span class="n">remove</span> <span class="n">entry2</span>
    <span class="n">assert</span><span class="o">(!</span><span class="n">removed</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Process non-matching entries&quot;</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">processed</span> <span class="k">=</span>
      <span class="n">workList</span> <span class="n">process</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="k">⇒</span> <span class="kc">true</span>
        <span class="k">case</span> <span class="k">_</span>            <span class="k">⇒</span> <span class="kc">false</span>
      <span class="o">}</span>

    <span class="n">assert</span><span class="o">(!</span><span class="n">processed</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">processed2</span> <span class="k">=</span>
      <span class="n">workList</span> <span class="n">process</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">TestEntry</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="k">⇒</span> <span class="kc">true</span>
        <span class="k">case</span> <span class="k">_</span>            <span class="k">⇒</span> <span class="kc">false</span>
      <span class="o">}</span>

    <span class="n">assert</span><span class="o">(!</span><span class="n">processed2</span><span class="o">)</span>

  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Append two lists&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">workList</span><span class="o">.</span><span class="n">removeAll</span><span class="o">()</span>
    <span class="mi">0</span> <span class="n">to</span> <span class="mi">4</span> <span class="n">foreach</span> <span class="o">{</span> <span class="n">id</span> <span class="k">⇒</span> <span class="n">workList</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">TestEntry</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span> <span class="o">}</span>

    <span class="k">val</span> <span class="n">l2</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WorkList</span><span class="o">[</span><span class="kt">TestEntry</span><span class="o">]</span>
    <span class="mi">5</span> <span class="n">to</span> <span class="mi">9</span> <span class="n">foreach</span> <span class="o">{</span> <span class="n">id</span> <span class="k">⇒</span> <span class="n">l2</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">TestEntry</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span> <span class="o">}</span>

    <span class="n">workList</span> <span class="n">addAll</span> <span class="n">l2</span>

    <span class="nd">@tailrec</span>
    <span class="k">def</span> <span class="n">checkEntries</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">entry</span><span class="k">:</span> <span class="kt">WorkList.Entry</span><span class="o">[</span><span class="kt">TestEntry</span><span class="o">])</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">id</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">assert</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">id</span> <span class="o">===</span> <span class="n">id</span><span class="o">)</span>
        <span class="n">checkEntries</span><span class="o">(</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">next</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">assert</span><span class="o">(</span><span class="n">checkEntries</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">workList</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span><span class="o">)</span> <span class="o">===</span> <span class="mi">10</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Clear list&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">workList</span><span class="o">.</span><span class="n">removeAll</span><span class="o">()</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span> <span class="o">===</span> <span class="kc">null</span><span class="o">)</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList</span><span class="o">.</span><span class="n">tail</span> <span class="o">===</span> <span class="n">workList</span><span class="o">.</span><span class="n">head</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">workList2</span> <span class="k">=</span> <span class="nc">WorkList</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Unit</span><span class="o">]]</span>

  <span class="k">val</span> <span class="n">fn1</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="k">⇒</span>
      <span class="kt">val</span> <span class="kt">result1</span> <span class="o">=</span> <span class="n">workList2</span> <span class="n">remove</span> <span class="n">fn1</span>
      <span class="n">assert</span><span class="o">(</span><span class="n">result1</span> <span class="o">===</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;First remove must return true&quot;</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">result2</span> <span class="k">=</span> <span class="n">workList2</span> <span class="n">remove</span> <span class="n">fn1</span>
      <span class="n">assert</span><span class="o">(</span><span class="n">result2</span> <span class="o">===</span> <span class="kc">false</span><span class="o">,</span> <span class="s">&quot;Second remove must return false&quot;</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">fn2</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="k">⇒</span>
      <span class="kt">workList2.add</span><span class="o">(</span><span class="kt">fn1</span><span class="o">,</span> <span class="kt">permanent</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Reentrant insert&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">workList2</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">fn2</span><span class="o">,</span> <span class="n">permanent</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList2</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">workList2</span><span class="o">.</span><span class="n">tail</span> <span class="o">==</span> <span class="n">workList2</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">next</span><span class="o">)</span>

    <span class="c1">// Processing inserted fn1, reentrant adding fn2</span>
    <span class="n">workList2</span> <span class="n">process</span> <span class="o">{</span> <span class="n">fn</span> <span class="k">⇒</span>
      <span class="k">var</span> <span class="n">processed</span> <span class="k">=</span> <span class="kc">true</span>
      <span class="n">fn</span><span class="o">.</span><span class="n">applyOrElse</span><span class="o">(</span><span class="s">&quot;Foo&quot;</span><span class="o">,</span> <span class="o">(</span><span class="k">_:</span> <span class="kt">Any</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">processed</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span>
      <span class="n">processed</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Reentrant delete&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Processing inserted fn2, should delete itself</span>
    <span class="n">workList2</span> <span class="n">process</span> <span class="o">{</span> <span class="n">fn</span> <span class="k">⇒</span>
      <span class="k">var</span> <span class="n">processed</span> <span class="k">=</span> <span class="kc">true</span>
      <span class="n">fn</span><span class="o">.</span><span class="n">applyOrElse</span><span class="o">(</span><span class="s">&quot;Foo&quot;</span><span class="o">,</span> <span class="o">(</span><span class="k">_:</span> <span class="kt">Any</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">processed</span> <span class="k">=</span> <span class="kc">false</span><span class="o">)</span>
      <span class="n">processed</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="sample-use-case-multiple-response-aggregation-and-chaining">
<h2>Sample Use Case - Multiple Response Aggregation and Chaining</h2>
<p>A shorter example showing aggregating responses and chaining further requests.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">InitialRequest</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Request</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Response</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">EvaluationResults</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">eval</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">FinalResponse</span><span class="o">(</span><span class="n">qualifiedValues</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="cm">/**</span>
<span class="cm"> * An actor sample demonstrating use of unexpect and chaining.</span>
<span class="cm"> * This is just an example and not a complete test case.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">ChainingSample</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="k">with</span> <span class="nc">Aggregator</span> <span class="o">{</span>

  <span class="n">expectOnce</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">InitialRequest</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">⇒</span> <span class="k">new</span> <span class="nc">MultipleResponseHandler</span><span class="o">(</span><span class="n">sender</span><span class="o">(),</span> <span class="n">name</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">class</span> <span class="nc">MultipleResponseHandler</span><span class="o">(</span><span class="n">originalSender</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">propName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">import</span> <span class="nn">context.dispatcher</span>
    <span class="k">import</span> <span class="nn">collection.mutable.ArrayBuffer</span>

    <span class="k">val</span> <span class="n">values</span> <span class="k">=</span> <span class="nc">ArrayBuffer</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>

    <span class="n">context</span><span class="o">.</span><span class="n">actorSelection</span><span class="o">(</span><span class="s">&quot;/user/request_proxies&quot;</span><span class="o">)</span> <span class="o">!</span> <span class="nc">Request</span><span class="o">(</span><span class="n">propName</span><span class="o">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">scheduleOnce</span><span class="o">(</span><span class="mf">50.</span><span class="n">milliseconds</span><span class="o">,</span> <span class="n">self</span><span class="o">,</span> <span class="nc">TimedOut</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">handle</span> <span class="k">=</span> <span class="n">expect</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Response</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="k">⇒</span>
        <span class="n">values</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span> <span class="n">processList</span><span class="o">()</span>
      <span class="k">case</span> <span class="nc">TimedOut</span> <span class="k">⇒</span> <span class="n">processList</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">processList</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">unexpect</span><span class="o">(</span><span class="n">handle</span><span class="o">)</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">actorSelection</span><span class="o">(</span><span class="s">&quot;/user/evaluator&quot;</span><span class="o">)</span> <span class="o">!</span> <span class="n">values</span><span class="o">.</span><span class="n">toList</span>
        <span class="n">expectOnce</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">EvaluationResults</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">eval</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">processFinal</span><span class="o">(</span><span class="n">eval</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">else</span> <span class="n">processFinal</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">processFinal</span><span class="o">(</span><span class="n">eval</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="o">{</span>
      <span class="c1">// Select only the entries coming back from eval</span>
      <span class="n">originalSender</span> <span class="o">!</span> <span class="nc">FinalResponse</span><span class="o">(</span><span class="n">eval</span> <span class="n">map</span> <span class="n">values</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pitfalls">
<h2>Pitfalls</h2>
<ul>
<li><p class="first">The current implementation does not match the sender of the message. This is
designed to work with <tt class="xref py py-class docutils literal"><span class="pre">ActorSelection</span></tt> as well as <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt>.
Without the sender(), there is a chance a received message can be matched by
more than one partial function. The partial function that was registered via
<tt class="xref py py-class docutils literal"><span class="pre">expect</span></tt> or <tt class="xref py py-class docutils literal"><span class="pre">expectOnce</span></tt> first (chronologically) and is not yet
de-registered by <tt class="xref py py-class docutils literal"><span class="pre">unexpect</span></tt> takes precedence in this case. Developers
should make sure the messages can be uniquely matched or the wrong logic can
be executed for a certain message.</p>
</li>
<li><p class="first">The <tt class="xref py py-class docutils literal"><span class="pre">sender</span></tt> referenced in any <tt class="xref py py-class docutils literal"><span class="pre">expect</span></tt> or <tt class="xref py py-class docutils literal"><span class="pre">expectOnce</span></tt>
logic refers to the sender() of that particular message and not the sender() of
the original message. The original sender() still needs to be saved so a final
response can be sent back.</p>
</li>
<li><p class="first"><tt class="xref py py-class docutils literal"><span class="pre">context.become</span></tt> is not supported when extending the <tt class="xref py py-class docutils literal"><span class="pre">Aggregator</span></tt>
trait.</p>
</li>
<li><p class="first">We strongly recommend against overriding <tt class="xref py py-class docutils literal"><span class="pre">receive</span></tt>. If your use case
really dictates, you may do so with extreme caution. Always provide a pattern
match handling aggregator messages among your <tt class="xref py py-class docutils literal"><span class="pre">receive</span></tt> pattern matches,
as follows:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">case</span> <span class="n">msg</span> <span class="k">if</span> <span class="n">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="k">⇒</span> <span class="c1">// noop</span>
<span class="c1">// side effects of handleMessage does the actual match</span>
</pre></div>
</div>
</li>
</ul>
<p>Sorry, there is not yet a Java implementation of the aggregator pattern available.</p>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
      <li><a href="http://akka.io/downloads">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@lightbend.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/akka_icon_reverse.svg" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2015 <a href="http://www.lightbend.com/">Lightbend Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Sep 30, 2016
    </p>
  </div>
</div>
<script type="text/javascript">
  var $toc = $('#toc');
  $toc.toc();

  // show clickable section sign when section header hovered:
  $('.section h2,.section h3,.section h4,.section h5').each(function(i, el) {
      var $el = $(el);
      $el.prepend($("<a class='section-marker' href='#" + $el.attr("id") + "'>&sect;</a>"))
  });
</script>

<!-- Algolia docs search -->
<script type="text/javascript">
  var version = DOCUMENTATION_OPTIONS.VERSION;

  var lang = "scala";
  var path = window.location.pathname;
  if (path.includes("/java/") || path.includes("java.html")) lang = "java";

  console.log("Search configured for:", lang, "@", version);

  docsearch({
    apiKey: '543bad5ad786495d9ccd445ed34ed082',
    indexName: 'akka_io',
    inputSelector: '#search',
    algoliaOptions: {
      hitsPerPage: 5,
      facetFilters: '[' + '["language:' + lang + '","language:general"]' + ',"version:' + version + '"]'
    }
  });

  // set up "/" as global shortcut for focusing on search
  $(document).keypress(function (event) {
    if (event.keyCode == 47) {
      $("#q").focus();
      return false; // swallow key event, otherwise the / char would be input into the search box
    }
  });
</script>

  

  </body>
</html>