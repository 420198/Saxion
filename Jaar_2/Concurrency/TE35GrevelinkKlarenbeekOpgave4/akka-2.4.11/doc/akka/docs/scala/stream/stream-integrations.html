


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Integration &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.4.11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/toc.js"></script>
    <script type="text/javascript" src="../../_static/prettify.js"></script>
    <script type="text/javascript" src="../../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../../_static/effects.core.js"></script>
    <script type="text/javascript" src="../../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../../_static/ga.js"></script>
    <script type="text/javascript" src="../../_static/warnOldDocs.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../../index.html" />
    <link rel="up" title="Streams" href="index.html" />
    <link rel="next" title="Error Handling" href="stream-error.html" />
    <link rel="prev" title="Custom stream processing" href="stream-customize.html" />


  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img class="svg-logo" src="../../_static/akka_full_color.svg" /></a>
        </div>
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
          <li><a href="http://akka.io/downloads">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>
          <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Integration</div>
      <div class="pdf-link"><a href="../../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../../AkkaJava.pdf" title="Akka Java Documentation"><img src="../../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">
              <li>
                 <span class="divider">|</span> <a href="stream-error.html">Error Handling</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../../java.html">Java Contents</a> <span class="divider">|</span> <a href="../../scala.html">Scala Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="stream-customize.html">Custom stream processing</a> <span class="divider">|</span>
              </li>
              <li style="float: left">
                Version 2.4.11
              </li>
              <li style="float: left">
                <input type="search" id="search" class="form-control" />
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="integration">
<span id="stream-integrations-scala"></span><h1>Integration</h1>
<div class="section" id="integrating-with-actors">
<h2>Integrating with Actors</h2>
<p>For piping the elements of a stream as messages to an ordinary actor you can use the
<tt class="docutils literal"><span class="pre">Sink.actorRef</span></tt>. Messages can be sent to a stream via the <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt> that is
materialized by <tt class="docutils literal"><span class="pre">Source.actorRef</span></tt>.</p>
<p>For more advanced use cases the <tt class="xref py py-class docutils literal"><span class="pre">ActorPublisher</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">ActorSubscriber</span></tt> traits are
provided to support implementing Reactive Streams <tt class="xref py py-class docutils literal"><span class="pre">Publisher</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">Subscriber</span></tt> with
an <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt>.</p>
<p>These can be consumed by other Reactive Stream libraries or used as an
Akka Streams <tt class="xref py py-class docutils literal"><span class="pre">Source</span></tt> or <tt class="xref py py-class docutils literal"><span class="pre">Sink</span></tt>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><tt class="xref py py-class docutils literal"><span class="pre">ActorPublisher</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">ActorSubscriber</span></tt> cannot be used with remote actors,
because if signals of the Reactive Streams protocol (e.g. <tt class="docutils literal"><span class="pre">request</span></tt>) are lost the
the stream may deadlock.</p>
</div>
<div class="section" id="source-actorref">
<h3>Source.actorRef</h3>
<p>Messages sent to the actor that is materialized by <tt class="docutils literal"><span class="pre">Source.actorRef</span></tt> will be emitted to the
stream if there is demand from downstream, otherwise they will be buffered until request for
demand is received.</p>
<p>Depending on the defined <tt class="xref py py-class docutils literal"><span class="pre">OverflowStrategy</span></tt> it might drop elements if there is no space
available in the buffer. The strategy <tt class="docutils literal"><span class="pre">OverflowStrategy.backpressure</span></tt> is not supported
for this Source type, you should consider using <tt class="docutils literal"><span class="pre">ActorPublisher</span></tt> if you want a backpressured
actor interface.</p>
<p>The stream can be completed successfully by sending <tt class="docutils literal"><span class="pre">akka.actor.PoisonPill</span></tt> or
<tt class="docutils literal"><span class="pre">akka.actor.Status.Success</span></tt> to the actor reference.</p>
<p>The stream can be completed with failure by sending <tt class="docutils literal"><span class="pre">akka.actor.Status.Failure</span></tt> to the
actor reference.</p>
<p>The actor will be stopped when the stream is completed, failed or cancelled from downstream,
i.e. you can watch it to get notified when that happens.</p>
</div>
<div class="section" id="sink-actorref">
<h3>Sink.actorRef</h3>
<p>The sink sends the elements of the stream to the given <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt>. If the target actor terminates
the stream will be cancelled. When the stream is completed successfully the given <tt class="docutils literal"><span class="pre">onCompleteMessage</span></tt>
will be sent to the destination actor. When the stream is completed with failure a <tt class="docutils literal"><span class="pre">akka.actor.Status.Failure</span></tt>
message will be sent to the destination actor.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There is no back-pressure signal from the destination actor, i.e. if the actor is not consuming
the messages fast enough the mailbox of the actor will grow. For potentially slow consumer actors
it is recommended to use a bounded mailbox with zero <cite>mailbox-push-timeout-time</cite> or use a rate
limiting stage in front of this stage.</p>
</div>
</div>
<div class="section" id="actorpublisher">
<h3>ActorPublisher</h3>
<p>Extend/mixin <tt class="xref py py-class docutils literal"><span class="pre">akka.stream.actor.ActorPublisher</span></tt> in your <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt> to make it a
stream publisher that keeps track of the subscription life cycle and requested elements.</p>
<p>Here is an example of such an actor. It dispatches incoming jobs to the attached subscriber:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">object</span> <span class="nc">JobManager</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">props</span><span class="k">:</span> <span class="kt">Props</span> <span class="o">=</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">JobManager</span><span class="o">]</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Job</span><span class="o">(</span><span class="n">payload</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">JobAccepted</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">JobDenied</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">JobManager</span> <span class="k">extends</span> <span class="nc">ActorPublisher</span><span class="o">[</span><span class="kt">JobManager.Job</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">akka.stream.actor.ActorPublisherMessage._</span>
  <span class="k">import</span> <span class="nn">JobManager._</span>

  <span class="k">val</span> <span class="nc">MaxBufferSize</span> <span class="k">=</span> <span class="mi">100</span>
  <span class="k">var</span> <span class="n">buf</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">Job</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">job</span><span class="k">:</span> <span class="kt">Job</span> <span class="kt">if</span> <span class="kt">buf.size</span> <span class="o">=</span><span class="k">=</span> <span class="nc">MaxBufferSize</span> <span class="k">=&gt;</span>
      <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">JobDenied</span>
    <span class="k">case</span> <span class="n">job</span><span class="k">:</span> <span class="kt">Job</span> <span class="o">=&gt;</span>
      <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">JobAccepted</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="n">totalDemand</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">onNext</span><span class="o">(</span><span class="n">job</span><span class="o">)</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">buf</span> <span class="o">:+=</span> <span class="n">job</span>
        <span class="n">deliverBuf</span><span class="o">()</span>
      <span class="o">}</span>
    <span class="k">case</span> <span class="nc">Request</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">deliverBuf</span><span class="o">()</span>
    <span class="k">case</span> <span class="nc">Cancel</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="nd">@tailrec</span> <span class="k">final</span> <span class="k">def</span> <span class="n">deliverBuf</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">totalDemand</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="cm">/*</span>
<span class="cm">       * totalDemand is a Long and could be larger than</span>
<span class="cm">       * what buf.splitAt can accept</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">totalDemand</span> <span class="o">&lt;=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MaxValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">val</span> <span class="o">(</span><span class="n">use</span><span class="o">,</span> <span class="n">keep</span><span class="o">)</span> <span class="k">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">totalDemand</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
        <span class="n">buf</span> <span class="k">=</span> <span class="n">keep</span>
        <span class="n">use</span> <span class="n">foreach</span> <span class="n">onNext</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">val</span> <span class="o">(</span><span class="n">use</span><span class="o">,</span> <span class="n">keep</span><span class="o">)</span> <span class="k">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="nc">Int</span><span class="o">.</span><span class="nc">MaxValue</span><span class="o">)</span>
        <span class="n">buf</span> <span class="k">=</span> <span class="n">keep</span>
        <span class="n">use</span> <span class="n">foreach</span> <span class="n">onNext</span>
        <span class="n">deliverBuf</span><span class="o">()</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You send elements to the stream by calling <tt class="docutils literal"><span class="pre">onNext</span></tt>. You are allowed to send as many
elements as have been requested by the stream subscriber. This amount can be inquired with
<tt class="docutils literal"><span class="pre">totalDemand</span></tt>. It is only allowed to use <tt class="docutils literal"><span class="pre">onNext</span></tt> when <tt class="docutils literal"><span class="pre">isActive</span></tt> and <tt class="docutils literal"><span class="pre">totalDemand&gt;0</span></tt>,
otherwise <tt class="docutils literal"><span class="pre">onNext</span></tt> will throw <tt class="docutils literal"><span class="pre">IllegalStateException</span></tt>.</p>
<p>When the stream subscriber requests more elements the <tt class="docutils literal"><span class="pre">ActorPublisherMessage.Request</span></tt> message
is delivered to this actor, and you can act on that event. The <tt class="docutils literal"><span class="pre">totalDemand</span></tt>
is updated automatically.</p>
<p>When the stream subscriber cancels the subscription the <tt class="docutils literal"><span class="pre">ActorPublisherMessage.Cancel</span></tt> message
is delivered to this actor. After that subsequent calls to <tt class="docutils literal"><span class="pre">onNext</span></tt> will be ignored.</p>
<p>You can complete the stream by calling <tt class="docutils literal"><span class="pre">onComplete</span></tt>. After that you are not allowed to
call <tt class="docutils literal"><span class="pre">onNext</span></tt>, <tt class="docutils literal"><span class="pre">onError</span></tt> and <tt class="docutils literal"><span class="pre">onComplete</span></tt>.</p>
<p>You can terminate the stream with failure by calling <tt class="docutils literal"><span class="pre">onError</span></tt>. After that you are not allowed to
call <tt class="docutils literal"><span class="pre">onNext</span></tt>, <tt class="docutils literal"><span class="pre">onError</span></tt> and <tt class="docutils literal"><span class="pre">onComplete</span></tt>.</p>
<p>If you suspect that this <tt class="docutils literal"><span class="pre">ActorPublisher</span></tt> may never get subscribed to, you can override the <tt class="docutils literal"><span class="pre">subscriptionTimeout</span></tt>
method to provide a timeout after which this Publisher should be considered canceled. The actor will be notified when
the timeout triggers via an <tt class="docutils literal"><span class="pre">ActorPublisherMessage.SubscriptionTimeoutExceeded</span></tt> message and MUST then perform
cleanup and stop itself.</p>
<p>If the actor is stopped the stream will be completed, unless it was not already terminated with
failure, completed or canceled.</p>
<p>More detailed information can be found in the API documentation.</p>
<p>This is how it can be used as input <tt class="xref py py-class docutils literal"><span class="pre">Source</span></tt> to a <tt class="xref py py-class docutils literal"><span class="pre">Flow</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">jobManagerSource</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">actorPublisher</span><span class="o">[</span><span class="kt">JobManager.Job</span><span class="o">](</span><span class="nc">JobManager</span><span class="o">.</span><span class="n">props</span><span class="o">)</span>
<span class="k">val</span> <span class="n">ref</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">JobManager.Job</span><span class="o">]</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">)</span>
  <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">elem</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">elem</span><span class="o">);</span> <span class="n">elem</span> <span class="o">}</span>
  <span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)</span>
  <span class="o">.</span><span class="n">runWith</span><span class="o">(</span><span class="n">jobManagerSource</span><span class="o">)</span>

<span class="n">ref</span> <span class="o">!</span> <span class="nc">JobManager</span><span class="o">.</span><span class="nc">Job</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)</span>
<span class="n">ref</span> <span class="o">!</span> <span class="nc">JobManager</span><span class="o">.</span><span class="nc">Job</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">)</span>
<span class="n">ref</span> <span class="o">!</span> <span class="nc">JobManager</span><span class="o">.</span><span class="nc">Job</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>A publisher that is created with <tt class="docutils literal"><span class="pre">Sink.asPublisher</span></tt> supports a specified number of subscribers. Additional
subscription attempts will be rejected with an <tt class="xref py py-class docutils literal"><span class="pre">IllegalStateException</span></tt>.</p>
</div>
<div class="section" id="actorsubscriber">
<h3>ActorSubscriber</h3>
<p>Extend/mixin <tt class="xref py py-class docutils literal"><span class="pre">akka.stream.actor.ActorSubscriber</span></tt> in your <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt> to make it a
stream subscriber with full control of stream back pressure. It will receive
<tt class="docutils literal"><span class="pre">ActorSubscriberMessage.OnNext</span></tt>, <tt class="docutils literal"><span class="pre">ActorSubscriberMessage.OnComplete</span></tt> and <tt class="docutils literal"><span class="pre">ActorSubscriberMessage.OnError</span></tt>
messages from the stream. It can also receive other, non-stream messages, in the same way as any actor.</p>
<p>Here is an example of such an actor. It dispatches incoming jobs to child worker actors:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">object</span> <span class="nc">WorkerPool</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Msg</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Work</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Reply</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Done</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">props</span><span class="k">:</span> <span class="kt">Props</span> <span class="o">=</span> <span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">WorkerPool</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">WorkerPool</span> <span class="k">extends</span> <span class="nc">ActorSubscriber</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">WorkerPool._</span>
  <span class="k">import</span> <span class="nn">ActorSubscriberMessage._</span>

  <span class="k">val</span> <span class="nc">MaxQueueSize</span> <span class="k">=</span> <span class="mi">10</span>
  <span class="k">var</span> <span class="n">queue</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">ActorRef</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">router</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">routees</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">fill</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ActorRefRoutee</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]))</span>
    <span class="o">}</span>
    <span class="nc">Router</span><span class="o">(</span><span class="nc">RoundRobinRoutingLogic</span><span class="o">(),</span> <span class="n">routees</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">requestStrategy</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MaxInFlightRequestStrategy</span><span class="o">(</span><span class="n">max</span> <span class="k">=</span> <span class="nc">MaxQueueSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">inFlightInternally</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">size</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">OnNext</span><span class="o">(</span><span class="nc">Msg</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">))</span> <span class="k">=&gt;</span>
      <span class="n">queue</span> <span class="o">+=</span> <span class="o">(</span><span class="n">id</span> <span class="o">-&gt;</span> <span class="n">replyTo</span><span class="o">)</span>
      <span class="n">assert</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="nc">MaxQueueSize</span><span class="o">,</span> <span class="n">s</span><span class="s">&quot;queued too many: ${queue.size}&quot;</span><span class="o">)</span>
      <span class="n">router</span><span class="o">.</span><span class="n">route</span><span class="o">(</span><span class="nc">Work</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="n">self</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Reply</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">queue</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">!</span> <span class="nc">Done</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
      <span class="n">queue</span> <span class="o">-=</span> <span class="n">id</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Worker</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">WorkerPool._</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Work</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="c1">// ...</span>
      <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">Reply</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Subclass must define the <tt class="docutils literal"><span class="pre">RequestStrategy</span></tt> to control stream back pressure.
After each incoming message the <tt class="docutils literal"><span class="pre">ActorSubscriber</span></tt> will automatically invoke
the <tt class="docutils literal"><span class="pre">RequestStrategy.requestDemand</span></tt> and propagate the returned demand to the stream.</p>
<ul class="simple">
<li>The provided <tt class="docutils literal"><span class="pre">WatermarkRequestStrategy</span></tt> is a good strategy if the actor performs work itself.</li>
<li>The provided <tt class="docutils literal"><span class="pre">MaxInFlightRequestStrategy</span></tt> is useful if messages are queued internally or
delegated to other actors.</li>
<li>You can also implement a custom <tt class="docutils literal"><span class="pre">RequestStrategy</span></tt> or call <tt class="docutils literal"><span class="pre">request</span></tt> manually together with
<tt class="docutils literal"><span class="pre">ZeroRequestStrategy</span></tt> or some other strategy. In that case
you must also call <tt class="docutils literal"><span class="pre">request</span></tt> when the actor is started or when it is ready, otherwise
it will not receive any elements.</li>
</ul>
<p>More detailed information can be found in the API documentation.</p>
<p>This is how it can be used as output <tt class="xref py py-class docutils literal"><span class="pre">Sink</span></tt> to a <tt class="xref py py-class docutils literal"><span class="pre">Flow</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">N</span> <span class="k">=</span> <span class="mi">117</span>
<span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">N</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="nc">WorkerPool</span><span class="o">.</span><span class="nc">Msg</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">))</span>
  <span class="o">.</span><span class="n">runWith</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">actorSubscriber</span><span class="o">(</span><span class="nc">WorkerPool</span><span class="o">.</span><span class="n">props</span><span class="o">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="integrating-with-external-services">
<h2>Integrating with External Services</h2>
<p>Stream transformations and side effects involving external non-stream based services can be
performed with <tt class="docutils literal"><span class="pre">mapAsync</span></tt> or <tt class="docutils literal"><span class="pre">mapAsyncUnordered</span></tt>.</p>
<p>For example, sending emails to the authors of selected tweets using an external
email service:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">email</span><span class="k">:</span> <span class="kt">Email</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We start with the tweet stream of authors:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">authors</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Author</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">tweets</span>
    <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">hashtags</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">akka</span><span class="o">))</span>
    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">author</span><span class="o">)</span>
</pre></div>
</div>
<p>Assume that we can lookup their email address using:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">lookupEmail</span><span class="o">(</span><span class="n">handle</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span>
</pre></div>
</div>
<p>Transforming the stream of authors to a stream of email addresses by using the <tt class="docutils literal"><span class="pre">lookupEmail</span></tt>
service can be done with <tt class="docutils literal"><span class="pre">mapAsync</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">emailAddresses</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">authors</span>
    <span class="o">.</span><span class="n">mapAsync</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">author</span> <span class="k">=&gt;</span> <span class="n">addressSystem</span><span class="o">.</span><span class="n">lookupEmail</span><span class="o">(</span><span class="n">author</span><span class="o">.</span><span class="n">handle</span><span class="o">))</span>
    <span class="o">.</span><span class="n">collect</span> <span class="o">{</span> <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">emailAddress</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">emailAddress</span> <span class="o">}</span>
</pre></div>
</div>
<p>Finally, sending the emails:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">sendEmails</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">emailAddresses</span>
    <span class="o">.</span><span class="n">mapAsync</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">address</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">emailServer</span><span class="o">.</span><span class="n">send</span><span class="o">(</span>
        <span class="nc">Email</span><span class="o">(</span><span class="n">to</span> <span class="k">=</span> <span class="n">address</span><span class="o">,</span> <span class="n">title</span> <span class="k">=</span> <span class="s">&quot;Akka&quot;</span><span class="o">,</span> <span class="n">body</span> <span class="k">=</span> <span class="s">&quot;I like your tweet&quot;</span><span class="o">))</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)</span>

<span class="n">sendEmails</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">mapAsync</span></tt> is applying the given function that is calling out to the external service to
each of the elements as they pass through this processing step. The function returns a <tt class="xref py py-class docutils literal"><span class="pre">Future</span></tt>
and the value of that future will be emitted downstreams. The number of Futures
that shall run in parallel is given as the first argument to <tt class="docutils literal"><span class="pre">mapAsync</span></tt>.
These Futures may complete in any order, but the elements that are emitted
downstream are in the same order as received from upstream.</p>
<p>That means that back-pressure works as expected. For example if the <tt class="docutils literal"><span class="pre">emailServer.send</span></tt>
is the bottleneck it will limit the rate at which incoming tweets are retrieved and
email addresses looked up.</p>
<p>The final piece of this pipeline is to generate the demand that pulls the tweet
authors information through the emailing pipeline: we attach a <tt class="docutils literal"><span class="pre">Sink.ignore</span></tt>
which makes it all run. If our email process would return some interesting data
for further transformation then we would of course not ignore it but send that
result stream onwards for further processing or storage.</p>
<p>Note that <tt class="docutils literal"><span class="pre">mapAsync</span></tt> preserves the order of the stream elements. In this example the order
is not important and then we can use the more efficient <tt class="docutils literal"><span class="pre">mapAsyncUnordered</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">authors</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Author</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">tweets</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">hashtags</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">akka</span><span class="o">)).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">author</span><span class="o">)</span>

<span class="k">val</span> <span class="n">emailAddresses</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">authors</span>
    <span class="o">.</span><span class="n">mapAsyncUnordered</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">author</span> <span class="k">=&gt;</span> <span class="n">addressSystem</span><span class="o">.</span><span class="n">lookupEmail</span><span class="o">(</span><span class="n">author</span><span class="o">.</span><span class="n">handle</span><span class="o">))</span>
    <span class="o">.</span><span class="n">collect</span> <span class="o">{</span> <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">emailAddress</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">emailAddress</span> <span class="o">}</span>

<span class="k">val</span> <span class="n">sendEmails</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">emailAddresses</span>
    <span class="o">.</span><span class="n">mapAsyncUnordered</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">address</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">emailServer</span><span class="o">.</span><span class="n">send</span><span class="o">(</span>
        <span class="nc">Email</span><span class="o">(</span><span class="n">to</span> <span class="k">=</span> <span class="n">address</span><span class="o">,</span> <span class="n">title</span> <span class="k">=</span> <span class="s">&quot;Akka&quot;</span><span class="o">,</span> <span class="n">body</span> <span class="k">=</span> <span class="s">&quot;I like your tweet&quot;</span><span class="o">))</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)</span>

<span class="n">sendEmails</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</pre></div>
</div>
<p>In the above example the services conveniently returned a <tt class="xref py py-class docutils literal"><span class="pre">Future</span></tt> of the result.
If that is not the case you need to wrap the call in a <tt class="xref py py-class docutils literal"><span class="pre">Future</span></tt>. If the service call
involves blocking you must also make sure that you run it on a dedicated execution context, to
avoid starvation and disturbance of other tasks in the system.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">blockingExecutionContext</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">dispatchers</span><span class="o">.</span><span class="n">lookup</span><span class="o">(</span><span class="s">&quot;blocking-dispatcher&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">sendTextMessages</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">phoneNumbers</span>
    <span class="o">.</span><span class="n">mapAsync</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">phoneNo</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nc">Future</span> <span class="o">{</span>
        <span class="n">smsServer</span><span class="o">.</span><span class="n">send</span><span class="o">(</span>
          <span class="nc">TextMessage</span><span class="o">(</span><span class="n">to</span> <span class="k">=</span> <span class="n">phoneNo</span><span class="o">,</span> <span class="n">body</span> <span class="k">=</span> <span class="s">&quot;I like your tweet&quot;</span><span class="o">))</span>
      <span class="o">}(</span><span class="n">blockingExecutionContext</span><span class="o">)</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)</span>

<span class="n">sendTextMessages</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</pre></div>
</div>
<p>The configuration of the <tt class="docutils literal"><span class="pre">&quot;blocking-dispatcher&quot;</span></tt> may look something like:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">blocking</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
  <span class="n">executor</span> <span class="k">=</span> <span class="s">&quot;thread-pool-executor&quot;</span>
  <span class="n">thread</span><span class="o">-</span><span class="n">pool</span><span class="o">-</span><span class="n">executor</span> <span class="o">{</span>
    <span class="n">core</span><span class="o">-</span><span class="n">pool</span><span class="o">-</span><span class="n">size</span><span class="o">-</span><span class="n">min</span>    <span class="k">=</span> <span class="mi">10</span>
    <span class="n">core</span><span class="o">-</span><span class="n">pool</span><span class="o">-</span><span class="n">size</span><span class="o">-</span><span class="n">max</span>    <span class="k">=</span> <span class="mi">10</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>An alternative for blocking calls is to perform them in a <tt class="docutils literal"><span class="pre">map</span></tt> operation, still using a
dedicated dispatcher for that operation.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">send</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
  <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">phoneNo</span> <span class="k">=&gt;</span>
    <span class="n">smsServer</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="nc">TextMessage</span><span class="o">(</span><span class="n">to</span> <span class="k">=</span> <span class="n">phoneNo</span><span class="o">,</span> <span class="n">body</span> <span class="k">=</span> <span class="s">&quot;I like your tweet&quot;</span><span class="o">))</span>
  <span class="o">}</span>
  <span class="o">.</span><span class="n">withAttributes</span><span class="o">(</span><span class="nc">ActorAttributes</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">(</span><span class="s">&quot;blocking-dispatcher&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">sendTextMessages</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">phoneNumbers</span><span class="o">.</span><span class="n">via</span><span class="o">(</span><span class="n">send</span><span class="o">).</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)</span>

<span class="n">sendTextMessages</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</pre></div>
</div>
<p>However, that is not exactly the same as <tt class="docutils literal"><span class="pre">mapAsync</span></tt>, since the <tt class="docutils literal"><span class="pre">mapAsync</span></tt> may run
several calls concurrently, but <tt class="docutils literal"><span class="pre">map</span></tt> performs them one at a time.</p>
<p>For a service that is exposed as an actor, or if an actor is used as a gateway in front of an
external service, you can use <tt class="docutils literal"><span class="pre">ask</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">akkaTweets</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Tweet</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="n">tweets</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">hashtags</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">akka</span><span class="o">))</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Timeout</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">)</span>
<span class="k">val</span> <span class="n">saveTweets</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">akkaTweets</span>
    <span class="o">.</span><span class="n">mapAsync</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">tweet</span> <span class="k">=&gt;</span> <span class="n">database</span> <span class="o">?</span> <span class="nc">Save</span><span class="o">(</span><span class="n">tweet</span><span class="o">))</span>
    <span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)</span>
</pre></div>
</div>
<p>Note that if the <tt class="docutils literal"><span class="pre">ask</span></tt> is not completed within the given timeout the stream is completed with failure.
If that is not desired outcome you can use <tt class="docutils literal"><span class="pre">recover</span></tt> on the <tt class="docutils literal"><span class="pre">ask</span></tt> <tt class="xref py py-class docutils literal"><span class="pre">Future</span></tt>.</p>
<div class="section" id="illustrating-ordering-and-parallelism">
<h3>Illustrating ordering and parallelism</h3>
<p>Let us look at another example to get a better understanding of the ordering
and parallelism characteristics of <tt class="docutils literal"><span class="pre">mapAsync</span></tt> and <tt class="docutils literal"><span class="pre">mapAsyncUnordered</span></tt>.</p>
<p>Several <tt class="docutils literal"><span class="pre">mapAsync</span></tt> and <tt class="docutils literal"><span class="pre">mapAsyncUnordered</span></tt> futures may run concurrently.
The number of concurrent futures are limited by the downstream demand.
For example, if 5 elements have been requested by downstream there will be at most 5
futures in progress.</p>
<p><tt class="docutils literal"><span class="pre">mapAsync</span></tt> emits the future results in the same order as the input elements
were received. That means that completed results are only emitted downstream
when earlier results have been completed and emitted. One slow call will thereby
delay the results of all successive calls, even though they are completed before
the slow call.</p>
<p><tt class="docutils literal"><span class="pre">mapAsyncUnordered</span></tt> emits the future results as soon as they are completed, i.e.
it is possible that the elements are not emitted downstream in the same order as
received from upstream. One slow call will thereby not delay the results of faster
successive calls as long as there is downstream demand of several elements.</p>
<p>Here is a fictive service that we can use to illustrate these aspects.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SometimesSlowService</span><span class="o">(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">runningCount</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span>

  <span class="k">def</span> <span class="n">convert</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;running: $s (${runningCount.incrementAndGet()})&quot;</span><span class="o">)</span>
    <span class="nc">Future</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">nonEmpty</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">isLower</span><span class="o">)</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">)</span>
      <span class="k">else</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
      <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;completed: $s (${runningCount.decrementAndGet()})&quot;</span><span class="o">)</span>
      <span class="n">s</span><span class="o">.</span><span class="n">toUpperCase</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Elements starting with a lower case character are simulated to take longer time
to process.</p>
<p>Here is how we can use it with <tt class="docutils literal"><span class="pre">mapAsync</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">implicit</span> <span class="k">val</span> <span class="n">blockingExecutionContext</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">dispatchers</span><span class="o">.</span><span class="n">lookup</span><span class="o">(</span><span class="s">&quot;blocking-dispatcher&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">service</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SometimesSlowService</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">(</span>
  <span class="nc">ActorMaterializerSettings</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">withInputBuffer</span><span class="o">(</span><span class="n">initialSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">,</span> <span class="n">maxSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">))</span>

<span class="nc">Source</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="s">&quot;B&quot;</span><span class="o">,</span> <span class="s">&quot;C&quot;</span><span class="o">,</span> <span class="s">&quot;D&quot;</span><span class="o">,</span> <span class="s">&quot;e&quot;</span><span class="o">,</span> <span class="s">&quot;F&quot;</span><span class="o">,</span> <span class="s">&quot;g&quot;</span><span class="o">,</span> <span class="s">&quot;H&quot;</span><span class="o">,</span> <span class="s">&quot;i&quot;</span><span class="o">,</span> <span class="s">&quot;J&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">elem</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;before: $elem&quot;</span><span class="o">);</span> <span class="n">elem</span> <span class="o">})</span>
  <span class="o">.</span><span class="n">mapAsync</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">service</span><span class="o">.</span><span class="n">convert</span><span class="o">)</span>
  <span class="o">.</span><span class="n">runForeach</span><span class="o">(</span><span class="n">elem</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;after: $elem&quot;</span><span class="o">))</span>
</pre></div>
</div>
<p>The output may look like this:</p>
<div class="highlight-scala"><pre>before: a
before: B
before: C
before: D
running: a (1)
running: B (2)
before: e
running: C (3)
before: F
running: D (4)
before: g
before: H
completed: C (3)
completed: B (2)
completed: D (1)
completed: a (0)
after: A
after: B
running: e (1)
after: C
after: D
running: F (2)
before: i
before: J
running: g (3)
running: H (4)
completed: H (2)
completed: F (3)
completed: e (1)
completed: g (0)
after: E
after: F
running: i (1)
after: G
after: H
running: J (2)
completed: J (1)
completed: i (0)
after: I
after: J</pre>
</div>
<p>Note that <tt class="docutils literal"><span class="pre">after</span></tt> lines are in the same order as the <tt class="docutils literal"><span class="pre">before</span></tt> lines even
though elements are <tt class="docutils literal"><span class="pre">completed</span></tt> in a different order. For example <tt class="docutils literal"><span class="pre">H</span></tt>
is <tt class="docutils literal"><span class="pre">completed</span></tt> before <tt class="docutils literal"><span class="pre">g</span></tt>, but still emitted afterwards.</p>
<p>The numbers in parenthesis illustrates how many calls that are in progress at
the same time. Here the downstream demand and thereby the number of concurrent
calls are limited by the buffer size (4) of the <tt class="xref py py-class docutils literal"><span class="pre">ActorMaterializerSettings</span></tt>.</p>
<p>Here is how we can use the same service with <tt class="docutils literal"><span class="pre">mapAsyncUnordered</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">implicit</span> <span class="k">val</span> <span class="n">blockingExecutionContext</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">dispatchers</span><span class="o">.</span><span class="n">lookup</span><span class="o">(</span><span class="s">&quot;blocking-dispatcher&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">service</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SometimesSlowService</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">(</span>
  <span class="nc">ActorMaterializerSettings</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">withInputBuffer</span><span class="o">(</span><span class="n">initialSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">,</span> <span class="n">maxSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">))</span>

<span class="nc">Source</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="s">&quot;B&quot;</span><span class="o">,</span> <span class="s">&quot;C&quot;</span><span class="o">,</span> <span class="s">&quot;D&quot;</span><span class="o">,</span> <span class="s">&quot;e&quot;</span><span class="o">,</span> <span class="s">&quot;F&quot;</span><span class="o">,</span> <span class="s">&quot;g&quot;</span><span class="o">,</span> <span class="s">&quot;H&quot;</span><span class="o">,</span> <span class="s">&quot;i&quot;</span><span class="o">,</span> <span class="s">&quot;J&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">elem</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;before: $elem&quot;</span><span class="o">);</span> <span class="n">elem</span> <span class="o">})</span>
  <span class="o">.</span><span class="n">mapAsyncUnordered</span><span class="o">(</span><span class="mi">4</span><span class="o">)(</span><span class="n">service</span><span class="o">.</span><span class="n">convert</span><span class="o">)</span>
  <span class="o">.</span><span class="n">runForeach</span><span class="o">(</span><span class="n">elem</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;after: $elem&quot;</span><span class="o">))</span>
</pre></div>
</div>
<p>The output may look like this:</p>
<div class="highlight-scala"><pre>before: a
before: B
before: C
before: D
running: a (1)
running: B (2)
before: e
running: C (3)
before: F
running: D (4)
before: g
before: H
completed: B (3)
completed: C (1)
completed: D (2)
after: B
after: D
running: e (2)
after: C
running: F (3)
before: i
before: J
completed: F (2)
after: F
running: g (3)
running: H (4)
completed: H (3)
after: H
completed: a (2)
after: A
running: i (3)
running: J (4)
completed: J (3)
after: J
completed: e (2)
after: E
completed: g (1)
after: G
completed: i (0)
after: I</pre>
</div>
<p>Note that <tt class="docutils literal"><span class="pre">after</span></tt> lines are not in the same order as the <tt class="docutils literal"><span class="pre">before</span></tt> lines. For example
<tt class="docutils literal"><span class="pre">H</span></tt> overtakes the slow <tt class="docutils literal"><span class="pre">G</span></tt>.</p>
<p>The numbers in parenthesis illustrates how many calls that are in progress at
the same time. Here the downstream demand and thereby the number of concurrent
calls are limited by the buffer size (4) of the <tt class="xref py py-class docutils literal"><span class="pre">ActorMaterializerSettings</span></tt>.</p>
</div>
</div>
<div class="section" id="integrating-with-reactive-streams">
<span id="reactive-streams-integration-scala"></span><h2>Integrating with Reactive Streams</h2>
<p><a class="reference external" href="http://reactive-streams.org/">Reactive Streams</a> defines a standard for asynchronous stream processing with non-blocking
back pressure. It makes it possible to plug together stream libraries that adhere to the standard.
Akka Streams is one such library.</p>
<p>An incomplete list of other implementations:</p>
<ul class="simple">
<li><a class="reference external" href="http://github.com/reactor/reactor">Reactor (1.1+)</a></li>
<li><a class="reference external" href="https://github.com/ReactiveX/RxJavaReactiveStreams">RxJava</a></li>
<li><a class="reference external" href="http://www.ratpack.io/manual/current/streams.html">Ratpack</a></li>
<li><a class="reference external" href="http://slick.lightbend.com">Slick</a></li>
</ul>
<p>The two most important interfaces in Reactive Streams are the <tt class="xref py py-class docutils literal"><span class="pre">Publisher</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">Subscriber</span></tt>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">org.reactivestreams.Publisher</span>
<span class="k">import</span> <span class="nn">org.reactivestreams.Subscriber</span>
</pre></div>
</div>
<p>Let us assume that a library provides a publisher of tweets:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">tweets</span><span class="k">:</span> <span class="kt">Publisher</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span>
</pre></div>
</div>
<p>and another library knows how to store author handles in a database:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">storage</span><span class="k">:</span> <span class="kt">Subscriber</span><span class="o">[</span><span class="kt">Author</span><span class="o">]</span>
</pre></div>
</div>
<p>Using an Akka Streams <tt class="xref py py-class docutils literal"><span class="pre">Flow</span></tt> we can transform the stream and connect those:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">authors</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span>
  <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">hashtags</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">akka</span><span class="o">))</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">author</span><span class="o">)</span>

<span class="nc">Source</span><span class="o">.</span><span class="n">fromPublisher</span><span class="o">(</span><span class="n">tweets</span><span class="o">).</span><span class="n">via</span><span class="o">(</span><span class="n">authors</span><span class="o">).</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">fromSubscriber</span><span class="o">(</span><span class="n">storage</span><span class="o">)).</span><span class="n">run</span><span class="o">()</span>
</pre></div>
</div>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">Publisher</span></tt> is used as an input <tt class="xref py py-class docutils literal"><span class="pre">Source</span></tt> to the flow and the
<tt class="xref py py-class docutils literal"><span class="pre">Subscriber</span></tt> is used as an output <tt class="xref py py-class docutils literal"><span class="pre">Sink</span></tt>.</p>
<p>A <tt class="xref py py-class docutils literal"><span class="pre">Flow</span></tt> can also be also converted to a <tt class="xref py py-class docutils literal"><span class="pre">RunnableGraph[Processor[In,</span> <span class="pre">Out]]</span></tt> which
materializes to a <tt class="xref py py-class docutils literal"><span class="pre">Processor</span></tt> when <tt class="docutils literal"><span class="pre">run()</span></tt> is called. <tt class="docutils literal"><span class="pre">run()</span></tt> itself can be called multiple
times, resulting in a new <tt class="xref py py-class docutils literal"><span class="pre">Processor</span></tt> instance each time.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">processor</span><span class="k">:</span> <span class="kt">Processor</span><span class="o">[</span><span class="kt">Tweet</span>, <span class="kt">Author</span><span class="o">]</span> <span class="k">=</span> <span class="n">authors</span><span class="o">.</span><span class="n">toProcessor</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>

<span class="n">tweets</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">processor</span><span class="o">)</span>
<span class="n">processor</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">storage</span><span class="o">)</span>
</pre></div>
</div>
<p>A publisher can be connected to a subscriber with the <tt class="docutils literal"><span class="pre">subscribe</span></tt> method.</p>
<p>It is also possible to expose a <tt class="xref py py-class docutils literal"><span class="pre">Source</span></tt> as a <tt class="xref py py-class docutils literal"><span class="pre">Publisher</span></tt>
by using the Publisher-<tt class="xref py py-class docutils literal"><span class="pre">Sink</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">authorPublisher</span><span class="k">:</span> <span class="kt">Publisher</span><span class="o">[</span><span class="kt">Author</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Source</span><span class="o">.</span><span class="n">fromPublisher</span><span class="o">(</span><span class="n">tweets</span><span class="o">).</span><span class="n">via</span><span class="o">(</span><span class="n">authors</span><span class="o">).</span><span class="n">runWith</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">asPublisher</span><span class="o">(</span><span class="n">fanout</span> <span class="k">=</span> <span class="kc">false</span><span class="o">))</span>

<span class="n">authorPublisher</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">storage</span><span class="o">)</span>
</pre></div>
</div>
<p>A publisher that is created with <tt class="docutils literal"><span class="pre">Sink.asPublisher(fanout</span> <span class="pre">=</span> <span class="pre">false)</span></tt> supports only a single subscription.
Additional subscription attempts will be rejected with an <tt class="xref py py-class docutils literal"><span class="pre">IllegalStateException</span></tt>.</p>
<p>A publisher that supports multiple subscribers using fan-out/broadcasting is created as follows:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">storage</span><span class="k">:</span> <span class="kt">Subscriber</span><span class="o">[</span><span class="kt">Author</span><span class="o">]</span>
<span class="k">def</span> <span class="n">alert</span><span class="k">:</span> <span class="kt">Subscriber</span><span class="o">[</span><span class="kt">Author</span><span class="o">]</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">authorPublisher</span><span class="k">:</span> <span class="kt">Publisher</span><span class="o">[</span><span class="kt">Author</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Source</span><span class="o">.</span><span class="n">fromPublisher</span><span class="o">(</span><span class="n">tweets</span><span class="o">).</span><span class="n">via</span><span class="o">(</span><span class="n">authors</span><span class="o">)</span>
    <span class="o">.</span><span class="n">runWith</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">asPublisher</span><span class="o">(</span><span class="n">fanout</span> <span class="k">=</span> <span class="kc">true</span><span class="o">))</span>

<span class="n">authorPublisher</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">storage</span><span class="o">)</span>
<span class="n">authorPublisher</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">alert</span><span class="o">)</span>
</pre></div>
</div>
<p>The input buffer size of the stage controls how far apart the slowest subscriber can be from the fastest subscriber
before slowing down the stream.</p>
<p>To make the picture complete, it is also possible to expose a <tt class="xref py py-class docutils literal"><span class="pre">Sink</span></tt> as a <tt class="xref py py-class docutils literal"><span class="pre">Subscriber</span></tt>
by using the Subscriber-<tt class="xref py py-class docutils literal"><span class="pre">Source</span></tt>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">tweetSubscriber</span><span class="k">:</span> <span class="kt">Subscriber</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">authors</span><span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">fromSubscriber</span><span class="o">(</span><span class="n">storage</span><span class="o">)).</span><span class="n">runWith</span><span class="o">(</span><span class="nc">Source</span><span class="o">.</span><span class="n">asSubscriber</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">])</span>

<span class="n">tweets</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">tweetSubscriber</span><span class="o">)</span>
</pre></div>
</div>
<p>It is also possible to use re-wrap <tt class="xref py py-class docutils literal"><span class="pre">Processor</span></tt> instances as a <tt class="xref py py-class docutils literal"><span class="pre">Flow</span></tt> by
passing a factory function that will create the <tt class="xref py py-class docutils literal"><span class="pre">Processor</span></tt> instances:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// An example Processor factory</span>
<span class="k">def</span> <span class="n">createProcessor</span><span class="k">:</span> <span class="kt">Processor</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">toProcessor</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>

<span class="k">val</span> <span class="n">flow</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">.</span><span class="n">fromProcessor</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">createProcessor</span><span class="o">)</span>
</pre></div>
</div>
<p>Please note that a factory is necessary to achieve reusability of the resulting <tt class="xref py py-class docutils literal"><span class="pre">Flow</span></tt>.</p>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
      <li><a href="http://akka.io/downloads">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@lightbend.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../../_static/akka_icon_reverse.svg" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2015 <a href="http://www.lightbend.com/">Lightbend Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Sep 30, 2016
    </p>
  </div>
</div>
<script type="text/javascript">
  var $toc = $('#toc');
  $toc.toc();

  // show clickable section sign when section header hovered:
  $('.section h2,.section h3,.section h4,.section h5').each(function(i, el) {
      var $el = $(el);
      $el.prepend($("<a class='section-marker' href='#" + $el.attr("id") + "'>&sect;</a>"))
  });
</script>

<!-- Algolia docs search -->
<script type="text/javascript">
  var version = DOCUMENTATION_OPTIONS.VERSION;

  var lang = "scala";
  var path = window.location.pathname;
  if (path.includes("/java/") || path.includes("java.html")) lang = "java";

  console.log("Search configured for:", lang, "@", version);

  docsearch({
    apiKey: '543bad5ad786495d9ccd445ed34ed082',
    indexName: 'akka_io',
    inputSelector: '#search',
    algoliaOptions: {
      hitsPerPage: 5,
      facetFilters: '[' + '["language:' + lang + '","language:general"]' + ',"version:' + version + '"]'
    }
  });

  // set up "/" as global shortcut for focusing on search
  $(document).keypress(function (event) {
    if (event.keyCode == 47) {
      $("#q").focus();
      return false; // swallow key event, otherwise the / char would be input into the search box
    }
  });
</script>

  

  </body>
</html>