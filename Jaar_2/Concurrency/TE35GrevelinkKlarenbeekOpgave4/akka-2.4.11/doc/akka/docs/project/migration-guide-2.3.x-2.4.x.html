


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Migration Guide 2.3.x to 2.4.x &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.4.11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <script type="text/javascript" src="../_static/warnOldDocs.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Migration Guides" href="migration-guides.html" />
    <link rel="next" title="Upcoming Migration Guide 2.4.x to 2.5.x" href="migration-guide-2.4.x-2.5.x.html" />
    <link rel="prev" title="Migration Guide Eventsourced to Akka Persistence 2.3.x" href="migration-guide-eventsourced-2.3.x.html" />


  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img class="svg-logo" src="../_static/akka_full_color.svg" /></a>
        </div>
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
          <li><a href="http://akka.io/downloads">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>
          <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Migration Guide 2.3.x to 2.4.x</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">
              <li>
                 <span class="divider">|</span> <a href="migration-guide-2.4.x-2.5.x.html">Upcoming Migration Guide 2.4.x to 2.5.x</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../java.html">Java Contents</a> <span class="divider">|</span> <a href="../scala.html">Scala Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="migration-guide-eventsourced-2.3.x.html">Migration Guide Eventsourced to Akka Persistence 2.3.x</a> <span class="divider">|</span>
              </li>
              <li style="float: left">
                Version 2.4.11
              </li>
              <li style="float: left">
                <input type="search" id="search" class="form-control" />
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="migration-guide-2-3-x-to-2-4-x">
<span id="migration-2-4"></span><h1>Migration Guide 2.3.x to 2.4.x</h1>
<p>The 2.4 release contains some structural changes that require some
simple, mechanical source-level changes in client code.</p>
<p>When migrating from earlier versions you should first follow the instructions for
migrating <a class="reference internal" href="migration-guide-1.3.x-2.0.x.html#migration-2-0"><em>1.3.x to 2.0.x</em></a> and then <a class="reference internal" href="migration-guide-2.0.x-2.1.x.html#migration-2-1"><em>2.0.x to 2.1.x</em></a>
and then <a class="reference internal" href="migration-guide-2.1.x-2.2.x.html#migration-2-2"><em>2.1.x to 2.2.x</em></a> and then <a class="reference internal" href="migration-guide-2.2.x-2.3.x.html#migration-2-3"><em>2.2.x to 2.3.x</em></a>.</p>
<div class="section" id="binary-compatibility">
<h2>Binary Compatibility</h2>
<p>Akka 2.4.x is backwards binary compatible with previous 2.3.x versions apart from the following
exceptions. This means that the new JARs are a drop-in replacement for the old one
(but not the other way around) as long as your build does not enable the inliner (Scala-only restriction).</p>
<p>The following parts are not binary compatible with 2.3.x:</p>
<ul class="simple">
<li>akka-testkit and akka-remote-testkit</li>
<li>experimental modules, such as akka-persistence and akka-contrib</li>
<li>features, classes, methods that were deprecated in 2.3.x and removed in 2.4.x</li>
</ul>
<p>The dependency to <strong>Netty</strong> has been updated from version 3.8.0.Final to 3.10.3.Final. The changes in
those versions might not be fully binary compatible, but we believe that it will not be a problem
in practice. No changes were needed to the Akka source code for this update. Users of libraries that
depend on 3.8.0.Final that break with 3.10.3.Final should be able to manually downgrade the dependency
to 3.8.0.Final and Akka will still work with that version.</p>
</div>
<div class="section" id="advanced-notice-typedactors-will-go-away">
<h2>Advanced Notice: TypedActors will go away</h2>
<p>While technically not yet deprecated, the current <tt class="docutils literal"><span class="pre">akka.actor.TypedActor</span></tt> support will be superseded by
the <a class="reference internal" href="../scala/typed.html#typed-scala"><em>Akka Typed</em></a> project that is currently being developed in open preview mode. If you are using TypedActors
in your projects you are advised to look into this, as it is superior to the Active Object pattern expressed
in TypedActors. The generic ActorRefs in Akka Typed allow the same type-safety that is afforded by
TypedActors while retaining all the other benefits of an explicit actor model (including the ability to
change behaviors etc.).</p>
<p>It is likely that TypedActors will be officially deprecated in the next major update of Akka and subsequently removed.</p>
</div>
<div class="section" id="removed-deprecated-features">
<h2>Removed Deprecated Features</h2>
<p>The following, previously deprecated, features have been removed:</p>
<ul>
<li><p class="first">akka-dataflow</p>
</li>
<li><p class="first">akka-transactor</p>
</li>
<li><p class="first">durable mailboxes (akka-mailboxes-common, akka-file-mailbox)</p>
</li>
<li><p class="first">Cluster.publishCurrentClusterState</p>
</li>
<li><p class="first">akka.cluster.auto-down, replaced by akka.cluster.auto-down-unreachable-after in Akka 2.3</p>
</li>
<li><p class="first">Old routers and configuration.</p>
<p>Note that in router configuration you must now specify if it is a <tt class="docutils literal"><span class="pre">pool</span></tt> or a <tt class="docutils literal"><span class="pre">group</span></tt>
in the way that was introduced in Akka 2.3.</p>
</li>
<li><p class="first">Timeout constructor without unit</p>
</li>
<li><p class="first">JavaLoggingEventHandler, replaced by JavaLogger</p>
</li>
<li><p class="first">UntypedActorFactory</p>
</li>
<li><p class="first">Java API TestKit.dilated, moved to JavaTestKit.dilated</p>
</li>
</ul>
</div>
<div class="section" id="protobuf-dependency">
<h2>Protobuf Dependency</h2>
<p>The transitive dependency to Protobuf has been removed to make it possible to use any version
of Protobuf for the application messages. If you use Protobuf in your application you need
to add the following dependency with desired version number:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="s">&quot;com.google.protobuf&quot;</span> <span class="o">%</span> <span class="s">&quot;protobuf-java&quot;</span> <span class="o">%</span> <span class="s">&quot;2.5.0&quot;</span>
</pre></div>
</div>
<p>Internally Akka is using an embedded version of protobuf that corresponds to <tt class="docutils literal"><span class="pre">com.google.protobuf/protobuf-java</span></tt>
version 2.5.0. The package name of the embedded classes has been changed to <tt class="docutils literal"><span class="pre">akka.protobuf</span></tt>.</p>
</div>
<div class="section" id="added-parameter-validation-to-rootactorpath">
<h2>Added parameter validation to RootActorPath</h2>
<p>Previously <tt class="docutils literal"><span class="pre">akka.actor.RootActorPath</span></tt> allowed passing in arbitrary strings into its name parameter,
which is meant to be the <em>name</em> of the root Actor. Subsequently, if constructed with an invalid name
such as a full path for example (<tt class="docutils literal"><span class="pre">/user/Full/Path</span></tt>) some features using this path may transparently fail -
such as using <tt class="docutils literal"><span class="pre">actorSelection</span></tt> on such invalid path.</p>
<p>In Akka 2.4.x the <tt class="docutils literal"><span class="pre">RootActorPath</span></tt> validates the input and may throw an <tt class="docutils literal"><span class="pre">IllegalArgumentException</span></tt> if
the passed in name string is illegal (contains <tt class="docutils literal"><span class="pre">/</span></tt> elsewhere than in the begining of the string or contains <tt class="docutils literal"><span class="pre">#</span></tt>).</p>
</div>
<div class="section" id="testkit-remaining-throws-assertionerror">
<h2>TestKit.remaining throws AssertionError</h2>
<p>In earlier versions of Akka <cite>TestKit.remaining</cite> returned the default timeout configurable under
&quot;akka.test.single-expect-default&quot;. This was a bit confusing and thus it has been changed to throw an
AssertionError if called outside of within. The old behavior however can still be achieved by
calling <cite>TestKit.remainingOrDefault</cite> instead.</p>
</div>
<div class="section" id="eventstream-and-managedactorclassification-eventbus-now-require-an-actorsystem">
<h2>EventStream and ManagedActorClassification EventBus now require an ActorSystem</h2>
<p>Both the <tt class="docutils literal"><span class="pre">EventStream</span></tt> (<a class="reference internal" href="../scala/event-bus.html#event-stream-scala"><em>Scala</em></a>, <a class="reference internal" href="../java/event-bus.html#event-stream-java"><em>Java</em></a>) and the
<tt class="docutils literal"><span class="pre">ManagedActorClassification</span></tt>, <tt class="docutils literal"><span class="pre">ManagedActorEventBus</span></tt> (<a class="reference internal" href="../scala/event-bus.html#actor-classification-scala"><em>Scala</em></a>, <a class="reference internal" href="../java/event-bus.html#actor-classification-java"><em>Java</em></a>) now
require an <tt class="docutils literal"><span class="pre">ActorSystem</span></tt> to properly operate. The reason for that is moving away from stateful internal lifecycle checks
to a fully reactive model for unsubscribing actors that have <tt class="docutils literal"><span class="pre">Terminated</span></tt>. Therefore the <tt class="docutils literal"><span class="pre">ActorClassification</span></tt>
and <tt class="docutils literal"><span class="pre">ActorEventBus</span></tt> was deprecated and replaced by <tt class="docutils literal"><span class="pre">ManagedActorClassification</span></tt> and <tt class="docutils literal"><span class="pre">ManagedActorEventBus</span></tt></p>
<p>If you have implemented a custom event bus, you will need to pass in the actor system through the constructor now:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.event.ActorEventBus</span>
<span class="k">import</span> <span class="nn">akka.event.ManagedActorClassification</span>
<span class="k">import</span> <span class="nn">akka.event.ActorClassifier</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Notification</span><span class="o">(</span><span class="n">ref</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ActorBusImpl</span><span class="o">(</span><span class="k">val</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ActorEventBus</span> <span class="k">with</span> <span class="nc">ActorClassifier</span> <span class="k">with</span> <span class="nc">ManagedActorClassification</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">Event</span> <span class="o">=</span> <span class="nc">Notification</span>

  <span class="c1">// is used for extracting the classifier from the incoming events</span>
  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="n">classify</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">Event</span><span class="o">)</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ref</span>

  <span class="c1">// determines the initial size of the index data structure</span>
  <span class="c1">// used internally (i.e. the expected number of different classifiers)</span>
  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="n">mapSize</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">128</span>
<span class="o">}</span>
</pre></div>
</div>
<p>If you have been creating EventStreams manually, you now have to provide an actor system and <em>start the unsubscriber</em>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">bus</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">EventStream</span><span class="o">(</span><span class="n">system</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
<span class="n">bus</span><span class="o">.</span><span class="n">startUnsubscriber</span><span class="o">()</span>
</pre></div>
</div>
<p>Please note that this change affects you only if you have implemented your own buses, Akka's own <tt class="docutils literal"><span class="pre">context.eventStream</span></tt>
is still there and does not require any attention from you concerning this change.</p>
</div>
<div class="section" id="fsm-notifies-on-same-state-transitions">
<h2>FSM notifies on same state transitions</h2>
<p>When changing states in an Finite-State-Machine Actor (<tt class="docutils literal"><span class="pre">FSM</span></tt>), state transition events are emitted and can be handled by the user
either by registering <tt class="docutils literal"><span class="pre">onTransition</span></tt> handlers or by subscribing to these events by sending it an <tt class="docutils literal"><span class="pre">SubscribeTransitionCallBack</span></tt> message.</p>
<p>Previously in <tt class="docutils literal"><span class="pre">2.3.x</span></tt> when an <tt class="docutils literal"><span class="pre">FSM</span></tt> was in state <tt class="docutils literal"><span class="pre">A</span></tt> and performed a <tt class="docutils literal"><span class="pre">goto(A)</span></tt> transition, no state transition notification would be sent.
This is because it would effectively stay in the same state, and was deemed to be semantically equivalent to calling <tt class="docutils literal"><span class="pre">stay()</span></tt>.</p>
<p>In <tt class="docutils literal"><span class="pre">2.4.x</span></tt> when an <tt class="docutils literal"><span class="pre">FSM</span></tt> performs an any <tt class="docutils literal"><span class="pre">goto(X)</span></tt> transition, it will always trigger state transition events.
Which turns out to be useful in many systems where same-state transitions actually should have an effect.</p>
<p>In case you do <em>not</em> want to trigger a state transition event when effectively performing an <tt class="docutils literal"><span class="pre">X-&gt;X</span></tt> transition, use <tt class="docutils literal"><span class="pre">stay()</span></tt> instead.</p>
</div>
<div class="section" id="circuit-breaker-timeout-change">
<h2>Circuit Breaker Timeout Change</h2>
<p>In <tt class="docutils literal"><span class="pre">2.3.x</span></tt> calls protected by the <tt class="docutils literal"><span class="pre">CircuitBreaker</span></tt> were allowed to run indefinitely and the check to see if the timeout had been exceeded was done after the call had returned.</p>
<p>In <tt class="docutils literal"><span class="pre">2.4.x</span></tt> the failureCount of the Breaker will be increased as soon as the timeout is reached and a <tt class="docutils literal"><span class="pre">Failure[TimeoutException]</span></tt> will be returned immediately for asynchronous calls. Synchronous calls will now throw a <tt class="docutils literal"><span class="pre">TimeoutException</span></tt> after the call is finished.</p>
</div>
<div class="section" id="slf4j-logging-filter">
<h2>Slf4j logging filter</h2>
<p>If you use <tt class="docutils literal"><span class="pre">Slf4jLogger</span></tt> you should add the following configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">logging</span><span class="o">-</span><span class="n">filter</span> <span class="k">=</span> <span class="s">&quot;akka.event.slf4j.Slf4jLoggingFilter&quot;</span>
</pre></div>
</div>
<p>It will filter the log events using the backend configuration (e.g. logback.xml) before
they are published to the event bus.</p>
</div>
<div class="section" id="inbox-receive-java-api">
<h2>Inbox.receive Java API</h2>
<p><tt class="docutils literal"><span class="pre">Inbox.receive</span></tt> now throws a checked <tt class="docutils literal"><span class="pre">java.util.concurrent.TimeoutException</span></tt> exception if the receive timeout
is reached.</p>
</div>
<div class="section" id="pool-routers-nrofinstances-method-now-takes-actorsystem">
<h2>Pool routers nrOfInstances method now takes ActorSystem</h2>
<p>In order to make cluster routers smarter about when they can start local routees,
<tt class="docutils literal"><span class="pre">nrOfInstances</span></tt> defined on <tt class="docutils literal"><span class="pre">Pool</span></tt> now takes <tt class="docutils literal"><span class="pre">ActorSystem</span></tt> as an argument.
In case you have implemented a custom Pool you will have to update the method's signature,
however the implementation can remain the same if you don't need to rely on an ActorSystem in your logic.</p>
</div>
<div class="section" id="group-routers-paths-method-now-takes-actorsystem">
<h2>Group routers paths method now takes ActorSystem</h2>
<p>In order to make cluster routers smarter about when they can start local routees,
<tt class="docutils literal"><span class="pre">paths</span></tt> defined on <tt class="docutils literal"><span class="pre">Group</span></tt> now takes <tt class="docutils literal"><span class="pre">ActorSystem</span></tt> as an argument.
In case you have implemented a custom Group you will have to update the method's signature,
however the implementation can remain the same if you don't need to rely on an ActorSystem in your logic.</p>
</div>
<div class="section" id="cluster-aware-router-max-total-nr-of-instances">
<h2>Cluster aware router max-total-nr-of-instances</h2>
<p>In 2.3.x the deployment configuration property <tt class="docutils literal"><span class="pre">nr-of-instances</span></tt> was used for
cluster aware routers to specify total number of routees in the cluster.
This was confusing, especially since the default value is 1.</p>
<p>In 2.4.x there is a new deployement property <tt class="docutils literal"><span class="pre">cluster.max-total-nr-of-instances</span></tt> that
defines total number of routees in the cluster. By default <tt class="docutils literal"><span class="pre">max-total-nr-of-instances</span></tt>
is set to a high value (10000) that will result in new routees added to the router when nodes join the cluster.
Set it to a lower value if you want to limit total number of routees.</p>
<p>For backwards compatibility reasons <tt class="docutils literal"><span class="pre">nr-of-instances</span></tt> is still used if defined by user,
i.e. if defined it takes precedence over <tt class="docutils literal"><span class="pre">max-total-nr-of-instances</span></tt>.</p>
</div>
<div class="section" id="logger-names-use-full-class-name">
<h2>Logger names use full class name</h2>
<p>Previously, few places in Akka used &quot;simple&quot; logger names, such as <tt class="docutils literal"><span class="pre">Cluster</span></tt> or <tt class="docutils literal"><span class="pre">Remoting</span></tt>.
Now they use full class names, such as <tt class="docutils literal"><span class="pre">akka.cluster.Cluster</span></tt> or <tt class="docutils literal"><span class="pre">akka.remote.Remoting</span></tt>,
in order to allow package level log level definitions and ease source code lookup.
In case you used specific &quot;simple&quot; logger name based rules in your <tt class="docutils literal"><span class="pre">logback.xml</span></tt> configurations,
please change them to reflect appropriate package name, such as
<tt class="docutils literal"><span class="pre">&lt;logger</span> <span class="pre">name='akka.cluster'</span> <span class="pre">level='warn'</span> <span class="pre">/&gt;</span></tt> or <tt class="docutils literal"><span class="pre">&lt;logger</span> <span class="pre">name='akka.remote'</span> <span class="pre">level='error'</span> <span class="pre">/&gt;</span></tt></p>
</div>
<div class="section" id="default-interval-for-testkit-awaitassert-changed-to-100-ms">
<h2>Default interval for TestKit.awaitAssert changed to 100 ms</h2>
<p>Default check interval changed from 800 ms to 100 ms. You can define the interval explicitly if you need a
longer interval.</p>
</div>
<div class="section" id="secure-cookies">
<h2>Secure Cookies</h2>
<p><cite>Secure cookies</cite> feature was deprecated.</p>
</div>
<div class="section" id="aes128counterinetrng-and-aes256counterinetrng-are-deprecated">
<h2>AES128CounterInetRNG and AES256CounterInetRNG are Deprecated</h2>
<p>Use <tt class="docutils literal"><span class="pre">AES128CounterSecureRNG</span></tt> or <tt class="docutils literal"><span class="pre">AES256CounterSecureRNG</span></tt> as
<tt class="docutils literal"><span class="pre">akka.remote.netty.ssl.security.random-number-generator</span></tt>.</p>
</div>
<div class="section" id="microkernel-is-deprecated">
<h2>Microkernel is Deprecated</h2>
<p>Akka Microkernel is deprecated and will be removed. It is replaced by using an ordinary
user defined main class and packaging with <a class="reference external" href="https://github.com/sbt/sbt-native-packager">sbt-native-packager</a>
or <a class="reference external" href="http://www.lightbend.com/products/conductr">Lightbend ConductR</a>.
Please see <a class="reference internal" href="../intro/deployment-scenarios.html#deployment-scenarios"><em>Use-case and Deployment Scenarios</em></a> for more information.</p>
</div>
<div class="section" id="new-cluster-metrics-extension">
<h2>New Cluster Metrics Extension</h2>
<p>Previously, cluster metrics functionality was located in the <tt class="docutils literal"><span class="pre">akka-cluster</span></tt> jar.
Now it is split out and moved into a separate Akka module: <tt class="docutils literal"><span class="pre">akka-cluster-metrics</span></tt> jar.
The module comes with few enhancements, such as use of Kamon sigar-loader
for native library provisioning as well as use of statistical averaging of metrics data.
Note that both old and new metrics configuration entries in the <tt class="docutils literal"><span class="pre">reference.conf</span></tt>
are still in the same name space <tt class="docutils literal"><span class="pre">akka.cluster.metrics</span></tt> but are not compatible.
Make sure to disable legacy metrics in akka-cluster: <tt class="docutils literal"><span class="pre">akka.cluster.metrics.enabled=off</span></tt>,
since it is still enabled in akka-cluster by default (for compatibility with past releases).
Router configuration entries have also changed for the module, they use prefix <tt class="docutils literal"><span class="pre">cluster-metrics-</span></tt>:
<tt class="docutils literal"><span class="pre">cluster-metrics-adaptive-pool</span></tt> and <tt class="docutils literal"><span class="pre">cluster-metrics-adaptive-group</span></tt>
Metrics extension classes and objects are located in the new package <tt class="docutils literal"><span class="pre">akka.cluster.metrics</span></tt>.
Please see <a class="reference internal" href="../scala/cluster-metrics.html#cluster-metrics-scala"><em>Scala</em></a>, <a class="reference internal" href="../java/cluster-metrics.html#cluster-metrics-java"><em>Java</em></a> for more information.</p>
</div>
<div class="section" id="cluster-tools-moved-to-separate-module">
<h2>Cluster tools moved to separate module</h2>
<p>The Cluster Singleton, Distributed Pub-Sub, and Cluster Client previously located in the <tt class="docutils literal"><span class="pre">akka-contrib</span></tt>
jar is now moved to a separate module named <tt class="docutils literal"><span class="pre">akka-cluster-tools</span></tt>. You need to replace this dependency
if you use any of these tools.</p>
<p>The classes changed package name from <tt class="docutils literal"><span class="pre">akka.contrib.pattern</span></tt> to <tt class="docutils literal"><span class="pre">akka.cluster.singleton</span></tt>, <tt class="docutils literal"><span class="pre">akka.cluster.pubsub</span></tt>
and <tt class="docutils literal"><span class="pre">akka.cluster.client</span></tt>.</p>
<p>The configuration properties changed name to <tt class="docutils literal"><span class="pre">akka.cluster.pub-sub</span></tt> and <tt class="docutils literal"><span class="pre">akka.cluster.client</span></tt>.</p>
</div>
<div class="section" id="cluster-sharding-moved-to-separate-module">
<h2>Cluster sharding moved to separate module</h2>
<p>The Cluster Sharding previously located in the <tt class="docutils literal"><span class="pre">akka-contrib</span></tt> jar is now moved to a separate module
named <tt class="docutils literal"><span class="pre">akka-cluster-sharding</span></tt>. You need to replace this dependency if you use Cluster Sharding.</p>
<p>The classes changed package name from <tt class="docutils literal"><span class="pre">akka.contrib.pattern</span></tt> to <tt class="docutils literal"><span class="pre">akka.cluster.sharding</span></tt>.</p>
<p>The configuration properties changed name to <tt class="docutils literal"><span class="pre">akka.cluster.sharding</span></tt>.</p>
</div>
<div class="section" id="clustersharding-construction">
<h2>ClusterSharding construction</h2>
<p>Several parameters of the <tt class="docutils literal"><span class="pre">start</span></tt> method of the <tt class="docutils literal"><span class="pre">ClusterSharding</span></tt> extension are now defined
in a settings object <tt class="docutils literal"><span class="pre">ClusterShardingSettings</span></tt>.
It can be created from system configuration properties and also amended with API.
These settings can be defined differently per entry type if needed.</p>
<p>Starting the <tt class="docutils literal"><span class="pre">ShardRegion</span></tt> in proxy mode is now done with the <tt class="docutils literal"><span class="pre">startProxy</span></tt> method
of the <tt class="docutils literal"><span class="pre">ClusterSharding</span></tt> extension instead of the optional <tt class="docutils literal"><span class="pre">entryProps</span></tt> parameter.</p>
<p>Entry was renamed to Entity, for example in the <tt class="docutils literal"><span class="pre">MessagesExtractor</span></tt> in the Java API
and the <tt class="docutils literal"><span class="pre">EntityId</span></tt> type in the Scala API.</p>
<p><tt class="docutils literal"><span class="pre">idExtractor</span></tt> function was renamed to <tt class="docutils literal"><span class="pre">extractEntityId</span></tt>. <tt class="docutils literal"><span class="pre">shardResolver</span></tt> function
was renamed to <tt class="docutils literal"><span class="pre">extractShardId</span></tt>.</p>
</div>
<div class="section" id="cluster-sharding-entry-path-change">
<h2>Cluster Sharding Entry Path Change</h2>
<p>Previously in <tt class="docutils literal"><span class="pre">2.3.x</span></tt> entries were direct children of the local <tt class="docutils literal"><span class="pre">ShardRegion</span></tt>. In examples the <tt class="docutils literal"><span class="pre">persistenceId</span></tt> of entries
included <tt class="docutils literal"><span class="pre">self.path.parent.name</span></tt> to include the cluster type name.</p>
<p>In <tt class="docutils literal"><span class="pre">2.4.x</span></tt> entries are now children of a <tt class="docutils literal"><span class="pre">Shard</span></tt>, which in turn is a child of the local <tt class="docutils literal"><span class="pre">ShardRegion</span></tt>. To include the shard
type in the <tt class="docutils literal"><span class="pre">persistenceId</span></tt> it is now accessed by <tt class="docutils literal"><span class="pre">self.path.parent.parent.name</span></tt> from each entry.</p>
</div>
<div class="section" id="asynchronous-shardallocationstrategy">
<h2>Asynchronous ShardAllocationStrategy</h2>
<p>The methods of the <tt class="docutils literal"><span class="pre">ShardAllocationStrategy</span></tt> and <tt class="docutils literal"><span class="pre">AbstractShardAllocationStrategy</span></tt> in Cluster Sharding
have changed return type to a <tt class="docutils literal"><span class="pre">Future</span></tt> to support asynchronous decision. For example you can ask an
actor external actor of how to allocate shards or rebalance shards.</p>
<p>For the synchronous case you can return the result via <tt class="docutils literal"><span class="pre">scala.concurrent.Future.successful</span></tt> in Scala or
<tt class="docutils literal"><span class="pre">akka.dispatch.Futures.successful</span></tt> in Java.</p>
</div>
<div class="section" id="cluster-sharding-internal-data">
<h2>Cluster Sharding internal data</h2>
<p>The Cluster Sharding coordinator stores the locations of the shards using Akka Persistence.
This data can safely be removed when restarting the whole Akka Cluster.</p>
<p>The serialization format of the internal persistent events stored by the Cluster Sharding coordinator
has been changed and it cannot load old data from 2.3.x or some 2.4 milestone.</p>
<p>The <tt class="docutils literal"><span class="pre">persistenceId</span></tt> of the Cluster Sharding coordinator has been changed since 2.3.x so
it should not load such old data, but it can be a problem if you have used a 2.4
milestone release. In that case you should remove the persistent data that the
Cluster Sharding coordinator stored. Note that this is not application data.</p>
<p>You can use the <a class="reference internal" href="../scala/cluster-sharding.html#removeinternalclustershardingdata-scala"><em>RemoveInternalClusterShardingData</em></a>
utility program to remove this data.</p>
<p>The new <tt class="docutils literal"><span class="pre">persistenceId</span></tt> is <tt class="docutils literal"><span class="pre">s&quot;/sharding/${typeName}Coordinator&quot;</span></tt>.
The old <tt class="docutils literal"><span class="pre">persistenceId</span></tt> is <tt class="docutils literal"><span class="pre">s&quot;/user/sharding/${typeName}Coordinator/singleton/coordinator&quot;</span></tt>.</p>
</div>
<div class="section" id="clustersingletonmanager-and-clustersingletonproxy-construction">
<h2>ClusterSingletonManager and ClusterSingletonProxy construction</h2>
<p>Parameters to the <tt class="docutils literal"><span class="pre">Props</span></tt> factory methods have been moved to settings object <tt class="docutils literal"><span class="pre">ClusterSingletonManagerSettings</span></tt>
and <tt class="docutils literal"><span class="pre">ClusterSingletonProxySettings</span></tt>. These can be created from system configuration properties and also
amended with API as needed.</p>
<p>The buffer size of the <tt class="docutils literal"><span class="pre">ClusterSingletonProxy</span></tt> can be defined in the <tt class="docutils literal"><span class="pre">ClusterSingletonProxySettings</span></tt>
instead of defining <tt class="docutils literal"><span class="pre">stash-capacity</span></tt> of the mailbox. Buffering can be disabled by using a
buffer size of 0.</p>
<p>The <tt class="docutils literal"><span class="pre">singletonPath</span></tt> parameter of <tt class="docutils literal"><span class="pre">ClusterSingletonProxy.props</span></tt> has changed. It is now named
<tt class="docutils literal"><span class="pre">singletonManagerPath</span></tt> and is the logical path of the singleton manager, e.g. <tt class="docutils literal"><span class="pre">/user/singletonManager</span></tt>,
which ends with the name you defined in <tt class="docutils literal"><span class="pre">actorOf</span></tt> when creating the <tt class="docutils literal"><span class="pre">ClusterSingletonManager</span></tt>.
In 2.3.x it was the path to singleton instance, which was error-prone because one had to provide both
the name of the singleton manager and the singleton actor.</p>
</div>
<div class="section" id="distributedpubsub-construction">
<h2>DistributedPubSub construction</h2>
<p>Normally, the <tt class="docutils literal"><span class="pre">DistributedPubSubMediator</span></tt> actor is started by the <tt class="docutils literal"><span class="pre">DistributedPubSubExtension</span></tt>.
This extension has been renamed to <tt class="docutils literal"><span class="pre">DistributedPubSub</span></tt>. It is also possible to start
it as an ordinary actor if you need multiple instances of it with different settings.
The parameters of the <tt class="docutils literal"><span class="pre">Props</span></tt> factory methods in the <tt class="docutils literal"><span class="pre">DistributedPubSubMediator</span></tt> companion
has been moved to settings object <tt class="docutils literal"><span class="pre">DistributedPubSubSettings</span></tt>. This can be created from
system configuration properties and also amended with API as needed.</p>
</div>
<div class="section" id="clusterclient-construction">
<h2>ClusterClient construction</h2>
<p>The parameters of the <tt class="docutils literal"><span class="pre">Props</span></tt> factory methods in the <tt class="docutils literal"><span class="pre">ClusterClient</span></tt> companion
has been moved to settings object <tt class="docutils literal"><span class="pre">ClusterClientSettings</span></tt>. This can be created from
system configuration properties and also amended with API as needed.</p>
<p>The buffer size of the <tt class="docutils literal"><span class="pre">ClusterClient</span></tt> can be defined in the <tt class="docutils literal"><span class="pre">ClusterClientSettings</span></tt>
instead of defining <tt class="docutils literal"><span class="pre">stash-capacity</span></tt> of the mailbox. Buffering can be disabled by using a
buffer size of 0.</p>
<p>Normally, the <tt class="docutils literal"><span class="pre">ClusterReceptionist</span></tt> actor is started by the <tt class="docutils literal"><span class="pre">ClusterReceptionistExtension</span></tt>.
This extension has been renamed to <tt class="docutils literal"><span class="pre">ClusterClientReceptionist</span></tt>. It is also possible to start
it as an ordinary actor if you need multiple instances of it with different settings.
The parameters of the <tt class="docutils literal"><span class="pre">Props</span></tt> factory methods in the <tt class="docutils literal"><span class="pre">ClusterReceptionist</span></tt> companion
has been moved to settings object <tt class="docutils literal"><span class="pre">ClusterReceptionistSettings</span></tt>. This can be created from
system configuration properties and also amended with API as needed.</p>
<p>The <tt class="docutils literal"><span class="pre">ClusterReceptionist</span></tt> actor that is started by the <tt class="docutils literal"><span class="pre">ClusterReceptionistExtension</span></tt>
is now started as a <tt class="docutils literal"><span class="pre">system</span></tt> actor instead of a <tt class="docutils literal"><span class="pre">user</span></tt> actor, i.e. the default path for
the <tt class="docutils literal"><span class="pre">ClusterClient</span></tt> initial contacts has changed to
<tt class="docutils literal"><span class="pre">&quot;akka.tcp://system&#64;hostname:port/system/receptionist&quot;</span></tt>.</p>
</div>
<div class="section" id="clusterclient-sender">
<h2>ClusterClient sender</h2>
<p>In 2.3 the <tt class="docutils literal"><span class="pre">sender()</span></tt> of the response messages, as seen by the client, was the
actor in cluster.</p>
<p>In 2.4 the <tt class="docutils literal"><span class="pre">sender()</span></tt> of the response messages, as seen by the client, is <tt class="docutils literal"><span class="pre">deadLetters</span></tt>
since the client should normally send subsequent messages via the <tt class="docutils literal"><span class="pre">ClusterClient</span></tt>.
It is possible to pass the original sender inside the reply messages if
the client is supposed to communicate directly to the actor in the cluster.</p>
</div>
<div class="section" id="akka-persistence">
<h2>Akka Persistence</h2>
<div class="section" id="experimental-removed">
<h3>Experimental removed</h3>
<p>The artifact name has changed from <tt class="docutils literal"><span class="pre">akka-persistence-experimental</span></tt> to <tt class="docutils literal"><span class="pre">akka-persistence</span></tt>.</p>
<p>New sbt dependency:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="s">&quot;com.typesafe.akka&quot;</span> <span class="o">%%</span> <span class="s">&quot;akka-persistence&quot;</span> <span class="o">%</span> <span class="s">&quot;2.4.11&quot;</span>
</pre></div>
</div>
<p>New Maven dependency:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="n">typesafe</span><span class="o">.</span><span class="n">akka</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">akka</span><span class="o">-</span><span class="n">persistence_2</span><span class="o">.</span><span class="mi">11</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">11</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The artefact name of the Persistent TCK has changed from <tt class="docutils literal"><span class="pre">akka-persistence-tck-experimental</span></tt> (<tt class="docutils literal"><span class="pre">akka-persistence-experimental-tck</span></tt>) to
<tt class="docutils literal"><span class="pre">akka-persistence-tck</span></tt>.</p>
</div>
<div class="section" id="mandatory-persistenceid">
<h3>Mandatory persistenceId</h3>
<p>It is now mandatory to define the <tt class="docutils literal"><span class="pre">persistenceId</span></tt> in subclasses of <tt class="docutils literal"><span class="pre">PersistentActor</span></tt>, <tt class="docutils literal"><span class="pre">UntypedPersistentActor</span></tt>
and <tt class="docutils literal"><span class="pre">AbstractPersistentId</span></tt>.</p>
<p>The rationale behind this change being stricter de-coupling of your Actor hierarchy and the logical
&quot;which persistent entity this actor represents&quot;.</p>
<p>In case you want to preserve the old behavior of providing the actor's path as the default <tt class="docutils literal"><span class="pre">persistenceId</span></tt>, you can easily
implement it yourself either as a helper trait or simply by overriding <tt class="docutils literal"><span class="pre">persistenceId</span></tt> as follows:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">override</span> <span class="k">def</span> <span class="n">persistenceId</span> <span class="k">=</span> <span class="n">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">toStringWithoutAddress</span>
</pre></div>
</div>
</div>
<div class="section" id="failures">
<h3>Failures</h3>
<p>Backend journal failures during recovery and persist are treated differently than in 2.3.x. The <tt class="docutils literal"><span class="pre">PersistenceFailure</span></tt>
message is removed and the actor is unconditionally stopped. The new behavior and reasons for it is explained in
<a class="reference internal" href="../scala/persistence.html#failures-scala"><em>Failures</em></a>.</p>
</div>
<div class="section" id="persist-sequence-of-events">
<h3>Persist sequence of events</h3>
<p>The <tt class="docutils literal"><span class="pre">persist</span></tt> method that takes a <tt class="docutils literal"><span class="pre">Seq</span></tt> (Scala) or <tt class="docutils literal"><span class="pre">Iterable</span></tt> (Java) of events parameter was deprecated and
renamed to <tt class="docutils literal"><span class="pre">persistAll</span></tt> to avoid mistakes of persisting other collection types as one single event by calling
the overloaded <tt class="docutils literal"><span class="pre">persist(event)</span></tt> method.</p>
</div>
<div class="section" id="non-permanent-deletion">
<h3>non-permanent deletion</h3>
<p>The <tt class="docutils literal"><span class="pre">permanent</span></tt> flag in <tt class="docutils literal"><span class="pre">deleteMessages</span></tt> was removed. non-permanent deletes are not supported
any more. Events that were deleted with <tt class="docutils literal"><span class="pre">permanent=false</span></tt> with older version will
still not be replayed in this version.</p>
</div>
<div class="section" id="recover-message-is-gone-replaced-by-recovery-config">
<h3>Recover message is gone, replaced by Recovery config</h3>
<p>Previously the way to cause recover in PersistentActors was sending them a <tt class="docutils literal"><span class="pre">Recover()</span></tt> message.
Most of the time it was the actor itself sending such message to <tt class="docutils literal"><span class="pre">self</span></tt> in its <tt class="docutils literal"><span class="pre">preStart</span></tt> method,
however it was possible to send this message from an external source to any <tt class="docutils literal"><span class="pre">PersistentActor</span></tt> or <tt class="docutils literal"><span class="pre">PresistentView</span></tt>
to make it start recovering.</p>
<p>This style of starting recovery does not fit well with usual Actor best practices: an Actor should be independent
and know about its internal state, and also about its recovery or lack thereof. In order to guide users towards
more independent Actors, the <tt class="docutils literal"><span class="pre">Recovery()</span></tt> object is now not used as a message, but as configuration option
used by the Actor when it starts. In order to migrate previous code which customised its recovery mode use this example
as reference:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// previously</span>
<span class="k">class</span> <span class="nc">OldCookieMonster</span> <span class="k">extends</span> <span class="nc">PersistentActor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">preStart</span><span class="o">()</span> <span class="k">=</span> <span class="n">self</span> <span class="o">!</span> <span class="nc">Recover</span><span class="o">(</span><span class="n">toSequenceNr</span> <span class="k">=</span> <span class="mi">42L</span><span class="o">)</span>
  <span class="c1">// ...</span>
<span class="o">}</span>
<span class="c1">// now:</span>
<span class="k">class</span> <span class="nc">NewCookieMonster</span> <span class="k">extends</span> <span class="nc">PersistentActor</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">recovery</span> <span class="k">=</span> <span class="nc">Recovery</span><span class="o">(</span><span class="n">toSequenceNr</span> <span class="k">=</span> <span class="mi">42L</span><span class="o">)</span>
  <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="sender-reference-of-replayed-events-is-deadletters">
<h3>Sender reference of replayed events is deadLetters</h3>
<p>While undocumented, previously the <tt class="docutils literal"><span class="pre">sender()</span></tt> of the replayed messages would be the same sender that originally had
sent the message. Since sender is an <tt class="docutils literal"><span class="pre">ActorRef</span></tt> and those events are often replayed in different incarnations of
actor systems and during the entire lifetime of the app, relying on the existence of this reference is most likely
not going to succeed. In order to avoid bugs in the style of &quot;it worked last week&quot;, the <tt class="docutils literal"><span class="pre">sender()</span></tt> reference is now not
stored, in order to avoid potential bugs which this could have provoked.</p>
<p>The previous behaviour was never documented explicitly (nor was it a design goal), so it is unlikely that applications
have explicitly relied on this behaviour, however if you find yourself with an application that did exploit this you
should rewrite it to explicitly store the <tt class="docutils literal"><span class="pre">ActorPath</span></tt> of where such replies during replay may have to be sent to,
instead of relying on the sender reference during replay.</p>
</div>
<div class="section" id="max-message-batch-size-config">
<h3>max-message-batch-size config</h3>
<p>Configuration property <tt class="docutils literal"><span class="pre">akka.persistence.journal.max-message-batch-size</span></tt> has been moved into the plugin configuration
section, to allow different values for different journal plugins. See <tt class="docutils literal"><span class="pre">reference.conf</span></tt>.</p>
</div>
<div class="section" id="akka-persistence-snapshot-store-plugin-config">
<h3>akka.persistence.snapshot-store.plugin config</h3>
<p>The configuration property <tt class="docutils literal"><span class="pre">akka.persistence.snapshot-store.plugin</span></tt> now by default is empty. To restore the previous
setting add <tt class="docutils literal"><span class="pre">akka.persistence.snapshot-store.plugin</span> <span class="pre">=</span> <span class="pre">&quot;akka.persistence.snapshot-store.local&quot;</span></tt> to your application.conf.
See <tt class="docutils literal"><span class="pre">reference.conf</span></tt>.</p>
</div>
<div class="section" id="persistentview-is-deprecated">
<h3>PersistentView is deprecated</h3>
<p><tt class="docutils literal"><span class="pre">PersistentView</span></tt> is deprecated. Use <a class="reference internal" href="../scala/persistence-query.html#persistence-query-scala"><em>Persistence Query</em></a> instead. The corresponding
query type is <tt class="docutils literal"><span class="pre">EventsByPersistenceId</span></tt>. There are several alternatives for connecting the <tt class="docutils literal"><span class="pre">Source</span></tt>
to an actor corresponding to a previous <tt class="docutils literal"><span class="pre">PersistentView</span></tt> actor:</p>
<ul class="simple">
<li><a class="reference external" href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0/scala/stream-integrations.html#Sink_actorRef">Sink.actorRef</a> is simple, but has the disadvantage that there is no back-pressure signal from the
destination actor, i.e. if the actor is not consuming the messages fast enough the mailbox of the actor will grow</li>
<li><a class="reference external" href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0/stages-overview.html#Asynchronous_processing_stages">mapAsync</a> combined with <a class="reference internal" href="../java/lambda-actors.html#actors-ask-lambda"><em>Ask: Send-And-Receive-Future</em></a> is almost as simple with the advantage of back-pressure
being propagated all the way</li>
<li><a class="reference external" href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0/scala/stream-integrations.html#ActorSubscriber">ActorSubscriber</a> in case you need more fine grained control</li>
</ul>
<p>The consuming actor may be a plain <tt class="docutils literal"><span class="pre">Actor</span></tt> or a <tt class="docutils literal"><span class="pre">PersistentActor</span></tt> if it needs to store its
own state (e.g. fromSequenceNr offset).</p>
</div>
</div>
<div class="section" id="persistence-plugin-apis">
<h2>Persistence Plugin APIs</h2>
<div class="section" id="syncwritejournal-removed">
<h3>SyncWriteJournal removed</h3>
<p><tt class="docutils literal"><span class="pre">SyncWriteJournal</span></tt> removed in favor of using <tt class="docutils literal"><span class="pre">AsyncWriteJournal</span></tt>.</p>
<p>If the storage backend API only supports synchronous, blocking writes,
the methods can still be implemented in terms of the asynchronous API.
Example of how to do that is in included in the
See <a class="reference internal" href="../scala/persistence.html#journal-plugin-api"><em>Journal plugin API for Scala</em></a>
or <a class="reference internal" href="../java/persistence.html#journal-plugin-api-java"><em>Journal plugin API for Java</em></a>.</p>
</div>
<div class="section" id="snapshotstore-snapshots-can-now-be-deleted-asynchronously-and-report-failures">
<h3>SnapshotStore: Snapshots can now be deleted asynchronously (and report failures)</h3>
<p>Previously the <tt class="docutils literal"><span class="pre">SnapshotStore</span></tt> plugin SPI did not allow for asynchronous deletion of snapshots,
and failures of deleting a snapshot may have been even silently ignored.</p>
<p>Now <tt class="docutils literal"><span class="pre">SnapshotStore</span></tt> must return a <tt class="docutils literal"><span class="pre">Future</span></tt> representing the deletion of the snapshot.
If this future completes successfully the <tt class="docutils literal"><span class="pre">PersistentActor</span></tt> which initiated the snapshotting will
be notified via an <tt class="docutils literal"><span class="pre">DeleteSnapshotSuccess</span></tt> message. If the deletion fails for some reason a <tt class="docutils literal"><span class="pre">DeleteSnapshotFailure</span></tt>
will be sent to the actor instead.</p>
<p>For <tt class="docutils literal"><span class="pre">criteria</span></tt> based deletion of snapshots (<tt class="docutils literal"><span class="pre">def</span> <span class="pre">deleteSnapshots(criteria:</span> <span class="pre">SnapshotSelectionCriteria)</span></tt>) equivalent
<tt class="docutils literal"><span class="pre">DeleteSnapshotsSuccess</span></tt> and <tt class="docutils literal"><span class="pre">DeleteSnapshotsFailure</span></tt> messages are sent, which contain the specified criteria,
instead of <tt class="docutils literal"><span class="pre">SnapshotMetadata</span></tt> as is the case with the single snapshot deletion messages.</p>
</div>
<div class="section" id="snapshotstore-removed-saved-callback">
<h3>SnapshotStore: Removed 'saved' callback</h3>
<p>Snapshot Stores previously were required to implement a <tt class="docutils literal"><span class="pre">def</span> <span class="pre">saved(meta:</span> <span class="pre">SnapshotMetadata):</span> <span class="pre">Unit</span></tt> method which
would be called upon successful completion of a <tt class="docutils literal"><span class="pre">saveAsync</span></tt> (<tt class="docutils literal"><span class="pre">doSaveAsync</span></tt> in Java API) snapshot write.</p>
<p>Currently all journals and snapshot stores perform asynchronous writes and deletes, thus all could potentially benefit
from such callback methods. The only gain these callback give over composing an <tt class="docutils literal"><span class="pre">onComplete</span></tt> over <tt class="docutils literal"><span class="pre">Future</span></tt> returned
by the journal or snapshot store is that it is executed in the Actors context, thus it can safely (without additional
synchronization modify its internal state - for example a &quot;pending writes&quot; counter).</p>
<p>However, this feature was not used by many plugins, and expanding the API to accomodate all callbacks would have grown
the API a lot. Instead, Akka Persistence 2.4.x introduces an additional (optionally overrideable)
<tt class="docutils literal"><span class="pre">receivePluginInternal:Actor.Receive</span></tt> method in the plugin API, which can be used for handling those as well as any custom messages
that are sent to the plugin Actor (imagine use cases like &quot;wake up and continue reading&quot; or custom protocols which your
specialised journal can implement).</p>
<p>Implementations using the previous feature should adjust their code as follows:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// previously</span>
<span class="k">class</span> <span class="nc">MySnapshots</span> <span class="k">extends</span> <span class="nc">SnapshotStore</span> <span class="o">{</span>
  <span class="c1">// old API:</span>
  <span class="c1">// def saved(meta: SnapshotMetadata): Unit = doThings()</span>

  <span class="c1">// new API:</span>
  <span class="k">def</span> <span class="n">saveAsync</span><span class="o">(</span><span class="n">metadata</span><span class="k">:</span> <span class="kt">SnapshotMetadata</span><span class="o">,</span> <span class="n">snapshot</span><span class="k">:</span> <span class="kt">Any</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
     <span class="c1">// completion or failure of the returned future triggers internal messages in receivePluginInternal</span>
     <span class="k">val</span> <span class="n">f</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

     <span class="c1">// custom messages can be piped to self in order to be received in receivePluginInternal</span>
     <span class="n">f</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">MyCustomMessage</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="n">pipeTo</span> <span class="n">self</span>

     <span class="n">f</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">receivePluginInternal</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">SaveSnapshotSuccess</span><span class="o">(</span><span class="n">metadata</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">doThings</span><span class="o">()</span>
    <span class="k">case</span> <span class="nc">MyCustomMessage</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>         <span class="k">=&gt;</span> <span class="n">doOtherThings</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="snapshotstore-java-8-optional-used-in-java-plugin-apis">
<h3>SnapshotStore: Java 8 Optional used in Java plugin APIs</h3>
<p>In places where previously <tt class="docutils literal"><span class="pre">akka.japi.Option</span></tt> was used in Java APIs, including the return type of <tt class="docutils literal"><span class="pre">doLoadAsync</span></tt>,
the Java 8 provided <tt class="docutils literal"><span class="pre">Optional</span></tt> type is used now.</p>
<p>Please remember that when creating an <tt class="docutils literal"><span class="pre">java.util.Optional</span></tt> instance from a (possibly) <tt class="docutils literal"><span class="pre">null</span></tt> value you will want to
use the non-throwing <tt class="docutils literal"><span class="pre">Optional.fromNullable</span></tt> method, which converts a <tt class="docutils literal"><span class="pre">null</span></tt> into a <tt class="docutils literal"><span class="pre">None</span></tt> value - which is
slightly different than its Scala counterpart (where <tt class="docutils literal"><span class="pre">Option.apply(null)</span></tt> returns <tt class="docutils literal"><span class="pre">None</span></tt>).</p>
</div>
<div class="section" id="atomic-writes">
<h3>Atomic writes</h3>
<p><tt class="docutils literal"><span class="pre">asyncWriteMessages</span></tt> takes a <tt class="docutils literal"><span class="pre">immutable.Seq[AtomicWrite]</span></tt> parameter instead of
<tt class="docutils literal"><span class="pre">immutable.Seq[PersistentRepr]</span></tt>.</p>
<p>Each <cite>AtomicWrite</cite> message contains the single <tt class="docutils literal"><span class="pre">PersistentRepr</span></tt> that corresponds to the event that was
passed to the <tt class="docutils literal"><span class="pre">persist</span></tt> method of the <tt class="docutils literal"><span class="pre">PersistentActor</span></tt>, or it contains several <tt class="docutils literal"><span class="pre">PersistentRepr</span></tt>
that corresponds to the events that were passed to the <tt class="docutils literal"><span class="pre">persistAll</span></tt> method of the <tt class="docutils literal"><span class="pre">PersistentActor</span></tt>.
All <tt class="docutils literal"><span class="pre">PersistentRepr</span></tt> of the <cite>AtomicWrite</cite> must be written to the data store atomically, i.e. all or
none must be stored.</p>
<p>If the journal (data store) cannot support atomic writes of multiple events it should
reject such writes with a <tt class="docutils literal"><span class="pre">Try</span></tt> <tt class="docutils literal"><span class="pre">Failure</span></tt> with an <tt class="docutils literal"><span class="pre">UnsupportedOperationException</span></tt>
describing the issue. This limitation should also be documented by the journal plugin.</p>
</div>
<div class="section" id="rejecting-writes">
<h3>Rejecting writes</h3>
<p><tt class="docutils literal"><span class="pre">asyncWriteMessages</span></tt> returns a <tt class="docutils literal"><span class="pre">Future[immutable.Seq[Try[Unit]]]</span></tt>.</p>
<p>The journal can signal that it rejects individual messages (<tt class="docutils literal"><span class="pre">AtomicWrite</span></tt>) by the returned
<cite>immutable.Seq[Try[Unit]]</cite>. The returned <tt class="docutils literal"><span class="pre">Seq</span></tt> must have as many elements as the input
<tt class="docutils literal"><span class="pre">messages</span></tt> <tt class="docutils literal"><span class="pre">Seq</span></tt>. Each <tt class="docutils literal"><span class="pre">Try</span></tt> element signals if the corresponding <tt class="docutils literal"><span class="pre">AtomicWrite</span></tt>
is rejected or not, with an exception describing the problem. Rejecting a message means it
was not stored, i.e. it must not be included in a later replay. Rejecting a message is
typically done before attempting to store it, e.g. because of serialization error.</p>
<p>Read the <a class="reference internal" href="../scala/persistence.html#journal-plugin-api"><em>API documentation</em></a> of this method for more
information about the semantics of rejections and failures.</p>
</div>
<div class="section" id="asyncreplaymessages-java-api">
<h3>asyncReplayMessages Java API</h3>
<p>The signature of <cite>asyncReplayMessages</cite> in the Java API changed from <tt class="docutils literal"><span class="pre">akka.japi.Procedure</span></tt>
to <tt class="docutils literal"><span class="pre">java.util.function.Consumer</span></tt>.</p>
</div>
<div class="section" id="asyncdeletemessagesto">
<h3>asyncDeleteMessagesTo</h3>
<p>The <tt class="docutils literal"><span class="pre">permanent</span></tt> deletion flag was removed. Support for non-permanent deletions was
removed. Events that were deleted with <tt class="docutils literal"><span class="pre">permanent=false</span></tt> with older version will
still not be replayed in this version.</p>
</div>
<div class="section" id="references-to-replay-in-names">
<h3>References to &quot;replay&quot; in names</h3>
<p>Previously a number of classes and methods used the word &quot;replay&quot; interchangeably with the word &quot;recover&quot;.
This lead to slight inconsistencies in APIs, where a method would be called <tt class="docutils literal"><span class="pre">recovery</span></tt>, yet the
signal for a completed recovery was named <tt class="docutils literal"><span class="pre">ReplayMessagesSuccess</span></tt>.</p>
<p>This is now fixed, and all methods use the same &quot;recovery&quot; wording consistently across the entire API.
The old <tt class="docutils literal"><span class="pre">ReplayMessagesSuccess</span></tt> is now called <tt class="docutils literal"><span class="pre">RecoverySuccess</span></tt>, and an additional method called <tt class="docutils literal"><span class="pre">onRecoveryFailure</span></tt>
has been introduced.</p>
</div>
<div class="section" id="atleastoncedelivery-deliver-signature">
<h3>AtLeastOnceDelivery deliver signature</h3>
<p>The signature of <tt class="docutils literal"><span class="pre">deliver</span></tt> changed slightly in order to allow both <tt class="docutils literal"><span class="pre">ActorSelection</span></tt> and <tt class="docutils literal"><span class="pre">ActorPath</span></tt> to be
used with it.</p>
<p>Previously:</p>
<blockquote>
<div>def deliver(destination: ActorPath, deliveryIdToMessage: Long ⇒ Any): Unit</div></blockquote>
<p>Now:</p>
<blockquote>
<div>def deliver(destination: ActorSelection)(deliveryIdToMessage: Long ⇒ Any): Unit
def deliver(destination: ActorPath)(deliveryIdToMessage: Long ⇒ Any): Unit</div></blockquote>
<p>The Java API remains unchanged and has simply gained the 2nd overload which allows <tt class="docutils literal"><span class="pre">ActorSelection</span></tt> to be
passed in directly (without converting to <tt class="docutils literal"><span class="pre">ActorPath</span></tt>).</p>
</div>
<div class="section" id="actor-system-shutdown">
<h3>Actor system shutdown</h3>
<p><tt class="docutils literal"><span class="pre">ActorSystem.shutdown</span></tt>, <tt class="docutils literal"><span class="pre">ActorSystem.awaitTermination</span></tt> and <tt class="docutils literal"><span class="pre">ActorSystem.isTerminated</span></tt> has been
deprecated in favor of <tt class="docutils literal"><span class="pre">ActorSystem.terminate</span></tt> and <tt class="docutils literal"><span class="pre">ActorSystem.whenTerminated`</span></tt>. Both returns a
<tt class="docutils literal"><span class="pre">Future[Terminated]</span></tt> value that will complete when the actor system has terminated.</p>
<p>To get the same behavior as <tt class="docutils literal"><span class="pre">ActorSystem.awaitTermination</span></tt> block and wait for <tt class="docutils literal"><span class="pre">Future[Terminated]</span></tt> value
with <tt class="docutils literal"><span class="pre">Await.result</span></tt> from the Scala standard library.</p>
<p>To trigger a termination and wait for it to complete:</p>
<blockquote>
<div>import scala.concurrent.duration._
Await.result(system.terminate(), 10.seconds)</div></blockquote>
<p>Be careful to not do any operations on the <tt class="docutils literal"><span class="pre">Future[Terminated]</span></tt> using the <tt class="docutils literal"><span class="pre">system.dispatcher</span></tt>
as <tt class="docutils literal"><span class="pre">ExecutionContext</span></tt> as it will be shut down with the <tt class="docutils literal"><span class="pre">ActorSystem</span></tt>, instead use for example
the Scala standard library context from <tt class="docutils literal"><span class="pre">scala.concurrent.ExecutionContext.global</span></tt>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// import system.dispatcher &lt;- this would not work</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>

<span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">().</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;Actor system was shut down&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
      <li><a href="http://akka.io/downloads">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@lightbend.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/akka_icon_reverse.svg" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2015 <a href="http://www.lightbend.com/">Lightbend Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Sep 30, 2016
    </p>
  </div>
</div>
<script type="text/javascript">
  var $toc = $('#toc');
  $toc.toc();

  // show clickable section sign when section header hovered:
  $('.section h2,.section h3,.section h4,.section h5').each(function(i, el) {
      var $el = $(el);
      $el.prepend($("<a class='section-marker' href='#" + $el.attr("id") + "'>&sect;</a>"))
  });
</script>

<!-- Algolia docs search -->
<script type="text/javascript">
  var version = DOCUMENTATION_OPTIONS.VERSION;

  var lang = "scala";
  var path = window.location.pathname;
  if (path.includes("/java/") || path.includes("java.html")) lang = "java";

  console.log("Search configured for:", lang, "@", version);

  docsearch({
    apiKey: '543bad5ad786495d9ccd445ed34ed082',
    indexName: 'akka_io',
    inputSelector: '#search',
    algoliaOptions: {
      hitsPerPage: 5,
      facetFilters: '[' + '["language:' + lang + '","language:general"]' + ',"version:' + version + '"]'
    }
  });

  // set up "/" as global shortcut for focusing on search
  $(document).keypress(function (event) {
    if (event.keyCode == 47) {
      $("#q").focus();
      return false; // swallow key event, otherwise the / char would be input into the search box
    }
  });
</script>

  

  </body>
</html>