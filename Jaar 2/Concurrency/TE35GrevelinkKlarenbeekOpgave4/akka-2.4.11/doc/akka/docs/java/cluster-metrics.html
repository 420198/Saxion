


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cluster Metrics Extension &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.4.11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <script type="text/javascript" src="../_static/warnOldDocs.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Networking" href="index-network.html" />
    <link rel="next" title="Distributed Data" href="distributed-data.html" />
    <link rel="prev" title="Cluster Sharding" href="cluster-sharding.html" />


  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img class="svg-logo" src="../_static/akka_full_color.svg" /></a>
        </div>
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
          <li><a href="http://akka.io/downloads">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>
          <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Cluster Metrics Extension</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">
              <li>
                 <span class="divider">|</span> <a href="distributed-data.html">Distributed Data</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../java.html">Java Contents</a> <span class="divider">|</span> <a href="../scala.html">Scala Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="cluster-sharding.html">Cluster Sharding</a> <span class="divider">|</span>
              </li>
              <li style="float: left">
                Version 2.4.11
              </li>
              <li style="float: left">
                <input type="search" id="search" class="form-control" />
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="cluster-metrics-extension">
<span id="cluster-metrics-java"></span><h1>Cluster Metrics Extension</h1>
<div class="section" id="introduction">
<h2>Introduction</h2>
<p>The member nodes of the cluster can collect system health metrics and publish that to other cluster nodes
and to the registered subscribers on the system event bus with the help of Cluster Metrics Extension.</p>
<p>Cluster metrics information is primarily used for load-balancing routers,
and can also be used to implement advanced metrics-based node life cycles,
such as &quot;Node Let-it-crash&quot; when CPU steal time becomes excessive.</p>
<p>Cluster Metrics Extension is a separate Akka module delivered in <tt class="docutils literal"><span class="pre">akka-cluster-metrics</span></tt> jar.</p>
<p>To enable usage of the extension you need to add the following dependency to your project:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="n">typesafe</span><span class="o">.</span><span class="n">akka</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">akka</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">metrics_2</span><span class="o">.</span><span class="mi">11</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">11</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and add the following configuration stanza to your <tt class="docutils literal"><span class="pre">application.conf</span></tt></p>
<div class="highlight-scala"><pre>akka.extensions = [ "akka.cluster.metrics.ClusterMetricsExtension" ]</pre>
</div>
<p>Make sure to disable legacy metrics in akka-cluster: <tt class="docutils literal"><span class="pre">akka.cluster.metrics.enabled=off</span></tt>,
since it is still enabled in akka-cluster by default (for compatibility with past releases).</p>
<p>Cluster members with status <a class="reference internal" href="cluster-usage.html#weakly-up-java"><em>WeaklyUp</em></a>, if that feature is enabled,
will participate in Cluster Metrics collection and dissemination.</p>
</div>
<div class="section" id="metrics-collector">
<h2>Metrics Collector</h2>
<p>Metrics collection is delegated to an implementation of <tt class="docutils literal"><span class="pre">akka.cluster.metrics.MetricsCollector</span></tt>.</p>
<p>Different collector implementations provide different subsets of metrics published to the cluster.
Certain message routing and let-it-crash functions may not work when Sigar is not provisioned.</p>
<p>Cluster metrics extension comes with two built-in collector implementations:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">akka.cluster.metrics.SigarMetricsCollector</span></tt>, which requires Sigar provisioning, and is more rich/precise</li>
<li><tt class="docutils literal"><span class="pre">akka.cluster.metrics.JmxMetricsCollector</span></tt>, which is used as fall back, and is less rich/precise</li>
</ol>
<p>You can also plug-in your own metrics collector implementation.</p>
<p>By default, metrics extension will use collector provider fall back and will try to load them in this order:</p>
<ol class="arabic simple">
<li>configured user-provided collector</li>
<li>built-in <tt class="docutils literal"><span class="pre">akka.cluster.metrics.SigarMetricsCollector</span></tt></li>
<li>and finally <tt class="docutils literal"><span class="pre">akka.cluster.metrics.JmxMetricsCollector</span></tt></li>
</ol>
</div>
<div class="section" id="metrics-events">
<h2>Metrics Events</h2>
<p>Metrics extension periodically publishes current snapshot of the cluster metrics to the node system event bus.</p>
<p>The publication period is controlled by the <tt class="docutils literal"><span class="pre">akka.cluster.metrics.collector.sample-period</span></tt> setting.</p>
<p>The payload of the <tt class="docutils literal"><span class="pre">akka.cluster.metrics.ClusterMetricsChanged</span></tt> event will contain
latest metrics of the node as well as other cluster member nodes metrics gossip
which was received during the collector sample period.</p>
<p>You can subscribe your metrics listener actors to these events in order to implement custom node lifecycle</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ClusterMetricsExtension</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">subscribe</span><span class="o">(</span><span class="n">metricsListenerActor</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="hyperic-sigar-provisioning">
<h2>Hyperic Sigar Provisioning</h2>
<p>Both user-provided and built-in metrics collectors can optionally use <a class="reference external" href="http://www.hyperic.com/products/sigar">Hyperic Sigar</a>
for a wider and more accurate range of metrics compared to what can be retrieved from ordinary JMX MBeans.</p>
<p>Sigar is using a native o/s library, and requires library provisioning, i.e.
deployment, extraction and loading of the o/s native library into JVM at runtime.</p>
<p>User can provision Sigar classes and native library in one of the following ways:</p>
<ol class="arabic simple">
<li>Use <a class="reference external" href="https://github.com/kamon-io/sigar-loader">Kamon sigar-loader</a> as a project dependency for the user project.
Metrics extension will extract and load sigar library on demand with help of Kamon sigar provisioner.</li>
<li>Use <a class="reference external" href="https://github.com/kamon-io/sigar-loader">Kamon sigar-loader</a> as java agent: <tt class="docutils literal"><span class="pre">java</span> <span class="pre">-javaagent:/path/to/sigar-loader.jar</span></tt>.
Kamon sigar loader agent will extract and load sigar library during JVM start.</li>
<li>Place <tt class="docutils literal"><span class="pre">sigar.jar</span></tt> on the <tt class="docutils literal"><span class="pre">classpath</span></tt> and Sigar native library for the o/s on the <tt class="docutils literal"><span class="pre">java.library.path</span></tt>.
User is required to manage both project dependency and library deployment manually.</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">When using <a class="reference external" href="https://github.com/kamon-io/sigar-loader">Kamon sigar-loader</a> and running multiple
instances of the same application on the same host, you have to make sure that sigar library is extracted to a
unique per instance directory. You can control the extract directory with the
<tt class="docutils literal"><span class="pre">akka.cluster.metrics.native-library-extract-folder</span></tt> configuration setting.</p>
</div>
<p>To enable usage of Sigar you can add the following dependency to the user project</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">io</span><span class="o">.</span><span class="n">kamon</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">sigar</span><span class="o">-</span><span class="n">loader</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">6</span><span class="o">-</span><span class="n">rev002</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>You can download Kamon sigar-loader from <a class="reference external" href="http://search.maven.org/#search%7Cga%7C1%7Csigar-loader">Maven Central</a></p>
</div>
<div class="section" id="adaptive-load-balancing">
<h2>Adaptive Load Balancing</h2>
<p>The <tt class="docutils literal"><span class="pre">AdaptiveLoadBalancingPool</span></tt> / <tt class="docutils literal"><span class="pre">AdaptiveLoadBalancingGroup</span></tt> performs load balancing of messages to cluster nodes based on the cluster metrics data.
It uses random selection of routees with probabilities derived from the remaining capacity of the corresponding node.
It can be configured to use a specific MetricsSelector to produce the probabilities, a.k.a. weights:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">heap</span></tt> / <tt class="docutils literal"><span class="pre">HeapMetricsSelector</span></tt> - Used and max JVM heap memory. Weights based on remaining heap capacity; (max - used) / max</li>
<li><tt class="docutils literal"><span class="pre">load</span></tt> / <tt class="docutils literal"><span class="pre">SystemLoadAverageMetricsSelector</span></tt> - System load average for the past 1 minute, corresponding value can be found in <tt class="docutils literal"><span class="pre">top</span></tt> of Linux systems. The system is possibly nearing a bottleneck if the system load average is nearing number of cpus/cores. Weights based on remaining load capacity; 1 - (load / processors)</li>
<li><tt class="docutils literal"><span class="pre">cpu</span></tt> / <tt class="docutils literal"><span class="pre">CpuMetricsSelector</span></tt> - CPU utilization in percentage, sum of User + Sys + Nice + Wait. Weights based on remaining cpu capacity; 1 - utilization</li>
<li><tt class="docutils literal"><span class="pre">mix</span></tt> / <tt class="docutils literal"><span class="pre">MixMetricsSelector</span></tt> - Combines heap, cpu and load. Weights based on mean of remaining capacity of the combined selectors.</li>
<li>Any custom implementation of <tt class="docutils literal"><span class="pre">akka.cluster.metrics.MetricsSelector</span></tt></li>
</ul>
<p>The collected metrics values are smoothed with <a class="reference external" href="http://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average">exponential weighted moving average</a>. In the <a class="reference internal" href="cluster-usage.html#cluster-configuration-java"><em>Configuration</em></a> you can adjust how quickly past data is decayed compared to new data.</p>
<p>Let's take a look at this router in action. What can be more demanding than calculating factorials?</p>
<p>The backend worker that performs the factorial calculation:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">FactorialBackend</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="n">instanceof</span> <span class="nc">Integer</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">final</span> <span class="nc">Integer</span> <span class="n">n</span> <span class="k">=</span> <span class="o">(</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
      <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">BigInteger</span><span class="o">&gt;</span> <span class="n">f</span> <span class="k">=</span> <span class="n">future</span><span class="o">(</span><span class="k">new</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">BigInteger</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="n">public</span> <span class="nc">BigInteger</span> <span class="n">call</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">factorial</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">},</span> <span class="n">getContext</span><span class="o">().</span><span class="n">dispatcher</span><span class="o">());</span>

      <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">FactorialResult</span><span class="o">&gt;</span> <span class="n">result</span> <span class="k">=</span> <span class="n">f</span><span class="o">.</span><span class="n">map</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Mapper</span><span class="o">&lt;</span><span class="nc">BigInteger</span><span class="o">,</span> <span class="nc">FactorialResult</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="n">public</span> <span class="nc">FactorialResult</span> <span class="n">apply</span><span class="o">(</span><span class="nc">BigInteger</span> <span class="n">factorial</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span> <span class="k">new</span> <span class="nc">FactorialResult</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">factorial</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">},</span> <span class="n">getContext</span><span class="o">().</span><span class="n">dispatcher</span><span class="o">());</span>

      <span class="n">pipe</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="n">dispatcher</span><span class="o">()).</span><span class="n">to</span><span class="o">(</span><span class="n">getSender</span><span class="o">());</span>

    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">unhandled</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nc">BigInteger</span> <span class="n">factorial</span><span class="o">(</span><span class="n">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">BigInteger</span> <span class="n">acc</span> <span class="k">=</span> <span class="nc">BigInteger</span><span class="o">.</span><span class="nc">ONE</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">acc</span> <span class="k">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">multiply</span><span class="o">(</span><span class="nc">BigInteger</span><span class="o">.</span><span class="n">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The frontend that receives user jobs and delegates to the backends via the router:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">FactorialFrontend</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
  <span class="k">final</span> <span class="n">int</span> <span class="n">upToN</span><span class="o">;</span>
  <span class="k">final</span> <span class="n">boolean</span> <span class="n">repeat</span><span class="o">;</span>

  <span class="nc">LoggingAdapter</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">.</span><span class="n">getLogger</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>

  <span class="nc">ActorRef</span> <span class="n">backend</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">getInstance</span><span class="o">().</span><span class="n">props</span><span class="o">(),</span>
      <span class="s">&quot;factorialBackendRouter&quot;</span><span class="o">);</span>

  <span class="n">public</span> <span class="nc">FactorialFrontend</span><span class="o">(</span><span class="n">int</span> <span class="n">upToN</span><span class="o">,</span> <span class="n">boolean</span> <span class="n">repeat</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">upToN</span> <span class="k">=</span> <span class="n">upToN</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">repeat</span> <span class="k">=</span> <span class="n">repeat</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">preStart</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">sendJobs</span><span class="o">();</span>
    <span class="n">getContext</span><span class="o">().</span><span class="n">setReceiveTimeout</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">SECONDS</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="n">instanceof</span> <span class="nc">FactorialResult</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">FactorialResult</span> <span class="n">result</span> <span class="k">=</span> <span class="o">(</span><span class="nc">FactorialResult</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="n">upToN</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="s">&quot;{}! = {}&quot;</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="n">n</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="n">factorial</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">repeat</span><span class="o">)</span>
          <span class="n">sendJobs</span><span class="o">();</span>
        <span class="k">else</span>
          <span class="n">getContext</span><span class="o">().</span><span class="n">stop</span><span class="o">(</span><span class="n">getSelf</span><span class="o">());</span>
      <span class="o">}</span>

    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="n">instanceof</span> <span class="nc">ReceiveTimeout</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Timeout&quot;</span><span class="o">);</span>
      <span class="n">sendJobs</span><span class="o">();</span>

    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">unhandled</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">void</span> <span class="n">sendJobs</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Starting batch of factorials up to [{}]&quot;</span><span class="o">,</span> <span class="n">upToN</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">n</span> <span class="k">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">upToN</span><span class="o">;</span> <span class="n">n</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">backend</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>As you can see, the router is defined in the same way as other routers, and in this case it is configured as follows:</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /factorialFrontend/factorialBackendRouter = {
    # Router type provided by metrics extension. 
    router = cluster-metrics-adaptive-group
    # Router parameter specific for metrics extension.
    # metrics-selector = heap
    # metrics-selector = load
    # metrics-selector = cpu
    metrics-selector = mix
    #
    routees.paths = ["/user/factorialBackend"]
    cluster {
      enabled = on
      use-role = backend
      allow-local-routees = off
    }
  }
}
</pre>
</div>
<p>It is only <tt class="docutils literal"><span class="pre">router</span></tt> type and the <tt class="docutils literal"><span class="pre">metrics-selector</span></tt> parameter that is specific to this router,
other things work in the same way as other routers.</p>
<p>The same type of router could also have been defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">int</span> <span class="n">totalInstances</span> <span class="k">=</span> <span class="mi">100</span><span class="o">;</span>
<span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">routeesPaths</span> <span class="k">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="n">asList</span><span class="o">(</span><span class="s">&quot;/user/factorialBackend&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
<span class="n">boolean</span> <span class="n">allowLocalRoutees</span> <span class="k">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">useRole</span> <span class="k">=</span> <span class="s">&quot;backend&quot;</span><span class="o">;</span>
<span class="nc">ActorRef</span> <span class="n">backend</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="k">new</span> <span class="nc">ClusterRouterGroup</span><span class="o">(</span><span class="k">new</span> <span class="nc">AdaptiveLoadBalancingGroup</span><span class="o">(</span>
        <span class="nc">HeapMetricsSelector</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(),</span> <span class="nc">Collections</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">emptyList</span><span class="o">()),</span>
        <span class="k">new</span> <span class="nc">ClusterRouterGroupSettings</span><span class="o">(</span><span class="n">totalInstances</span><span class="o">,</span> <span class="n">routeesPaths</span><span class="o">,</span>
            <span class="n">allowLocalRoutees</span><span class="o">,</span> <span class="n">useRole</span><span class="o">)).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;factorialBackendRouter2&quot;</span><span class="o">);</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">int</span> <span class="n">totalInstances</span> <span class="k">=</span> <span class="mi">100</span><span class="o">;</span>
<span class="n">int</span> <span class="n">maxInstancesPerNode</span> <span class="k">=</span> <span class="mi">3</span><span class="o">;</span>
<span class="n">boolean</span> <span class="n">allowLocalRoutees</span> <span class="k">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">useRole</span> <span class="k">=</span> <span class="s">&quot;backend&quot;</span><span class="o">;</span>
<span class="nc">ActorRef</span> <span class="n">backend</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="k">new</span> <span class="nc">ClusterRouterPool</span><span class="o">(</span><span class="k">new</span> <span class="nc">AdaptiveLoadBalancingPool</span><span class="o">(</span>
        <span class="nc">SystemLoadAverageMetricsSelector</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(),</span> <span class="mi">0</span><span class="o">),</span>
        <span class="k">new</span> <span class="nc">ClusterRouterPoolSettings</span><span class="o">(</span><span class="n">totalInstances</span><span class="o">,</span> <span class="n">maxInstancesPerNode</span><span class="o">,</span>
            <span class="n">allowLocalRoutees</span><span class="o">,</span> <span class="n">useRole</span><span class="o">)).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span>
        <span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">FactorialBackend</span><span class="o">.</span><span class="n">class</span><span class="o">)),</span> <span class="s">&quot;factorialBackendRouter3&quot;</span><span class="o">);</span>
</pre></div>
</div>
<p>The <a class="reference external" href="http://www.lightbend.com/platform/getstarted">Lightbend Activator</a> tutorial named
<a class="reference external" href="http://www.lightbend.com/activator/template/akka-sample-cluster-java">Akka Cluster Samples with Java</a>.
contains the full source code and instructions of how to run the <strong>Adaptive Load Balancing</strong> sample.</p>
</div>
<div class="section" id="subscribe-to-metrics-events">
<h2>Subscribe to Metrics Events</h2>
<p>It is possible to subscribe to the metrics events directly to implement other functionality.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.UntypedActor</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.Cluster</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ClusterEvent.CurrentClusterState</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.metrics.ClusterMetricsChanged</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.metrics.NodeMetrics</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.metrics.StandardMetrics</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.metrics.StandardMetrics.HeapMemory</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.metrics.StandardMetrics.Cpu</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.metrics.ClusterMetricsExtension</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.event.Logging</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.event.LoggingAdapter</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">MetricsListener</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
  <span class="nc">LoggingAdapter</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">.</span><span class="n">getLogger</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>

  <span class="nc">Cluster</span> <span class="n">cluster</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">());</span>
  
  <span class="nc">ClusterMetricsExtension</span> <span class="n">extension</span> <span class="k">=</span> <span class="nc">ClusterMetricsExtension</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">());</span>

  
  <span class="c1">// Subscribe unto ClusterMetricsEvent events.</span>
  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">preStart</span><span class="o">()</span> <span class="o">{</span>
	  <span class="n">extension</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">getSelf</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="c1">// Unsubscribe from ClusterMetricsEvent events.</span>
  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">postStop</span><span class="o">()</span> <span class="o">{</span>
	  <span class="n">extension</span><span class="o">.</span><span class="n">unsubscribe</span><span class="o">(</span><span class="n">getSelf</span><span class="o">());</span>
  <span class="o">}</span>


  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="n">instanceof</span> <span class="nc">ClusterMetricsChanged</span><span class="o">)</span> <span class="o">{</span>
    	<span class="nc">ClusterMetricsChanged</span> <span class="n">clusterMetrics</span> <span class="k">=</span> <span class="o">(</span><span class="nc">ClusterMetricsChanged</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">NodeMetrics</span> <span class="n">nodeMetrics</span> <span class="k">:</span> <span class="kt">clusterMetrics.getNodeMetrics</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">nodeMetrics</span><span class="o">.</span><span class="n">address</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">selfAddress</span><span class="o">()))</span> <span class="o">{</span>
          <span class="n">logHeap</span><span class="o">(</span><span class="n">nodeMetrics</span><span class="o">);</span>
          <span class="n">logCpu</span><span class="o">(</span><span class="n">nodeMetrics</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>

    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="n">instanceof</span> <span class="nc">CurrentClusterState</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Ignore.</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">unhandled</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">void</span> <span class="n">logHeap</span><span class="o">(</span><span class="nc">NodeMetrics</span> <span class="n">nodeMetrics</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">HeapMemory</span> <span class="n">heap</span> <span class="k">=</span> <span class="nc">StandardMetrics</span><span class="o">.</span><span class="n">extractHeapMemory</span><span class="o">(</span><span class="n">nodeMetrics</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">heap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Used heap: {} MB&quot;</span><span class="o">,</span> <span class="o">((</span><span class="n">double</span><span class="o">)</span> <span class="n">heap</span><span class="o">.</span><span class="n">used</span><span class="o">())</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">void</span> <span class="n">logCpu</span><span class="o">(</span><span class="nc">NodeMetrics</span> <span class="n">nodeMetrics</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Cpu</span> <span class="n">cpu</span> <span class="k">=</span> <span class="nc">StandardMetrics</span><span class="o">.</span><span class="n">extractCpu</span><span class="o">(</span><span class="n">nodeMetrics</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cpu</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cpu</span><span class="o">.</span><span class="n">systemLoadAverage</span><span class="o">().</span><span class="n">isDefined</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Load: {} ({} processors)&quot;</span><span class="o">,</span> <span class="n">cpu</span><span class="o">.</span><span class="n">systemLoadAverage</span><span class="o">().</span><span class="n">get</span><span class="o">(),</span> 
        <span class="n">cpu</span><span class="o">.</span><span class="n">processors</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-metrics-collector">
<h2>Custom Metrics Collector</h2>
<p>Metrics collection is delegated to the implementation of <tt class="docutils literal"><span class="pre">akka.cluster.metrics.MetricsCollector</span></tt></p>
<p>You can plug-in your own metrics collector instead of built-in
<tt class="docutils literal"><span class="pre">akka.cluster.metrics.SigarMetricsCollector</span></tt> or <tt class="docutils literal"><span class="pre">akka.cluster.metrics.JmxMetricsCollector</span></tt>.</p>
<p>Look at those two implementations for inspiration.</p>
<p>Custom metrics collector implementation class must be specified in the
<tt class="docutils literal"><span class="pre">akka.cluster.metrics.collector.provider</span></tt> configuration property.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration</h2>
<p>The Cluster metrics extension can be configured with the following properties:</p>
<div class="highlight-scala"><pre>##############################################
# Akka Cluster Metrics Reference Config File #
##############################################

# This is the reference config file that contains all the default settings.
# Make your edits in your application.conf in order to override these settings.

# Sigar provisioning:
#
#  User can provision sigar classes and native library in one of the following ways:
# 
#  1) Use https://github.com/kamon-io/sigar-loader Kamon sigar-loader as a project dependency for the user project.
#  Metrics extension will extract and load sigar library on demand with help of Kamon sigar provisioner.
# 
#  2) Use https://github.com/kamon-io/sigar-loader Kamon sigar-loader as java agent: `java -javaagent:/path/to/sigar-loader.jar`
#  Kamon sigar loader agent will extract and load sigar library during JVM start.
# 
#  3) Place `sigar.jar` on the `classpath` and sigar native library for the o/s on the `java.library.path`
#  User is required to manage both project dependency and library deployment manually.

# Cluster metrics extension.
# Provides periodic statistics collection and publication throughout the cluster.
akka.cluster.metrics {
    # Full path of dispatcher configuration key.
    # Use "" for default key `akka.actor.default-dispatcher`.
    dispatcher = ""
    # How long should any actor wait before starting the periodic tasks.
    periodic-tasks-initial-delay = 1s
    # Sigar native library extract location.
    # Use per-application-instance scoped location, such as program working directory.
    native-library-extract-folder = ${user.dir}"/native"
    # Metrics supervisor actor.
    supervisor {
        # Actor name. Example name space: /system/cluster-metrics
        name = "cluster-metrics"
        # Supervision strategy.
        strategy {
            #
            # FQCN of class providing `akka.actor.SupervisorStrategy`.
            # Must have a constructor with signature `&lt;init&gt;(com.typesafe.config.Config)`.
            # Default metrics strategy provider is a configurable extension of `OneForOneStrategy`.
            provider = "akka.cluster.metrics.ClusterMetricsStrategy"
            #
            # Configuration of the default strategy provider.
            # Replace with custom settings when overriding the provider.
            configuration = {
                # Log restart attempts.
                loggingEnabled = true
                # Child actor restart-on-failure window.
                withinTimeRange = 3s
                # Maximum number of restart attempts before child actor is stopped.
                maxNrOfRetries = 3
            }
        }
    }
    # Metrics collector actor.
    collector {
        # Enable or disable metrics collector for load-balancing nodes.
        # Metrics collection can also be controlled at runtime by sending control messages
        # to /system/cluster-metrics actor: `akka.cluster.metrics.{CollectionStartMessage,CollectionStopMessage}`
        enabled = on
        # FQCN of the metrics collector implementation.
        # It must implement `akka.cluster.metrics.MetricsCollector` and
        # have public constructor with akka.actor.ActorSystem parameter.
        # Will try to load in the following order of priority: 
        # 1) configured custom collector 2) internal `SigarMetricsCollector` 3) internal `JmxMetricsCollector`
        provider = ""
        # Try all 3 available collector providers, or else fail on the configured custom collector provider.
        fallback = true
        # How often metrics are sampled on a node.
        # Shorter interval will collect the metrics more often.
        # Also controls frequency of the metrics publication to the node system event bus. 
        sample-interval = 3s
        # How often a node publishes metrics information to the other nodes in the cluster.
        # Shorter interval will publish the metrics gossip more often.
        gossip-interval = 3s
        # How quickly the exponential weighting of past data is decayed compared to
        # new data. Set lower to increase the bias toward newer values.
        # The relevance of each data sample is halved for every passing half-life
        # duration, i.e. after 4 times the half-life, a data sample’s relevance is
        # reduced to 6% of its original relevance. The initial relevance of a data
        # sample is given by 1 – 0.5 ^ (collect-interval / half-life).
        # See http://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average
        moving-average-half-life = 12s
    }
}

# Cluster metrics extension serializers and routers.
akka.actor {
    # Protobuf serializer for remote cluster metrics messages.
    serializers {
       akka-cluster-metrics = "akka.cluster.metrics.protobuf.MessageSerializer"
    }
    # Interface binding for remote cluster metrics messages.
    serialization-bindings {
       "akka.cluster.metrics.ClusterMetricsMessage" = akka-cluster-metrics
    }
    # Globally unique metrics extension serializer identifier.
    serialization-identifiers {
      "akka.cluster.metrics.protobuf.MessageSerializer" = 10
    }
    #  Provide routing of messages based on cluster metrics.
    router.type-mapping {
        cluster-metrics-adaptive-pool  = "akka.cluster.metrics.AdaptiveLoadBalancingPool"
        cluster-metrics-adaptive-group = "akka.cluster.metrics.AdaptiveLoadBalancingGroup"
    }
}
</pre>
</div>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
      <li><a href="http://akka.io/downloads">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@lightbend.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/akka_icon_reverse.svg" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2015 <a href="http://www.lightbend.com/">Lightbend Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Sep 30, 2016
    </p>
  </div>
</div>
<script type="text/javascript">
  var $toc = $('#toc');
  $toc.toc();

  // show clickable section sign when section header hovered:
  $('.section h2,.section h3,.section h4,.section h5').each(function(i, el) {
      var $el = $(el);
      $el.prepend($("<a class='section-marker' href='#" + $el.attr("id") + "'>&sect;</a>"))
  });
</script>

<!-- Algolia docs search -->
<script type="text/javascript">
  var version = DOCUMENTATION_OPTIONS.VERSION;

  var lang = "scala";
  var path = window.location.pathname;
  if (path.includes("/java/") || path.includes("java.html")) lang = "java";

  console.log("Search configured for:", lang, "@", version);

  docsearch({
    apiKey: '543bad5ad786495d9ccd445ed34ed082',
    indexName: 'akka_io',
    inputSelector: '#search',
    algoliaOptions: {
      hitsPerPage: 5,
      facetFilters: '[' + '["language:' + lang + '","language:general"]' + ',"version:' + version + '"]'
    }
  });

  // set up "/" as global shortcut for focusing on search
  $(document).keypress(function (event) {
    if (event.keyCode == 47) {
      $("#q").focus();
      return false; // swallow key event, otherwise the / char would be input into the search box
    }
  });
</script>

  

  </body>
</html>