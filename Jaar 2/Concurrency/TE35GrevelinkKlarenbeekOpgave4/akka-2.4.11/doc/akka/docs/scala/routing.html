


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Routing &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.4.11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <script type="text/javascript" src="../_static/warnOldDocs.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Actors" href="index-actors.html" />
    <link rel="next" title="FSM" href="fsm.html" />
    <link rel="prev" title="Mailboxes" href="mailboxes.html" />


  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img class="svg-logo" src="../_static/akka_full_color.svg" /></a>
        </div>
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
          <li><a href="http://akka.io/downloads">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>
          <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Routing</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">
              <li>
                 <span class="divider">|</span> <a href="fsm.html">FSM</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../java.html">Java Contents</a> <span class="divider">|</span> <a href="../scala.html">Scala Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="mailboxes.html">Mailboxes</a> <span class="divider">|</span>
              </li>
              <li style="float: left">
                Version 2.4.11
              </li>
              <li style="float: left">
                <input type="search" id="search" class="form-control" />
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="routing">
<span id="routing-scala"></span><h1>Routing</h1>
<p>Messages can be sent via a router to efficiently route them to destination actors, known as
its <em>routees</em>. A <tt class="docutils literal"><span class="pre">Router</span></tt> can be used inside or outside of an actor, and you can manage the
routees yourselves or use a self contained router actor with configuration capabilities.</p>
<p>Different routing strategies can be used, according to your application's needs. Akka comes with
several useful routing strategies right out of the box. But, as you will see in this chapter, it is
also possible to <a class="reference internal" href="#custom-router-scala"><em>create your own</em></a>.</p>
<div class="section" id="a-simple-router">
<span id="simple-router-scala"></span><h2>A Simple Router</h2>
<p>The following example illustrates how to use a <tt class="docutils literal"><span class="pre">Router</span></tt> and manage the routees from within an actor.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.routing.</span><span class="o">{</span> <span class="nc">ActorRefRoutee</span><span class="o">,</span> <span class="nc">RoundRobinRoutingLogic</span><span class="o">,</span> <span class="nc">Router</span> <span class="o">}</span>

<span class="k">class</span> <span class="nc">Master</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">router</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">routees</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">fill</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">r</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">])</span>
      <span class="n">context</span> <span class="n">watch</span> <span class="n">r</span>
      <span class="nc">ActorRefRoutee</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="nc">Router</span><span class="o">(</span><span class="nc">RoundRobinRoutingLogic</span><span class="o">(),</span> <span class="n">routees</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">w</span><span class="k">:</span> <span class="kt">Work</span> <span class="o">=&gt;</span>
      <span class="n">router</span><span class="o">.</span><span class="n">route</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">sender</span><span class="o">())</span>
    <span class="k">case</span> <span class="nc">Terminated</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">router</span> <span class="k">=</span> <span class="n">router</span><span class="o">.</span><span class="n">removeRoutee</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">r</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">])</span>
      <span class="n">context</span> <span class="n">watch</span> <span class="n">r</span>
      <span class="n">router</span> <span class="k">=</span> <span class="n">router</span><span class="o">.</span><span class="n">addRoutee</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We create a <tt class="docutils literal"><span class="pre">Router</span></tt> and specify that it should use <tt class="docutils literal"><span class="pre">RoundRobinRoutingLogic</span></tt> when routing the
messages to the routees.</p>
<p>The routing logic shipped with Akka are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">akka.routing.RoundRobinRoutingLogic</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.RandomRoutingLogic</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.SmallestMailboxRoutingLogic</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.BroadcastRoutingLogic</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.ScatterGatherFirstCompletedRoutingLogic</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.TailChoppingRoutingLogic</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.ConsistentHashingRoutingLogic</span></tt></li>
</ul>
<p>We create the routees as ordinary child actors wrapped in <tt class="docutils literal"><span class="pre">ActorRefRoutee</span></tt>. We watch
the routees to be able to replace them if they are terminated.</p>
<p>Sending messages via the router is done with the <tt class="docutils literal"><span class="pre">route</span></tt> method, as is done for the <tt class="docutils literal"><span class="pre">Work</span></tt> messages
in the example above.</p>
<p>The <tt class="docutils literal"><span class="pre">Router</span></tt> is immutable and the <tt class="docutils literal"><span class="pre">RoutingLogic</span></tt> is thread safe; meaning that they can also be used
outside of actors.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In general, any message sent to a router will be sent onwards to its routees, but there is one exception.
The special <a class="reference internal" href="#broadcast-messages-scala"><em>Broadcast Messages</em></a> will send to <em>all</em> of a router's routees.
However, do not use <a class="reference internal" href="#broadcast-messages-scala"><em>Broadcast Messages</em></a> when you use <a class="reference internal" href="#balancing-pool-scala"><em>BalancingPool</em></a> for routees
as described in <a class="reference internal" href="#router-special-messages-scala"><em>Specially Handled Messages</em></a>.</p>
</div>
</div>
<div class="section" id="a-router-actor">
<h2>A Router Actor</h2>
<p>A router can also be created as a self contained actor that manages the routees itself and
loads routing logic and other settings from configuration.</p>
<p>This type of router actor comes in two distinct flavors:</p>
<ul class="simple">
<li>Pool - The router creates routees as child actors and removes them from the router if they
terminate.</li>
<li>Group - The routee actors are created externally to the router and the router sends
messages to the specified path using actor selection, without watching for termination.</li>
</ul>
<p>The settings for a router actor can be defined in configuration or programmatically.
In order to make an actor to make use of an externally configurable router the <tt class="docutils literal"><span class="pre">FromConfig</span></tt> props wrapper must be used
to denote that the actor accepts routing settings from configuration.
This is in contrast with Remote Deployment where such marker props is not necessary.
If the props of an actor is NOT wrapped in FromConfig it will ignore the router section of the deployment configuration.</p>
<p>You send messages to the routees via the router actor in the same way as for ordinary actors,
i.e. via its <tt class="docutils literal"><span class="pre">ActorRef</span></tt>. The router actor forwards messages onto its routees without changing
the original sender. When a routee replies to a routed message, the reply will be sent to the
original sender, not to the router actor.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In general, any message sent to a router will be sent onwards to its routees, but there are a
few exceptions. These are documented in the <a class="reference internal" href="#router-special-messages-scala"><em>Specially Handled Messages</em></a> section below.</p>
</div>
<div class="section" id="pool">
<h3>Pool</h3>
<p>The following code and configuration snippets show how to create a <a class="reference internal" href="#round-robin-router-scala"><em>round-robin</em></a> router that forwards messages to five <tt class="docutils literal"><span class="pre">Worker</span></tt> routees. The
routees will be created as the router's children.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router1</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router1</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router1&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Here is the same example, but with the router configuration provided programmatically instead of
from configuration.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router2</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">RoundRobinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router2&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="section" id="remote-deployed-routees">
<h4>Remote Deployed Routees</h4>
<p>In addition to being able to create local actors as routees, you can instruct the router to
deploy its created children on a set of remote hosts. Routees will be deployed in round-robin
fashion. In order to deploy routees remotely, wrap the router configuration in a
<tt class="docutils literal"><span class="pre">RemoteRouterConfig</span></tt>, attaching the remote addresses of the nodes to deploy to. Remote
deployment requires the <tt class="docutils literal"><span class="pre">akka-remote</span></tt> module to be included in the classpath.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.</span><span class="o">{</span> <span class="nc">Address</span><span class="o">,</span> <span class="nc">AddressFromURIString</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">akka.remote.routing.RemoteRouterConfig</span>
<span class="k">val</span> <span class="n">addresses</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="nc">Address</span><span class="o">(</span><span class="s">&quot;akka.tcp&quot;</span><span class="o">,</span> <span class="s">&quot;remotesys&quot;</span><span class="o">,</span> <span class="s">&quot;otherhost&quot;</span><span class="o">,</span> <span class="mi">1234</span><span class="o">),</span>
  <span class="nc">AddressFromURIString</span><span class="o">(</span><span class="s">&quot;akka.tcp://othersys@anotherhost:1234&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">routerRemote</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">RemoteRouterConfig</span><span class="o">(</span><span class="nc">RoundRobinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">addresses</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Echo</span><span class="o">]))</span>
</pre></div>
</div>
</div>
<div class="section" id="senders">
<h4>Senders</h4>
<p>By default, when a routee sends a message, it will <a class="reference internal" href="actors.html#actors-tell-sender-scala"><em>implicitly set itself as the sender</em></a>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">x</span> <span class="c1">// replies will go to this actor</span>
</pre></div>
</div>
<p>However, it is often useful for routees to set the <em>router</em> as a sender. For example, you might want
to set the router as the sender if you want to hide the details of the routees behind the router.
The following code snippet shows how to set the parent router as sender.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">sender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;reply&quot;</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="n">parent</span><span class="o">)</span> <span class="c1">// replies will go back to parent</span>
<span class="n">sender</span><span class="o">().!(</span><span class="s">&quot;reply&quot;</span><span class="o">)(</span><span class="n">context</span><span class="o">.</span><span class="n">parent</span><span class="o">)</span> <span class="c1">// alternative syntax (beware of the parens!)</span>
</pre></div>
</div>
</div>
<div class="section" id="supervision">
<h4>Supervision</h4>
<p>Routees that are created by a pool router will be created as the router's children. The router is
therefore also the children's supervisor.</p>
<p>The supervision strategy of the router actor can be configured with the
<tt class="docutils literal"><span class="pre">supervisorStrategy</span></tt> property of the Pool. If no configuration is provided, routers default
to a strategy of “always escalate”. This means that errors are passed up to the router's supervisor
for handling. The router's supervisor will decide what to do about any errors.</p>
<p>Note the router's supervisor will treat the error as an error with the router itself. Therefore a
directive to stop or restart will cause the router <em>itself</em> to stop or restart. The router, in
turn, will cause its children to stop and restart.</p>
<p>It should be mentioned that the router's restart behavior has been overridden so that a restart,
while still re-creating the children, will still preserve the same number of actors in the pool.</p>
<p>This means that if you have not specified <tt class="xref py py-meth docutils literal"><span class="pre">supervisorStrategy</span></tt> of the router or its parent a
failure in a routee will escalate to the parent of the router, which will by default restart the router,
which will restart all routees (it uses Escalate and does not stop routees during restart). The reason
is to make the default behave such that adding <tt class="xref py py-meth docutils literal"><span class="pre">withRouter</span></tt> to a child’s definition does not
change the supervision strategy applied to the child. This might be an inefficiency that you can avoid
by specifying the strategy when defining the router.</p>
<p>Setting the strategy is easily done:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">escalator</span> <span class="k">=</span> <span class="nc">OneForOneStrategy</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">e</span> <span class="k">⇒</span> <span class="n">testActor</span> <span class="o">!</span> <span class="n">e</span><span class="o">;</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="nc">Escalate</span>
<span class="o">}</span>
<span class="k">val</span> <span class="n">router</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">RoundRobinPool</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">supervisorStrategy</span> <span class="k">=</span> <span class="n">escalator</span><span class="o">).</span><span class="n">props</span><span class="o">(</span>
  <span class="n">routeeProps</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">TestActor</span><span class="o">]))</span>
</pre></div>
</div>
<div class="admonition note" id="note-router-terminated-children-scala">
<p class="first admonition-title">Note</p>
<p class="last">If the child of a pool router terminates, the pool router will not automatically spawn
a new child. In the event that all children of a pool router have terminated the
router will terminate itself unless it is a dynamic router, e.g. using
a resizer.</p>
</div>
</div>
</div>
<div class="section" id="group">
<h3>Group</h3>
<p>Sometimes, rather than having the router actor create its routees, it is desirable to create routees
separately and provide them to the router for its use. You can do this by passing an
paths of the routees to the router's configuration. Messages will be sent with <tt class="docutils literal"><span class="pre">ActorSelection</span></tt>
to these paths.</p>
<p>The example below shows how to create a router by providing it with the path strings of three
routee actors.</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/router3 {
    router = round-robin-group
    routees.paths = ["/user/workers/w1", "/user/workers/w2", "/user/workers/w3"]
  }
}
</pre>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router3</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router3&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Here is the same example, but with the router configuration provided programmatically instead of
from configuration.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router4</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">RoundRobinGroup</span><span class="o">(</span><span class="n">paths</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router4&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>The routee actors are created externally from the router:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Workers</span><span class="o">],</span> <span class="s">&quot;workers&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Workers</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">],</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;w1&quot;</span><span class="o">)</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">],</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;w2&quot;</span><span class="o">)</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">],</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;w3&quot;</span><span class="o">)</span>
  <span class="c1">// ...</span>
</pre></div>
</div>
<p>The paths may contain protocol and address information for actors running on remote hosts.
Remoting requires the <tt class="docutils literal"><span class="pre">akka-remote</span></tt> module to be included in the classpath.</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/remoteGroup {
    router = round-robin-group
    routees.paths = [
      "akka.tcp://app@10.0.0.1:2552/user/workers/w1",
      "akka.tcp://app@10.0.0.2:2552/user/workers/w1",
      "akka.tcp://app@10.0.0.3:2552/user/workers/w1"]
  }
}
</pre>
</div>
</div>
</div>
<div class="section" id="router-usage">
<h2>Router usage</h2>
<p>In this section we will describe how to create the different types of router actors.</p>
<p>The router actors in this section are created from within a top level actor named <tt class="docutils literal"><span class="pre">parent</span></tt>.
Note that deployment paths in the configuration starts with <tt class="docutils literal"><span class="pre">/parent/</span></tt> followed by the name
of the router actor.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Parent</span><span class="o">],</span> <span class="s">&quot;parent&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="section" id="roundrobinpool-and-roundrobingroup">
<span id="round-robin-router-scala"></span><h3>RoundRobinPool and RoundRobinGroup</h3>
<p>Routes in a <a class="reference external" href="http://en.wikipedia.org/wiki/Round-robin">round-robin</a> fashion to its routees.</p>
<p>RoundRobinPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router1</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router1</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router1&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>RoundRobinPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router2</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">RoundRobinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router2&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>RoundRobinGroup defined in configuration:</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/router3 {
    router = round-robin-group
    routees.paths = ["/user/workers/w1", "/user/workers/w2", "/user/workers/w3"]
  }
}
</pre>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router3</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router3&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>RoundRobinGroup defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">paths</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;/user/workers/w1&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w2&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w3&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">router4</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">RoundRobinGroup</span><span class="o">(</span><span class="n">paths</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router4&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="randompool-and-randomgroup">
<h3>RandomPool and RandomGroup</h3>
<p>This router type selects one of its routees randomly for each message.</p>
<p>RandomPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router5</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">random</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router5</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router5&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>RandomPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router6</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">RandomPool</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router6&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>RandomGroup defined in configuration:</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/router7 {
    router = random-group
    routees.paths = ["/user/workers/w1", "/user/workers/w2", "/user/workers/w3"]
  }
}
</pre>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router7</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router7&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>RandomGroup defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">paths</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;/user/workers/w1&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w2&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w3&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">router8</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">RandomGroup</span><span class="o">(</span><span class="n">paths</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router8&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="balancingpool">
<span id="balancing-pool-scala"></span><h3>BalancingPool</h3>
<p>A Router that will try to redistribute work from busy routees to idle routees.
All routees share the same mailbox.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The BalancingPool has the property that its routees do not have truly distinct
identity: they have different names, but talking to them will not end up at the
right actor in most cases. Therefore you cannot use it for workflows that
require state to be kept within the routee, you would in this case have to
include the whole state in the messages.</p>
<p class="last">With a <a class="reference internal" href="#smallestmailboxpool">SmallestMailboxPool</a> you can have a vertically scaling service that
can interact in a stateful fashion with other services in the back-end before
replying to the original client. The other advantage is that it does not place
a restriction on the message queue implementation as BalancingPool does.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Do not use <a class="reference internal" href="#broadcast-messages-scala"><em>Broadcast Messages</em></a> when you use <a class="reference internal" href="#balancing-pool-scala"><em>BalancingPool</em></a> for routers.
as described in <a class="reference internal" href="#router-special-messages-scala"><em>Specially Handled Messages</em></a>,</p>
</div>
<p>BalancingPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router9</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">balancing</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router9</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router9&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>BalancingPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router10</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">BalancingPool</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router10&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Addition configuration for the balancing dispatcher, which is used by the pool,
can be configured in the <tt class="docutils literal"><span class="pre">pool-dispatcher</span></tt> section of the router deployment
configuration.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router9b</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">balancing</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">pool</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
      <span class="n">attempt</span><span class="o">-</span><span class="n">teamwork</span> <span class="k">=</span> <span class="n">off</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">BalancingPool</span></tt> automatically uses a special <tt class="docutils literal"><span class="pre">BalancingDispatcher</span></tt> for its
routees - disregarding any dispatcher that is set on the routee Props object.
This is needed in order to implement the balancing semantics via
sharing the same mailbox by all the routees.</p>
<p>While it is not possible to change the dispatcher used by the routees, it is possible
to fine tune the used <em>executor</em>. By default the <tt class="docutils literal"><span class="pre">fork-join-dispatcher</span></tt> is used and
can be configured as explained in <a class="reference internal" href="dispatchers.html#dispatchers-scala"><em>Dispatchers</em></a>. In situations where the
routees are expected to perform blocking operations it may be useful to replace it
with a <tt class="docutils literal"><span class="pre">thread-pool-executor</span></tt> hinting the number of allocated threads explicitly:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router10b</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">balancing</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">pool</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
      <span class="n">executor</span> <span class="k">=</span> <span class="s">&quot;thread-pool-executor&quot;</span>

      <span class="k">#</span> <span class="n">allocate</span> <span class="n">exactly</span> <span class="mi">5</span> <span class="n">threads</span> <span class="k">for</span> <span class="k">this</span> <span class="n">pool</span>
      <span class="n">thread</span><span class="o">-</span><span class="n">pool</span><span class="o">-</span><span class="n">executor</span> <span class="o">{</span>
        <span class="n">core</span><span class="o">-</span><span class="n">pool</span><span class="o">-</span><span class="n">size</span><span class="o">-</span><span class="n">min</span> <span class="k">=</span> <span class="mi">5</span>
        <span class="n">core</span><span class="o">-</span><span class="n">pool</span><span class="o">-</span><span class="n">size</span><span class="o">-</span><span class="n">max</span> <span class="k">=</span> <span class="mi">5</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>It is also possible to change the <tt class="docutils literal"><span class="pre">mailbox</span></tt> used by the balancing dispatcher for
scenarios where the default unbounded mailbox is not well suited. An example of such
a scenario could arise whether there exists the need to manage priority for each message.
You can then implement a priority mailbox and configure your dispatcher:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router10c</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">balancing</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">pool</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
      <span class="n">mailbox</span> <span class="k">=</span> <span class="n">myapp</span><span class="o">.</span><span class="n">myprioritymailbox</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Bear in mind that <tt class="docutils literal"><span class="pre">BalancingDispatcher</span></tt> requires a message queue that must be thread-safe for
multiple concurrent consumers. So it is mandatory for the message queue backing a custom mailbox
for this kind of dispatcher to implement akka.dispatch.MultipleConsumerSemantics. See details
on how to implement your custom mailbox in <a class="reference internal" href="mailboxes.html#mailboxes-scala"><em>Mailboxes</em></a>.</p>
</div>
<p>There is no Group variant of the BalancingPool.</p>
</div>
<div class="section" id="smallestmailboxpool">
<h3>SmallestMailboxPool</h3>
<p>A Router that tries to send to the non-suspended child routee with fewest messages in mailbox.
The selection is done in this order:</p>
<blockquote>
<div><ul class="simple">
<li>pick any idle routee (not processing message) with empty mailbox</li>
<li>pick any routee with empty mailbox</li>
<li>pick routee with fewest pending messages in mailbox</li>
<li>pick any remote routee, remote actors are consider lowest priority,
since their mailbox size is unknown</li>
</ul>
</div></blockquote>
<p>SmallestMailboxPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router11</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">smallest</span><span class="o">-</span><span class="n">mailbox</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router11</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router11&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>SmallestMailboxPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router12</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">SmallestMailboxPool</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router12&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>There is no Group variant of the SmallestMailboxPool because the size of the mailbox
and the internal dispatching state of the actor is not practically available from the paths
of the routees.</p>
</div>
<div class="section" id="broadcastpool-and-broadcastgroup">
<h3>BroadcastPool and BroadcastGroup</h3>
<p>A broadcast router forwards the message it receives to <em>all</em> its routees.</p>
<p>BroadcastPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router13</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">broadcast</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router13</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router13&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>BroadcastPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router14</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">BroadcastPool</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router14&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>BroadcastGroup defined in configuration:</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/router15 {
    router = broadcast-group
    routees.paths = ["/user/workers/w1", "/user/workers/w2", "/user/workers/w3"]
  }
}
</pre>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router15</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router15&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>BroadcastGroup defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">paths</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;/user/workers/w1&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w2&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w3&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">router16</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">BroadcastGroup</span><span class="o">(</span><span class="n">paths</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router16&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Broadcast routers always broadcast <em>every</em> message to their routees. If you do not want to
broadcast every message, then you can use a non-broadcasting router and use
<a class="reference internal" href="#broadcast-messages-scala"><em>Broadcast Messages</em></a> as needed.</p>
</div>
</div>
<div class="section" id="scattergatherfirstcompletedpool-and-scattergatherfirstcompletedgroup">
<h3>ScatterGatherFirstCompletedPool and ScatterGatherFirstCompletedGroup</h3>
<p>The ScatterGatherFirstCompletedRouter will send the message on to all its routees.
It then waits for first reply it gets back. This result will be sent back to original sender.
Other replies are discarded.</p>
<p>It is expecting at least one reply within a configured duration, otherwise it will reply with
<tt class="docutils literal"><span class="pre">akka.pattern.AskTimeoutException</span></tt> in a <tt class="docutils literal"><span class="pre">akka.actor.Status.Failure</span></tt>.</p>
<p>ScatterGatherFirstCompletedPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router17</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">scatter</span><span class="o">-</span><span class="n">gather</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">within</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router17</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router17&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>ScatterGatherFirstCompletedPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router18</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">ScatterGatherFirstCompletedPool</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">within</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">).</span>
    <span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router18&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>ScatterGatherFirstCompletedGroup defined in configuration:</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/router19 {
    router = scatter-gather-group
    routees.paths = ["/user/workers/w1", "/user/workers/w2", "/user/workers/w3"]
    within = 10 seconds
  }
}
</pre>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router19</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router19&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>ScatterGatherFirstCompletedGroup defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">paths</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;/user/workers/w1&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w2&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w3&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">router20</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">ScatterGatherFirstCompletedGroup</span><span class="o">(</span>
    <span class="n">paths</span><span class="o">,</span>
    <span class="n">within</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router20&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="tailchoppingpool-and-tailchoppinggroup">
<h3>TailChoppingPool and TailChoppingGroup</h3>
<p>The TailChoppingRouter will first send the message to one, randomly picked, routee
and then after a small delay to a second routee (picked randomly from the remaining routees) and so on.
It waits for first reply it gets back and forwards it back to original sender. Other replies are discarded.</p>
<p>The goal of this router is to decrease latency by performing redundant queries to multiple routees, assuming that
one of the other actors may still be faster to respond than the initial one.</p>
<p>This optimisation was described nicely in a blog post by Peter Bailis:
<a class="reference external" href="http://www.bailis.org/blog/doing-redundant-work-to-speed-up-distributed-queries/">Doing redundant work to speed up distributed queries</a>.</p>
<p>TailChoppingPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router21</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">tail</span><span class="o">-</span><span class="n">chopping</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">within</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span>
    <span class="n">tail</span><span class="o">-</span><span class="n">chopping</span><span class="o">-</span><span class="n">router</span><span class="o">.</span><span class="n">interval</span> <span class="k">=</span> <span class="mi">20</span> <span class="n">milliseconds</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router21</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router21&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>TailChoppingPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router22</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">TailChoppingPool</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">within</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">,</span> <span class="n">interval</span> <span class="k">=</span> <span class="mf">20.</span><span class="n">millis</span><span class="o">).</span>
    <span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router22&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>TailChoppingGroup defined in configuration:</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/router23 {
    router = tail-chopping-group
    routees.paths = ["/user/workers/w1", "/user/workers/w2", "/user/workers/w3"]
    within = 10 seconds
    tail-chopping-router.interval = 20 milliseconds
  }
}
</pre>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router23</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router23&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>TailChoppingGroup defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">paths</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;/user/workers/w1&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w2&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w3&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">router24</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">TailChoppingGroup</span><span class="o">(</span>
    <span class="n">paths</span><span class="o">,</span>
    <span class="n">within</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">,</span> <span class="n">interval</span> <span class="k">=</span> <span class="mf">20.</span><span class="n">millis</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router24&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="consistenthashingpool-and-consistenthashinggroup">
<h3>ConsistentHashingPool and ConsistentHashingGroup</h3>
<p>The ConsistentHashingPool uses <a class="reference external" href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>
to select a routee based on the sent message. This
<a class="reference external" href="http://weblogs.java.net/blog/tomwhite/archive/2007/11/consistent_hash.html">article</a> gives good
insight into how consistent hashing is implemented.</p>
<p>There is 3 ways to define what data to use for the consistent hash key.</p>
<ul class="simple">
<li>You can define <tt class="docutils literal"><span class="pre">hashMapping</span></tt> of the router to map incoming
messages to their consistent hash key. This makes the decision
transparent for the sender.</li>
<li>The messages may implement <tt class="docutils literal"><span class="pre">akka.routing.ConsistentHashingRouter.ConsistentHashable</span></tt>.
The key is part of the message and it's convenient to define it together
with the message definition.</li>
<li>The messages can be wrapped in a <tt class="docutils literal"><span class="pre">akka.routing.ConsistentHashingRouter.ConsistentHashableEnvelope</span></tt>
to define what data to use for the consistent hash key. The sender knows
the key to use.</li>
</ul>
<p>These ways to define the consistent hash key can be use together and at
the same time for one router. The <tt class="docutils literal"><span class="pre">hashMapping</span></tt> is tried first.</p>
<p>Code example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.Actor</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingRouter.ConsistentHashable</span>

<span class="k">class</span> <span class="nc">Cache</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">cache</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Entry</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">cache</span> <span class="o">+=</span> <span class="o">(</span><span class="n">key</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Get</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>          <span class="k">=&gt;</span> <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Evict</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>        <span class="k">=&gt;</span> <span class="n">cache</span> <span class="o">-=</span> <span class="n">key</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Evict</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Get</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ConsistentHashable</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">consistentHashKey</span><span class="k">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="n">key</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Entry</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.Props</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingPool</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingRouter.ConsistentHashMapping</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingRouter.ConsistentHashableEnvelope</span>

<span class="k">def</span> <span class="n">hashMapping</span><span class="k">:</span> <span class="kt">ConsistentHashMapping</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Evict</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">key</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">cache</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">ConsistentHashingPool</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">hashMapping</span> <span class="k">=</span> <span class="n">hashMapping</span><span class="o">).</span>
    <span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Cache</span><span class="o">]),</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;cache&quot;</span><span class="o">)</span>

<span class="n">cache</span> <span class="o">!</span> <span class="nc">ConsistentHashableEnvelope</span><span class="o">(</span>
  <span class="n">message</span> <span class="k">=</span> <span class="nc">Entry</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="s">&quot;HELLO&quot;</span><span class="o">),</span> <span class="n">hashKey</span> <span class="k">=</span> <span class="s">&quot;hello&quot;</span><span class="o">)</span>
<span class="n">cache</span> <span class="o">!</span> <span class="nc">ConsistentHashableEnvelope</span><span class="o">(</span>
  <span class="n">message</span> <span class="k">=</span> <span class="nc">Entry</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">,</span> <span class="s">&quot;HI&quot;</span><span class="o">),</span> <span class="n">hashKey</span> <span class="k">=</span> <span class="s">&quot;hi&quot;</span><span class="o">)</span>

<span class="n">cache</span> <span class="o">!</span> <span class="nc">Get</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="s">&quot;HELLO&quot;</span><span class="o">))</span>

<span class="n">cache</span> <span class="o">!</span> <span class="nc">Get</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">)</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="s">&quot;HI&quot;</span><span class="o">))</span>

<span class="n">cache</span> <span class="o">!</span> <span class="nc">Evict</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">)</span>
<span class="n">cache</span> <span class="o">!</span> <span class="nc">Get</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">)</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span>
</pre></div>
</div>
<p>In the above example you see that the <tt class="docutils literal"><span class="pre">Get</span></tt> message implements <tt class="docutils literal"><span class="pre">ConsistentHashable</span></tt> itself,
while the <tt class="docutils literal"><span class="pre">Entry</span></tt> message is wrapped in a <tt class="docutils literal"><span class="pre">ConsistentHashableEnvelope</span></tt>. The <tt class="docutils literal"><span class="pre">Evict</span></tt>
message is handled by the <tt class="docutils literal"><span class="pre">hashMapping</span></tt> partial function.</p>
<p>ConsistentHashingPool defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router25</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">consistent</span><span class="o">-</span><span class="n">hashing</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">virtual</span><span class="o">-</span><span class="n">nodes</span><span class="o">-</span><span class="n">factor</span> <span class="k">=</span> <span class="mi">10</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router25</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router25&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>ConsistentHashingPool defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router26</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="nc">ConsistentHashingPool</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span>
    <span class="s">&quot;router26&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>ConsistentHashingGroup defined in configuration:</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /parent/router27 {
    router = consistent-hashing-group
    routees.paths = ["/user/workers/w1", "/user/workers/w2", "/user/workers/w3"]
    virtual-nodes-factor = 10
  }
}
</pre>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router27</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router27&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>ConsistentHashingGroup defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">paths</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;/user/workers/w1&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w2&quot;</span><span class="o">,</span> <span class="s">&quot;/user/workers/w3&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">router28</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">ConsistentHashingGroup</span><span class="o">(</span><span class="n">paths</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span> <span class="s">&quot;router28&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">virtual-nodes-factor</span></tt> is the number of virtual nodes per routee that is used in the
consistent hash node ring to make the distribution more uniform.</p>
</div>
</div>
<div class="section" id="specially-handled-messages">
<span id="router-special-messages-scala"></span><h2>Specially Handled Messages</h2>
<p>Most messages sent to router actors will be forwarded according to the routers' routing logic.
However there are a few types of messages that have special behavior.</p>
<p>Note that these special messages, except for the <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message, are only handled by
self contained router actors and not by the <tt class="docutils literal"><span class="pre">akka.routing.Router</span></tt> component described
in <a class="reference internal" href="#simple-router-scala"><em>A Simple Router</em></a>.</p>
<div class="section" id="broadcast-messages">
<span id="broadcast-messages-scala"></span><h3>Broadcast Messages</h3>
<p>A <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message can be used to send a message to <em>all</em> of a router's routees. When a router
receives a <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message, it will broadcast that message's <em>payload</em> to all routees, no
matter how that router would normally route its messages.</p>
<p>The example below shows how you would use a <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message to send a very important message
to every routee of a router.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.routing.Broadcast</span>
<span class="n">router</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="s">&quot;Watch out for Davy Jones&#39; locker&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>In this example the router receives the <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message, extracts its payload
(<tt class="docutils literal"><span class="pre">&quot;Watch&nbsp;out&nbsp;for&nbsp;Davy&nbsp;Jones'&nbsp;locker&quot;</span></tt>), and then sends the payload on to all of the router's
routees. It is up to each routee actor to handle the received payload message.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Do not use <a class="reference internal" href="#broadcast-messages-scala"><em>Broadcast Messages</em></a> when you use <a class="reference internal" href="#balancing-pool-scala"><em>BalancingPool</em></a> for routers.
Routees on <a class="reference internal" href="#balancing-pool-scala"><em>BalancingPool</em></a> shares the same mailbox instance, thus some routees can
possibly get the broadcast message multiple times, while other routees get no broadcast message.</p>
</div>
</div>
<div class="section" id="poisonpill-messages">
<h3>PoisonPill Messages</h3>
<p>A <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message has special handling for all actors, including for routers. When any actor
receives a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message, that actor will be stopped. See the <a class="reference internal" href="actors.html#poison-pill-scala"><em>PoisonPill</em></a>
documentation for details.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.PoisonPill</span>
<span class="n">router</span> <span class="o">!</span> <span class="nc">PoisonPill</span>
</pre></div>
</div>
<p>For a router, which normally passes on messages to routees, it is important to realise that
<tt class="docutils literal"><span class="pre">PoisonPill</span></tt> messages are processed by the router only. <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> messages sent to a router
will <em>not</em> be sent on to routees.</p>
<p>However, a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message sent to a router may still affect its routees, because it will
stop the router and when the router stops it also stops its children. Stopping children is normal
actor behavior. The router will stop routees that it has created as children. Each child will
process its current message and then stop. This may lead to some messages being unprocessed.
See the documentation on <a class="reference internal" href="actors.html#stopping-actors-scala"><em>Stopping actors</em></a> for more information.</p>
<p>If you wish to stop a router and its routees, but you would like the routees to first process all
the messages currently in their mailboxes, then you should not send a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message to the
router. Instead you should wrap a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message inside a <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message so that each
routee will receive the <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message. Note that this will stop all routees, even if the
routees aren't children of the router, i.e. even routees programmatically provided to the router.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.PoisonPill</span>
<span class="k">import</span> <span class="nn">akka.routing.Broadcast</span>
<span class="n">router</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">)</span>
</pre></div>
</div>
<p>With the code shown above, each routee will receive a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message. Each routee will
continue to process its messages as normal, eventually processing the <tt class="docutils literal"><span class="pre">PoisonPill</span></tt>. This will
cause the routee to stop. After all routees have stopped the router will itself be <a class="reference internal" href="#note-router-terminated-children-scala"><em>stopped
automatically</em></a> unless it is a dynamic router, e.g. using
a resizer.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Brendan W McAdams' excellent blog post <a class="reference external" href="http://bytes.codes/2013/01/17/Distributing_Akka_Workloads_And_Shutting_Down_After/">Distributing Akka Workloads - And Shutting Down Afterwards</a>
discusses in more detail how <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> messages can be used to shut down routers and routees.</p>
</div>
</div>
<div class="section" id="kill-messages">
<h3>Kill Messages</h3>
<p><tt class="docutils literal"><span class="pre">Kill</span></tt> messages are another type of message that has special handling. See
<a class="reference internal" href="actors.html#killing-actors-scala"><em>Killing an Actor</em></a> for general information about how actors handle <tt class="docutils literal"><span class="pre">Kill</span></tt> messages.</p>
<p>When a <tt class="docutils literal"><span class="pre">Kill</span></tt> message is sent to a router the router processes the message internally, and does
<em>not</em> send it on to its routees. The router will throw an <tt class="docutils literal"><span class="pre">ActorKilledException</span></tt> and fail. It
will then be either resumed, restarted or terminated, depending how it is supervised.</p>
<p>Routees that are children of the router will also be suspended, and will be affected by the
supervision directive that is applied to the router. Routees that are not the routers children, i.e.
those that were created externally to the router, will not be affected.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.Kill</span>
<span class="n">router</span> <span class="o">!</span> <span class="nc">Kill</span>
</pre></div>
</div>
<p>As with the <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message, there is a distinction between killing a router, which
indirectly kills its children (who happen to be routees), and killing routees directly (some of whom
may not be children.) To kill routees directly the router should be sent a <tt class="docutils literal"><span class="pre">Kill</span></tt> message wrapped
in a <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.Kill</span>
<span class="k">import</span> <span class="nn">akka.routing.Broadcast</span>
<span class="n">router</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">Kill</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="management-messages">
<h3>Management Messages</h3>
<ul class="simple">
<li>Sending <tt class="docutils literal"><span class="pre">akka.routing.GetRoutees</span></tt> to a router actor will make it send back its currently used routees
in a <tt class="docutils literal"><span class="pre">akka.routing.Routees</span></tt> message.</li>
<li>Sending <tt class="docutils literal"><span class="pre">akka.routing.AddRoutee</span></tt> to a router actor will add that routee to its collection of routees.</li>
<li>Sending <tt class="docutils literal"><span class="pre">akka.routing.RemoveRoutee</span></tt> to a router actor will remove that routee to its collection of routees.</li>
<li>Sending <tt class="docutils literal"><span class="pre">akka.routing.AdjustPoolSize</span></tt> to a pool router actor will add or remove that number of routees to
its collection of routees.</li>
</ul>
<p>These management messages may be handled after other messages, so if you send <tt class="docutils literal"><span class="pre">AddRoutee</span></tt> immediately followed by
an ordinary message you are not guaranteed that the routees have been changed when the ordinary message
is routed. If you need to know when the change has been applied you can send <tt class="docutils literal"><span class="pre">AddRoutee</span></tt> followed by <tt class="docutils literal"><span class="pre">GetRoutees</span></tt>
and when you receive the <tt class="docutils literal"><span class="pre">Routees</span></tt> reply you know that the preceding change has been applied.</p>
</div>
</div>
<div class="section" id="dynamically-resizable-pool">
<span id="resizable-routers-scala"></span><h2>Dynamically Resizable Pool</h2>
<p>Most pools can be used with a fixed number of routees or with a resize strategy to adjust the number
of routees dynamically.</p>
<p>There are two types of resizers: the default <tt class="docutils literal"><span class="pre">Resizer</span></tt> and the <tt class="docutils literal"><span class="pre">OptimalSizeExploringResizer</span></tt>.</p>
<div class="section" id="default-resizer">
<h3>Default Resizer</h3>
<p>The default resizer ramps up and down pool size based on pressure, measured by the percentage of busy routees
in the pool. It ramps up pool size if the pressure is higher than a certain threshold and backs off if the
pressure is lower than certain threshold. Both thresholds are configurable.</p>
<p>Pool with default resizer defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router29</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">resizer</span> <span class="o">{</span>
      <span class="n">lower</span><span class="o">-</span><span class="n">bound</span> <span class="k">=</span> <span class="mi">2</span>
      <span class="n">upper</span><span class="o">-</span><span class="n">bound</span> <span class="k">=</span> <span class="mi">15</span>
      <span class="n">messages</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">resize</span> <span class="k">=</span> <span class="mi">100</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router29</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router29&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Several more configuration options are available and described in <tt class="docutils literal"><span class="pre">akka.actor.deployment.default.resizer</span></tt>
section of the reference <a class="reference internal" href="../general/configuration.html#configuration"><em>Configuration</em></a>.</p>
<p>Pool with resizer defined in code:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">resizer</span> <span class="k">=</span> <span class="nc">DefaultResizer</span><span class="o">(</span><span class="n">lowerBound</span> <span class="k">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">upperBound</span> <span class="k">=</span> <span class="mi">15</span><span class="o">)</span>
<span class="k">val</span> <span class="n">router30</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="nc">RoundRobinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="n">resizer</span><span class="o">)).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span>
    <span class="s">&quot;router30&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p><em>It is also worth pointing out that if you define the ``router`` in the configuration file then this value
will be used instead of any programmatically sent parameters.</em></p>
</div>
<div class="section" id="optimal-size-exploring-resizer">
<h3>Optimal Size Exploring Resizer</h3>
<p>The <tt class="docutils literal"><span class="pre">OptimalSizeExploringResizer</span></tt> resizes the pool to an optimal size that provides the most message throughput.</p>
<p>This resizer works best when you expect the pool size to performance function to be a convex function.
For example, when you have a CPU bound tasks, the optimal size is bound to the number of CPU cores.
When your task is IO bound, the optimal size is bound to optimal number of concurrent connections to that IO service -
e.g. a 4 node elastic search cluster may handle 4-8 concurrent requests at optimal speed.</p>
<p>It achieves this by keeping track of message throughput at each pool size and performing the following
three resizing operations (one at a time) periodically:</p>
<ul class="simple">
<li>Downsize if it hasn't seen all routees ever fully utilized for a period of time.</li>
<li>Explore to a random nearby pool size to try and collect throughput metrics.</li>
<li>Optimize to a nearby pool size with a better (than any other nearby sizes) throughput metrics.</li>
</ul>
<p>When the pool is fully-utilized (i.e. all routees are busy), it randomly choose between exploring and optimizing.
When the pool has not been fully-utilized for a period of time, it will downsize the pool to the last seen max
utilization multiplied by a configurable ratio.</p>
<p>By constantly exploring and optimizing, the resizer will eventually walk to the optimal size and
remain nearby. When the optimal size changes it will start walking towards the new one.</p>
<p>It keeps a performance log so it's stateful as well as having a larger memory footprint than the default <tt class="docutils literal"><span class="pre">Resizer</span></tt>.
The memory usage is O(n) where n is the number of sizes you allow, i.e. upperBound - lowerBound.</p>
<p>Pool with <tt class="docutils literal"><span class="pre">OptimalSizeExploringResizer</span></tt> defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">router31</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">optimal</span><span class="o">-</span><span class="n">size</span><span class="o">-</span><span class="n">exploring</span><span class="o">-</span><span class="n">resizer</span> <span class="o">{</span>
      <span class="n">enabled</span> <span class="k">=</span> <span class="n">on</span>
      <span class="n">action</span><span class="o">-</span><span class="n">interval</span> <span class="k">=</span> <span class="mi">5</span><span class="n">s</span>
      <span class="n">downsize</span><span class="o">-</span><span class="n">after</span><span class="o">-</span><span class="n">underutilized</span><span class="o">-</span><span class="k">for</span> <span class="k">=</span> <span class="mi">72</span><span class="n">h</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router31</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span> <span class="s">&quot;router31&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Several more configuration options are available and described in <tt class="docutils literal"><span class="pre">akka.actor.deployment.default.optimal-size-exploring-resizer</span></tt>
section of the reference <a class="reference internal" href="../general/configuration.html#configuration"><em>Configuration</em></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Resizing is triggered by sending messages to the actor pool, but it is not
completed synchronously; instead a message is sent to the “head”
<tt class="docutils literal"><span class="pre">RouterActor</span></tt> to perform the size change. Thus you cannot rely on resizing
to instantaneously create new workers when all others are busy, because the
message just sent will be queued to the mailbox of a busy actor. To remedy
this, configure the pool to use a balancing dispatcher, see <a class="reference internal" href="#configuring-dispatchers">Configuring
Dispatchers</a> for more information.</p>
</div>
</div>
</div>
<div class="section" id="how-routing-is-designed-within-akka">
<span id="router-design-scala"></span><h2>How Routing is Designed within Akka</h2>
<p>On the surface routers look like normal actors, but they are actually implemented differently.
Routers are designed to be extremely efficient at receiving messages and passing them quickly on to
routees.</p>
<p>A normal actor can be used for routing messages, but an actor's single-threaded processing can
become a bottleneck. Routers can achieve much higher throughput with an optimization to the usual
message-processing pipeline that allows concurrent routing. This is achieved by embedding routers'
routing logic directly in their <tt class="docutils literal"><span class="pre">ActorRef</span></tt> rather than in the router actor. Messages sent to
a router's <tt class="docutils literal"><span class="pre">ActorRef</span></tt> can be immediately routed to the routee, bypassing the single-threaded
router actor entirely.</p>
<p>The cost to this is, of course, that the internals of routing code are more complicated than if
routers were implemented with normal actors. Fortunately all of this complexity is invisible to
consumers of the routing API. However, it is something to be aware of when implementing your own
routers.</p>
</div>
<div class="section" id="custom-router">
<span id="custom-router-scala"></span><h2>Custom Router</h2>
<p>You can create your own router should you not find any of the ones provided by Akka sufficient for your needs.
In order to roll your own router you have to fulfill certain criteria which are explained in this section.</p>
<p>Before creating your own router you should consider whether a normal actor with router-like
behavior might do the job just as well as a full-blown router. As explained
<a class="reference internal" href="#router-design-scala"><em>above</em></a>, the primary benefit of routers over normal actors is their
higher performance. But they are somewhat more complicated to write than normal actors. Therefore if
lower maximum throughput is acceptable in your application you may wish to stick with traditional
actors. This section, however, assumes that you wish to get maximum performance and so demonstrates
how you can create your own router.</p>
<p>The router created in this example is replicating each message to a few destinations.</p>
<p>Start with the routing logic:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">scala.collection.immutable</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.ThreadLocalRandom</span>
<span class="k">import</span> <span class="nn">akka.routing.RoundRobinRoutingLogic</span>
<span class="k">import</span> <span class="nn">akka.routing.RoutingLogic</span>
<span class="k">import</span> <span class="nn">akka.routing.Routee</span>
<span class="k">import</span> <span class="nn">akka.routing.SeveralRoutees</span>

<span class="k">class</span> <span class="nc">RedundancyRoutingLogic</span><span class="o">(</span><span class="n">nbrCopies</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">RoutingLogic</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">roundRobin</span> <span class="k">=</span> <span class="nc">RoundRobinRoutingLogic</span><span class="o">()</span>
  <span class="k">def</span> <span class="n">select</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">Any</span><span class="o">,</span> <span class="n">routees</span><span class="k">:</span> <span class="kt">immutable.IndexedSeq</span><span class="o">[</span><span class="kt">Routee</span><span class="o">])</span><span class="k">:</span> <span class="kt">Routee</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">targets</span> <span class="k">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">nbrCopies</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">roundRobin</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">routees</span><span class="o">))</span>
    <span class="nc">SeveralRoutees</span><span class="o">(</span><span class="n">targets</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">select</span></tt> will be called for each message and in this example pick a few destinations by round-robin,
by reusing the existing <tt class="docutils literal"><span class="pre">RoundRobinRoutingLogic</span></tt> and wrap the result in a <tt class="docutils literal"><span class="pre">SeveralRoutees</span></tt>
instance.  <tt class="docutils literal"><span class="pre">SeveralRoutees</span></tt> will send the message to all of the supplied routes.</p>
<p>The implementation of the routing logic must be thread safe, since it might be used outside of actors.</p>
<p>A unit test of the routing logic:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Routee</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">Any</span><span class="o">,</span> <span class="n">sender</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">()</span>
<span class="o">}</span>

  <span class="k">val</span> <span class="n">logic</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RedundancyRoutingLogic</span><span class="o">(</span><span class="n">nbrCopies</span> <span class="k">=</span> <span class="mi">3</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">routees</span> <span class="k">=</span> <span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">7</span><span class="o">)</span> <span class="k">yield</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">r1</span> <span class="k">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;msg&quot;</span><span class="o">,</span> <span class="n">routees</span><span class="o">)</span>
  <span class="n">r1</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">SeveralRoutees</span><span class="o">].</span><span class="n">routees</span> <span class="n">should</span> <span class="n">be</span><span class="o">(</span>
    <span class="nc">Vector</span><span class="o">(</span><span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">3</span><span class="o">)))</span>

  <span class="k">val</span> <span class="n">r2</span> <span class="k">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;msg&quot;</span><span class="o">,</span> <span class="n">routees</span><span class="o">)</span>
  <span class="n">r2</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">SeveralRoutees</span><span class="o">].</span><span class="n">routees</span> <span class="n">should</span> <span class="n">be</span><span class="o">(</span>
    <span class="nc">Vector</span><span class="o">(</span><span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">4</span><span class="o">),</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">6</span><span class="o">)))</span>

  <span class="k">val</span> <span class="n">r3</span> <span class="k">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;msg&quot;</span><span class="o">,</span> <span class="n">routees</span><span class="o">)</span>
  <span class="n">r3</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">SeveralRoutees</span><span class="o">].</span><span class="n">routees</span> <span class="n">should</span> <span class="n">be</span><span class="o">(</span>
    <span class="nc">Vector</span><span class="o">(</span><span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">7</span><span class="o">),</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="nc">TestRoutee</span><span class="o">(</span><span class="mi">2</span><span class="o">)))</span>
</pre></div>
</div>
<p>You could stop here and use the <tt class="docutils literal"><span class="pre">RedundancyRoutingLogic</span></tt> with a <tt class="docutils literal"><span class="pre">akka.routing.Router</span></tt>
as described in <a class="reference internal" href="#simple-router-scala"><em>A Simple Router</em></a>.</p>
<p>Let us continue and make this into a self contained, configurable, router actor.</p>
<p>Create a class that extends <tt class="docutils literal"><span class="pre">Pool</span></tt>, <tt class="docutils literal"><span class="pre">Group</span></tt> or <tt class="docutils literal"><span class="pre">CustomRouterConfig</span></tt>. That class is a factory
for the routing logic and holds the configuration for the router. Here we make it a <tt class="docutils literal"><span class="pre">Group</span></tt>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.dispatch.Dispatchers</span>
<span class="k">import</span> <span class="nn">akka.routing.Group</span>
<span class="k">import</span> <span class="nn">akka.routing.Router</span>
<span class="k">import</span> <span class="nn">akka.japi.Util.immutableSeq</span>
<span class="k">import</span> <span class="nn">com.typesafe.config.Config</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RedundancyGroup</span><span class="o">(</span><span class="n">routeePaths</span><span class="k">:</span> <span class="kt">immutable.Iterable</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">nbrCopies</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Group</span> <span class="o">{</span>

  <span class="k">def</span> <span class="k">this</span><span class="o">(</span><span class="n">config</span><span class="k">:</span> <span class="kt">Config</span><span class="o">)</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span>
    <span class="n">routeePaths</span> <span class="k">=</span> <span class="n">immutableSeq</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="n">getStringList</span><span class="o">(</span><span class="s">&quot;routees.paths&quot;</span><span class="o">)),</span>
    <span class="n">nbrCopies</span> <span class="k">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="s">&quot;nbr-copies&quot;</span><span class="o">))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">paths</span><span class="o">(</span><span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span><span class="o">)</span><span class="k">:</span> <span class="kt">immutable.Iterable</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">routeePaths</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">createRouter</span><span class="o">(</span><span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span><span class="o">)</span><span class="k">:</span> <span class="kt">Router</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">Router</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedundancyRoutingLogic</span><span class="o">(</span><span class="n">nbrCopies</span><span class="o">))</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">routerDispatcher</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="nc">Dispatchers</span><span class="o">.</span><span class="nc">DefaultDispatcherId</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This can be used exactly as the router actors provided by Akka.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">10</span><span class="o">)</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Storage</span><span class="o">],</span> <span class="s">&quot;s&quot;</span> <span class="o">+</span> <span class="n">n</span><span class="o">)</span>

<span class="k">val</span> <span class="n">paths</span> <span class="k">=</span> <span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">10</span><span class="o">)</span> <span class="k">yield</span> <span class="o">(</span><span class="s">&quot;/user/s&quot;</span> <span class="o">+</span> <span class="n">n</span><span class="o">)</span>
<span class="k">val</span> <span class="n">redundancy1</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
  <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="nc">RedundancyGroup</span><span class="o">(</span><span class="n">paths</span><span class="o">,</span> <span class="n">nbrCopies</span> <span class="k">=</span> <span class="mi">3</span><span class="o">).</span><span class="n">props</span><span class="o">(),</span>
    <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;redundancy1&quot;</span><span class="o">)</span>
<span class="n">redundancy1</span> <span class="o">!</span> <span class="s">&quot;important&quot;</span>
</pre></div>
</div>
<p>Note that we added a constructor in <tt class="docutils literal"><span class="pre">RedundancyGroup</span></tt> that takes a <tt class="docutils literal"><span class="pre">Config</span></tt> parameter.
That makes it possible to define it in configuration.</p>
<div class="highlight-scala"><pre>akka.actor.deployment {
  /redundancy2 {
    router = "docs.routing.RedundancyGroup"
    routees.paths = ["/user/s1", "/user/s2", "/user/s3"]
    nbr-copies = 5
  }
}
</pre>
</div>
<p>Note the fully qualified class name in the <tt class="docutils literal"><span class="pre">router</span></tt> property. The router class must extend
<tt class="docutils literal"><span class="pre">akka.routing.RouterConfig</span></tt> (<tt class="docutils literal"><span class="pre">Pool</span></tt>, <tt class="docutils literal"><span class="pre">Group</span></tt> or <tt class="docutils literal"><span class="pre">CustomRouterConfig</span></tt>) and have
constructor with one <tt class="docutils literal"><span class="pre">com.typesafe.config.Config</span></tt> parameter.
The deployment section of the configuration is passed to the constructor.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">redundancy2</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">FromConfig</span><span class="o">.</span><span class="n">props</span><span class="o">(),</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;redundancy2&quot;</span><span class="o">)</span>
<span class="n">redundancy2</span> <span class="o">!</span> <span class="s">&quot;very important&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-dispatchers">
<h2>Configuring Dispatchers</h2>
<p>The dispatcher for created children of the pool will be taken from
<tt class="docutils literal"><span class="pre">Props</span></tt> as described in <a class="reference internal" href="dispatchers.html#dispatchers-scala"><em>Dispatchers</em></a>.</p>
<p>To make it easy to define the dispatcher of the routees of the pool you can
define the dispatcher inline in the deployment section of the config.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">poolWithDispatcher</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">random</span><span class="o">-</span><span class="n">pool</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">pool</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
      <span class="n">fork</span><span class="o">-</span><span class="n">join</span><span class="o">-</span><span class="n">executor</span><span class="o">.</span><span class="n">parallelism</span><span class="o">-</span><span class="n">min</span> <span class="k">=</span> <span class="mi">5</span>
      <span class="n">fork</span><span class="o">-</span><span class="n">join</span><span class="o">-</span><span class="n">executor</span><span class="o">.</span><span class="n">parallelism</span><span class="o">-</span><span class="n">max</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>That is the only thing you need to do enable a dedicated dispatcher for a
pool.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you use a group of actors and route to their paths, then they will still use the same dispatcher
that was configured for them in their <tt class="docutils literal"><span class="pre">Props</span></tt>, it is not possible to change an actors dispatcher
after it has been created.</p>
</div>
<p>The “head” router cannot always run on the same dispatcher, because it
does not process the same type of messages, hence this special actor does
not use the dispatcher configured in <tt class="docutils literal"><span class="pre">Props</span></tt>, but takes the
<tt class="docutils literal"><span class="pre">routerDispatcher</span></tt> from the <tt class="xref py py-class docutils literal"><span class="pre">RouterConfig</span></tt> instead, which defaults to
the actor system’s default dispatcher. All standard routers allow setting this
property in their constructor or factory method, custom routers have to
implement the method in a suitable way.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">router</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="c1">// “head” router actor will run on &quot;router-dispatcher&quot; dispatcher</span>
  <span class="c1">// Worker routees will run on &quot;pool-dispatcher&quot; dispatcher</span>
  <span class="nc">RandomPool</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">routerDispatcher</span> <span class="k">=</span> <span class="s">&quot;router-dispatcher&quot;</span><span class="o">).</span><span class="n">props</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Worker</span><span class="o">]),</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;poolWithDispatcher&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is not allowed to configure the <tt class="docutils literal"><span class="pre">routerDispatcher</span></tt> to be a
<tt class="xref py py-class docutils literal"><span class="pre">akka.dispatch.BalancingDispatcherConfigurator</span></tt> since the messages meant
for the special router actor cannot be processed by any other actor.</p>
</div>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
      <li><a href="http://akka.io/downloads">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@lightbend.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/akka_icon_reverse.svg" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2015 <a href="http://www.lightbend.com/">Lightbend Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Sep 30, 2016
    </p>
  </div>
</div>
<script type="text/javascript">
  var $toc = $('#toc');
  $toc.toc();

  // show clickable section sign when section header hovered:
  $('.section h2,.section h3,.section h4,.section h5').each(function(i, el) {
      var $el = $(el);
      $el.prepend($("<a class='section-marker' href='#" + $el.attr("id") + "'>&sect;</a>"))
  });
</script>

<!-- Algolia docs search -->
<script type="text/javascript">
  var version = DOCUMENTATION_OPTIONS.VERSION;

  var lang = "scala";
  var path = window.location.pathname;
  if (path.includes("/java/") || path.includes("java.html")) lang = "java";

  console.log("Search configured for:", lang, "@", version);

  docsearch({
    apiKey: '543bad5ad786495d9ccd445ed34ed082',
    indexName: 'akka_io',
    inputSelector: '#search',
    algoliaOptions: {
      hitsPerPage: 5,
      facetFilters: '[' + '["language:' + lang + '","language:general"]' + ',"version:' + version + '"]'
    }
  });

  // set up "/" as global shortcut for focusing on search
  $(document).keypress(function (event) {
    if (event.keyCode == 47) {
      $("#q").focus();
      return false; // swallow key event, otherwise the / char would be input into the search box
    }
  });
</script>

  

  </body>
</html>